<!doctype html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <!-- 优先使用 IE 最新版本和 Chrome -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!-- 为移动设备添加 viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <!-- 添加到主屏后的标题（iOS 6 新增） -->
  <meta name="apple-mobile-web-app-title" content="WebGL学习(3) - 3D模型 - Jeff's world">
  <!-- 是否启用 WebApp 全屏模式，删除苹果默认的工具栏和菜单栏 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- 设置苹果工具栏颜色 -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <!-- 添加智能 App 广告条 Smart App Banner（iOS 6+ Safari） -->
  <!-- <meta name = "apple-itunes-app" content = "app-id=myAppStoreID, affiliate-data=myAffiliateData, app-argument=myURL"> -->
  <!-- 忽略页面中的数字识别为电话，忽略email识别 -->
  <meta name="format-detection" content="telphone=no, email=no">
  <!--下面三个是清除缓存 微信浏览器缓存严重又无刷新；这个方法调试的时候很方便-->
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <link rel="dns-prefetch" href="http://jeffzhong.space">
  <link rel="icon shortcut" type="image/ico" href="/favicon.ico">
  <meta name="author" content="Jeff Zhong">
  <meta name="description" content="it's a blog by hexo">
  <meta name="keywords" content="hexo theme">
  <title>WebGL学习(3) - 3D模型 - Jeff's world</title>
    <!-- The Open Graph protocol -->
  <meta property="og:url" content="http://jeffzhong.space">
  <meta property="og:type" content="blog">
  <meta property="og:title" content="WebGL学习(3) - 3D模型 - Jeff's world">
  <meta property="og:description" content="it's a blog by hexo">
  <!-- UC Browser Compatible -->
<!--   <script>
      var agent = navigator.userAgent.toLowerCase();
      if(agent.indexOf('ucbrowser')>0) {
          alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
      }
  </script> -->
  
    
    
      <link rel="stylesheet" href="/lib/fontello/fontello.css?t=1">
    
      <link rel="stylesheet" href="/lib/reboto/roboto.css?t=1">
    
      <link rel="stylesheet" href="/dist/css/index.css?t=1">
    
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5255e97b442092b8e1a219e6a48a0d42";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>
<header class="header">
  <div class="top"></div>
  <h2>Jeff's World</h2>
  <h3>Things that I'm interested in</h3>
  <div class="menu">
  
  
  
      <a href="/">
        <i class="icon icon-home"></i>
        主页
      </a>
  
      <a href="http://jeffzhong.space/sites/demo/">
        <i class="icon icon-tag"></i>
        Demo
      </a>
  
      <a data-tag="search" href="javascript:;">
        <i class="icon icon-search"></i>
        搜索
      </a>
  
  </div>
  <div class="state">
  
    <a href="/archives">35<br>文章</a><a href="/categories">2<br>分类</a><a href="/tags">57<br>标签</a>
  </div>
  <div class="social">
  
  
  
      <a href="https://github.com/edwardzhong" title="Github"><i class="icon icon-github-circled"></i></a>
  
      <a href="https://twitter.com/JianfengEdward" title="Twitter"><i class="icon icon-twitter"></i></a>
  
      <a href="https://www.facebook.com/jianfeng.edward" title="Facebook"><i class="icon icon-facebook"></i></a>
  
      <a href="http://weibo.com/1593251850" title="Weibo"><i class="icon icon-weibo"></i></a>
  
      <a href="/atom.xml" title="Rss"><i class="icon icon-rss"></i></a>
  
  </div>
  <div id="payBtn" class="pay-icon" title="谢谢您的赞赏">赏</div>
</header>
  <div class="container">
    <div class="main">
    
        
<div class="post-list">
	<article class="post" style="animation:listshow 0.6s ease-out both 0.30000000000000004s">
    
    
        
    
	
	<a href="javascript:;">
        <div class="post-banner" style="background: url(https://upload-images.jianshu.io/upload_images/127924-1bcbb19d24c33d03.jpg)  center top / 100% no-repeat">
    		<h3 class="post-title">WebGL学习(3) - 3D模型</h3>
    	</div>
	</a>
	<div class="post-inner">
	
    	<div class="post-info">
    		<time class="icon icon-calendar"> 2017/12/26 03:19:00</time>
    		<span class="category">
    		
    			
    			<i class="icon icon-book"></i>
    			
                    
                        <a href="/categories/技术/">技术</a>
                    
        			
    			
    		
    		</span>
    	</div>
    	<!-- <p><p>&emsp;&emsp;相信很多人是以创建逼真酷炫的三维效果为目标而学习webGL的吧，首先我就是😂。我掌握了足够的webGL技巧后，正准备大展身手时，遇到了一种尴尬的情况：还是做不出想要的…</p>
</p> -->
    	
    	<div class="post-content"><!-- &emsp;&emsp;原文地址：[WebGL学习(3) - 3D模型](https://edwardzhong.github.io/2017/12/26/webglspitfire/) -->
<p>&emsp;&emsp;相信很多人是以创建逼真酷炫的三维效果为目标而学习webGL的吧，首先我就是😂。我掌握了足够的webGL技巧后，正准备大展身手时，遇到了一种尴尬的情况：还是做不出想要的东西😭。为啥呢，因为没有3D模型可供操作啊，纯粹用代码构建复杂的3D模型完全不可想象。那必须使用3dMax，maya，以及开源的blender等建模软件进行构建。既然已经入了webGL的坑了，那也只能硬着头皮继续学习3D建模，断断续续学了一个多月的blender教程，总算入门了。<br>&emsp;&emsp;这节主要学习如何导入模型文件，然后用代码应用效果，操作模型。首先展示下我的大作，喷火战斗机的3D模型：<em><a href="https://edwardzhong.github.io/sites/demo/dist/webglSpitfire.html" target="_blank" rel="noopener">webGL 喷火战斗机</a></em><br><img src="https://upload-images.jianshu.io/upload_images/127924-b8917d8e69f3f44b.gif" width="600"><br><a id="more"></a></p>
<h2 id="内容大纲"><a href="#内容大纲" class="headerlink" title="内容大纲"></a>内容大纲</h2><ol>
<li>模型文件</li>
<li>着色器</li>
<li>光照</li>
<li>模型变换</li>
<li>事件处理</li>
</ol>
<h2 id="模型文件"><a href="#模型文件" class="headerlink" title="模型文件"></a>模型文件</h2><p>&emsp;&emsp;blender导出的模型文件plane.obj, 同时还包括材质文件plane.mtl。模型包括2800多个顶点，2200多个面，共200多k的体积，内容比较大，所以只能将文件加载入html文件比较方便。<br>&emsp;&emsp;那怎么加载呢？一般会使用ajax获取，但我这里有更方便的办法。那就是将模型文件内容预编译直出到html中，这样不但提高了加载性能，开发也更方便。具体可参考我之前的文章：<em><a href="https://edwardzhong.github.io/2017/11/27/projecttemplate/" target="_blank" rel="noopener">前端快速开发模版</a></em><br>&emsp;&emsp;这里使用我之前的开发模版, 将模型(obj、mtl)文件以字符串的形式写入text/template模版中，同时将GLSL语言写的着色器也预编译到html中。到时用gulp的命令构建页面，所有内容就会自动生成到页面中，html部分的代码如下所示：<br><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;% extends '../layout/layout.html' %&#125;</span><br><span class="line">&#123;% block title %&#125;spitfire fighter&#123;% endblock %&#125;</span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/webgl.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/objParse.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/matrix.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./js/index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>上下左右方向键 调整视角，W/S/A/D键 旋转模型， +/-键 放大缩小<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"canvas"</span> <span class="attr">width</span>=<span class="string">"800"</span> <span class="attr">height</span>=<span class="string">"600"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- obj文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/template"</span> <span class="attr">id</span>=<span class="string">"tplObj"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">&#123;% include <span class="string">'../model/plane.obj'</span> %&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mtl文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/template"</span> <span class="attr">id</span>=<span class="string">"tplMtl"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">&#123;% include <span class="string">'../model/plane.mtl'</span> %&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 顶点着色器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"x-shader/x-vertex"</span> <span class="attr">id</span>=<span class="string">"vs"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">&#123;% include <span class="string">'../glsl/vs.glsl'</span> %&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 片元着色器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"x-shader/x-fragment"</span> <span class="attr">id</span>=<span class="string">"fs"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">&#123;% include <span class="string">'../glsl/fs.glsl'</span> %&#125;	</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="obj文件"><a href="#obj文件" class="headerlink" title="obj文件"></a>obj文件</h3><p>&emsp;&emsp;obj文件包含的是模型的顶点法线索引等信息。这里以最简单的立方体为例。</p>
<ul>
<li>v 几何体顶点</li>
<li>vt 贴图坐标点</li>
<li>vn 顶点法线</li>
<li>f 面：顶点索引 / 纹理坐标索引 / 法线索引</li>
<li>usemtl 使用的材质名称</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Blender v2.79 (sub 0) OBJ File: &apos;&apos;</span><br><span class="line"># www.blender.org</span><br><span class="line">mtllib cube.mtl</span><br><span class="line">o Cube</span><br><span class="line">v -0.442946 -1.000000 -1.000000</span><br><span class="line">v -0.442946 -1.000000 1.000000</span><br><span class="line">v -2.442946 -1.000000 1.000000</span><br><span class="line">v -2.442945 -1.000000 -1.000000</span><br><span class="line">v -0.442945 1.000000 -0.999999</span><br><span class="line">v -0.442946 1.000000 1.000001</span><br><span class="line">v -2.442946 1.000000 1.000000</span><br><span class="line">v -2.442945 1.000000 -1.000000</span><br><span class="line">vn 0.0000 -1.0000 0.0000</span><br><span class="line">vn 0.0000 1.0000 0.0000</span><br><span class="line">vn 1.0000 0.0000 0.0000</span><br><span class="line">vn -0.0000 -0.0000 1.0000</span><br><span class="line">vn -1.0000 -0.0000 -0.0000</span><br><span class="line">vn 0.0000 0.0000 -1.0000</span><br><span class="line">usemtl Material</span><br><span class="line">s off</span><br><span class="line">f 1//1 2//1 3//1 4//1</span><br><span class="line">f 5//2 8//2 7//2 6//2</span><br><span class="line">f 1//3 5//3 6//3 2//3</span><br><span class="line">f 2//4 6//4 7//4 3//4</span><br><span class="line">f 3//5 7//5 8//5 4//5</span><br><span class="line">f 5//6 1//6 4//6 8//6</span><br></pre></td></tr></table></figure>
<h3 id="mtl文件"><a href="#mtl文件" class="headerlink" title="mtl文件"></a>mtl文件</h3><p>&emsp;&emsp;mtl文件包含的是模型的材质信息</p>
<ul>
<li>Ka 环境色  rgb</li>
<li>Kd 漫反射色,材质颜色  rgb</li>
<li>Ks 高光色，材质高光颜色 rgb</li>
<li>Ns 反射高光度 指定材质的反射指数</li>
<li>Ni 折射值 指定材质表面的光密度</li>
<li>d 透明度 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Blender MTL File: &apos;None&apos;</span><br><span class="line"># Material Count: 1</span><br><span class="line"></span><br><span class="line">newmtl Material</span><br><span class="line">Ns 96.078431</span><br><span class="line">Ka 1.000000 1.000000 1.000000</span><br><span class="line">Kd 0.640000 0.640000 0.640000</span><br><span class="line">Ks 0.500000 0.500000 0.500000</span><br><span class="line">Ke 0.000000 0.000000 0.000000</span><br><span class="line">Ni 1.000000</span><br><span class="line">d 1.000000</span><br><span class="line">illum 2</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;知道了obj和mtl文件的格式，我们需要做的就是读取它们，逐行分析，这里使用的objParse读取解析，想知道内部原理，可以查看源代码，这里不详述。<br>&emsp;&emsp;提取出需要的信息后，就可将模型信息写入缓冲区，然后渲染出来。<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>),</span><br><span class="line">    gl = get3DContext(canvas, <span class="literal">true</span>),</span><br><span class="line">    objElem = <span class="built_in">document</span>.getElementById(<span class="string">'tplObj'</span>),</span><br><span class="line">    mtlElem = <span class="built_in">document</span>.getElementById(<span class="string">'tplMtl'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取变量地址</span></span><br><span class="line">    <span class="keyword">var</span> program = gl.program;</span><br><span class="line">    program.a_Position = gl.getAttribLocation(gl.program, <span class="string">'a_Position'</span>);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建空数据缓冲</span></span><br><span class="line">    <span class="keyword">var</span> vertexBuffer = createEmptyArrayBuffer(gl, program.a_Position, <span class="number">3</span>, gl.FLOAT);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分析模型字符串</span></span><br><span class="line">    <span class="keyword">var</span> objDoc = <span class="keyword">new</span> OBJDoc(<span class="string">'plane'</span>,objElem.text,mtlElem.text);</span><br><span class="line">    <span class="keyword">if</span>(!objDoc.parse(<span class="number">1</span>, <span class="literal">false</span>))&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">    <span class="keyword">var</span> drawingInfo = objDoc.getDrawingInfo();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将数据写入缓冲区</span></span><br><span class="line">    gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);</span><br><span class="line">    gl.bufferData(gl.ARRAY_BUFFER, drawingInfo.vertices, gl.STATIC_DRAW);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="着色器"><a href="#着色器" class="headerlink" title="着色器"></a>着色器</h2><h3 id="顶点着色器"><a href="#顶点着色器" class="headerlink" title="顶点着色器"></a>顶点着色器</h3><p>&emsp;&emsp;顶点着色器比较简单，和之前的区别比较大的是，把计算颜色光照部分移到了片元着色器，这样可以实现逐片元光照，效果会更加逼真和自然。<br><figure class="highlight glsl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> a_Position;<span class="comment">//顶点位置</span></span><br><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> a_Color;<span class="comment">//顶点颜色</span></span><br><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> a_Scolor;<span class="comment">//顶点高光颜色</span></span><br><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> a_Normal;<span class="comment">//法向量</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> u_MvpMatrix;<span class="comment">//mvp矩阵</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> u_ModelMatrix;<span class="comment">//模型矩阵</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> u_NormalMatrix;</span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec4</span> v_Color;</span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec4</span> v_Scolor;</span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec3</span> v_Normal;</span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec3</span> v_Position;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    <span class="built_in">gl_Position</span> = u_MvpMatrix * a_Position;</span><br><span class="line">    <span class="comment">// 计算顶点在世界坐标系的位置</span></span><br><span class="line">    v_Position = <span class="type">vec3</span>(u_ModelMatrix * a_Position);</span><br><span class="line">    <span class="comment">// 计算变换后的法向量并归一化</span></span><br><span class="line">    v_Normal = <span class="built_in">normalize</span>(<span class="type">vec3</span>(u_NormalMatrix * a_Normal));</span><br><span class="line">    v_Color = a_Color;</span><br><span class="line">    v_Scolor = a_Scolor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="光照"><a href="#光照" class="headerlink" title="光照"></a>光照</h2><p>&emsp;&emsp;光照相关的计算主要在片元着色器中，首先科普一下光照的相关信息。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">物体呈现出颜色亮度就是表面的反射光导致，计算反射光公式如下：</span><br><span class="line">&lt;表面的反射光颜色&gt; = &lt;漫反射光颜色&gt; + &lt;环境反射光颜色&gt; + &lt;镜面反射光颜色&gt;</span><br><span class="line"></span><br><span class="line">1. 其中漫反射公式如下：</span><br><span class="line">&lt;漫反射光颜色&gt; = &lt;入射光颜色&gt; * &lt;表面基底色&gt; * &lt;光线入射角度&gt;</span><br><span class="line"></span><br><span class="line">光线入射角度可以由光线方向和表面的法线进行点积求得：</span><br><span class="line">&lt;光线入射角度&gt; = &lt;光线方向&gt; * &lt;法线方向&gt;</span><br><span class="line"></span><br><span class="line">最后的漫反射公式如下：</span><br><span class="line">&lt;漫反射光颜色&gt; = &lt;入射光颜色&gt; * &lt;表面基底色&gt; * (&lt;光线方向&gt; * &lt;法线方向&gt;)</span><br><span class="line"></span><br><span class="line">2. 环境反射光颜色根据如下公式得到：</span><br><span class="line">&lt;环境反射光颜色&gt; = &lt;入射光颜色&gt; * &lt;表面基底色&gt;</span><br><span class="line"></span><br><span class="line">3. 镜面（高光）反射光颜色公式，这里使用的是冯氏反射原理</span><br><span class="line">&lt;镜面反射光颜色&gt; = &lt;高光颜色&gt; * &lt;镜面反射亮度权重&gt; </span><br><span class="line"></span><br><span class="line">其中镜面反射亮度权重又如下</span><br><span class="line">&lt;镜面反射亮度权重&gt; = (&lt;观察方向的单位向量&gt; * &lt;入射光反射方向&gt;) ^ 光泽度</span><br></pre></td></tr></table></figure></p>
<h3 id="片元着色器"><a href="#片元着色器" class="headerlink" title="片元着色器"></a>片元着色器</h3><p>&emsp;&emsp;着色器代码就是对上面公式内容的演绎</p>
<figure class="highlight glsl"><table><tr><td class="code"><pre><span class="line"><span class="meta">#ifdef GL_ES</span></span><br><span class="line"><span class="keyword">precision</span> <span class="keyword">mediump</span> <span class="type">float</span>;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> u_LightPosition;<span class="comment">//光源位置</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> u_diffuseColor;<span class="comment">//漫反射光颜色</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> u_AmbientColor;<span class="comment">//环境光颜色</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> u_specularColor;<span class="comment">//镜面反射光颜色</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> u_MaterialShininess;<span class="comment">// 镜面反射光泽度</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec3</span> v_Normal;<span class="comment">//法向量</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec3</span> v_Position;<span class="comment">//顶点位置</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec4</span> v_Color;<span class="comment">//顶点颜色</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec4</span> v_Scolor;<span class="comment">//顶点高光颜色</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    <span class="comment">// 对法线归一化</span></span><br><span class="line">    <span class="type">vec3</span> normal = <span class="built_in">normalize</span>(v_Normal);</span><br><span class="line">    <span class="comment">// 计算光线方向(光源位置-顶点位置)并归一化</span></span><br><span class="line">    <span class="type">vec3</span> lightDirection = <span class="built_in">normalize</span>(u_LightPosition - v_Position);</span><br><span class="line">    <span class="comment">// 计算光线方向和法向量点积</span></span><br><span class="line">    <span class="type">float</span> nDotL = <span class="built_in">max</span>(<span class="built_in">dot</span>(lightDirection, normal), <span class="number">0.0</span>);</span><br><span class="line">    <span class="comment">// 漫反射光亮度</span></span><br><span class="line">    <span class="type">vec3</span> diffuse = u_diffuseColor  * nDotL * v_Color.rgb;</span><br><span class="line">    <span class="comment">// 环境光亮度</span></span><br><span class="line">    <span class="type">vec3</span> ambient = u_AmbientColor * v_Color.rgb;</span><br><span class="line">    <span class="comment">// 观察方向的单位向量V</span></span><br><span class="line">    <span class="type">vec3</span> eyeDirection = <span class="built_in">normalize</span>(-v_Position);</span><br><span class="line">    <span class="comment">// 反射方向</span></span><br><span class="line">    <span class="type">vec3</span> reflectionDirection = <span class="built_in">reflect</span>(-lightDirection, normal);</span><br><span class="line">    <span class="comment">// 镜面反射亮度权重</span></span><br><span class="line">    <span class="type">float</span> specularLightWeighting = <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="built_in">dot</span>(reflectionDirection, eyeDirection), <span class="number">0.0</span>), u_MaterialShininess);</span><br><span class="line">    <span class="comment">// 镜面高光亮度</span></span><br><span class="line">    <span class="type">vec3</span> specular =  v_Scolor.rgb * specularLightWeighting ;</span><br><span class="line">    <span class="built_in">gl_FragColor</span> = <span class="type">vec4</span>(ambient + diffuse + specular, v_Color.a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="模型变换"><a href="#模型变换" class="headerlink" title="模型变换"></a>模型变换</h2><p>&emsp;&emsp;这里先设置光照相关的初始条件，然后是mvp矩阵变换和法向量矩阵相关的计算，具体知识点可参考之前的文章<em><a href="https://edwardzhong.github.io/2017/11/14/webgl2/" target="_blank" rel="noopener">WebGL学习(2) - 3D场景</a></em></p>
<p>&emsp;&emsp;要注意的是逆转置矩阵，主要用于计算模型变换之后的法向量，有了变换后的法向量才能正确计算光照。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> 求逆转置矩阵步骤</span><br><span class="line">    1.求原模型矩阵的逆矩阵</span><br><span class="line">    2.将逆矩阵转置</span><br><span class="line"></span><br><span class="line">&lt;变换后法向量&gt; = &lt;逆转置矩阵&gt; * &lt;变换前法向量&gt;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;给着色器变量赋值然后绘制出模型，最后调用requestAnimationFrame不断执行动画。矩阵的旋转部分可结合下面的keydown事件进行查看。<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 光线方向</span></span><br><span class="line">    gl.uniform3f(u_LightPosition, <span class="number">0.0</span>, <span class="number">2.0</span>, <span class="number">12.0</span>);</span><br><span class="line">    <span class="comment">// 漫反射光照颜色</span></span><br><span class="line">    gl.uniform3f(u_diffuseColor, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    <span class="comment">// 设置环境光颜色</span></span><br><span class="line">    gl.uniform3f(u_AmbientColor, <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>);</span><br><span class="line">    <span class="comment">// 镜面反射光泽度</span></span><br><span class="line">    gl.uniform1f(u_MaterialShininess, <span class="number">30.0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> modelMatrix = <span class="keyword">new</span> Matrix4();</span><br><span class="line">    <span class="keyword">var</span> mvpMatrix = <span class="keyword">new</span> Matrix4();</span><br><span class="line">    <span class="keyword">var</span> normalMatrix = <span class="keyword">new</span> Matrix4();</span><br><span class="line">    <span class="keyword">var</span> n = drawingInfo.indices.length;</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="keyword">function</span> <span class="title">animate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 模型矩阵</span></span><br><span class="line">        <span class="keyword">if</span>(notMan)&#123; angleY+=<span class="number">0.5</span>; &#125;</span><br><span class="line">        modelMatrix.setRotate(angleY % <span class="number">360</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>); <span class="comment">// 绕y轴旋转</span></span><br><span class="line">        modelMatrix.rotate(angleX % <span class="number">360</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 绕x轴旋转</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> eyeY=viewLEN*<span class="built_in">Math</span>.sin(viewAngleY*<span class="built_in">Math</span>.PI/<span class="number">180</span>),</span><br><span class="line">            len=viewLEN*<span class="built_in">Math</span>.cos(viewAngleY*<span class="built_in">Math</span>.PI/<span class="number">180</span>),</span><br><span class="line">            eyeX=len*<span class="built_in">Math</span>.sin(viewAngleX*<span class="built_in">Math</span>.PI/<span class="number">180</span>),</span><br><span class="line">            eyeZ=len*<span class="built_in">Math</span>.cos(viewAngleX*<span class="built_in">Math</span>.PI/<span class="number">180</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 视点投影</span></span><br><span class="line">        mvpMatrix.setPerspective(<span class="number">30</span>, canvas.width / canvas.height, <span class="number">1</span>, <span class="number">300</span>);</span><br><span class="line">        mvpMatrix.lookAt(eyeX, eyeY, eyeZ, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, (viewAngleY&gt;<span class="number">90</span>||viewAngleY&lt;<span class="number">-90</span>)?<span class="number">-1</span>:<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        mvpMatrix.multiply(modelMatrix);</span><br><span class="line">        <span class="comment">// 根据模型矩阵计算用来变换法向量的矩阵</span></span><br><span class="line">        normalMatrix.setInverseOf(modelMatrix);</span><br><span class="line">        normalMatrix.transpose();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模型矩阵</span></span><br><span class="line">        gl.uniformMatrix4fv(u_ModelMatrix, <span class="literal">false</span>, modelMatrix.elements);</span><br><span class="line">        <span class="comment">// mvp矩阵</span></span><br><span class="line">        gl.uniformMatrix4fv(u_MvpMatrix, <span class="literal">false</span>, mvpMatrix.elements);</span><br><span class="line">        <span class="comment">// 法向量矩阵</span></span><br><span class="line">        gl.uniformMatrix4fv(u_NormalMatrix, <span class="literal">false</span>, normalMatrix.elements);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清屏|清深度缓冲</span></span><br><span class="line">        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据顶点索引绘制图形(图形类型，绘制顶点个数，顶点索引数据类型，顶点索引中开始绘制的位置)</span></span><br><span class="line">        gl.drawElements(gl.TRIANGLES, n, gl.UNSIGNED_SHORT, <span class="number">0</span>);</span><br><span class="line">        requestAnimationFrame(animate);</span><br><span class="line">    &#125;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h2><p>&emsp;&emsp;+/- 键实现放大/缩小场景的功能；WSAD键实现模型的旋转，也就是实现绕x轴和y轴旋转；上下左右方向键实现的是视点的旋转。矩阵变换的相关实现参考上面代码的动画部分。</p>
<p>&emsp;&emsp;模型旋转和视点旋转看着很相似，其实又有不同的。视点的旋转是整个场景比如光照模型等都是跟着变化的，如果以场景做参照物，它就相当于人改变观察位置观看物体。而模型旋转呢，它只旋转模型自身，外部的光照和场景都是不变的，以场景做参照物，相当于人在同一位置观看模型在运动。从demo的光照可以看出两种方式的区别。<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'keydown'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>([<span class="number">37</span>,<span class="number">38</span>,<span class="number">39</span>,<span class="number">65</span>,<span class="number">58</span>,<span class="number">83</span>,<span class="number">87</span>,<span class="number">40</span>].indexOf(e.keyCode)&gt;<span class="number">-1</span>)&#123;</span><br><span class="line">        notMan=<span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span>(e.keyCode)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">38</span>:        <span class="comment">//up</span></span><br><span class="line">            viewAngleY-=<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(viewAngleY&lt;<span class="number">-270</span>)&#123;</span><br><span class="line">                viewAngleY+=<span class="number">360</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">40</span>:        <span class="comment">//down</span></span><br><span class="line">            viewAngleY+=<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(viewAngleY&gt;<span class="number">270</span>)&#123;</span><br><span class="line">                viewAngleY-=<span class="number">360</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">37</span>:        <span class="comment">//left</span></span><br><span class="line">            viewAngleX+=<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">39</span>:        <span class="comment">//right</span></span><br><span class="line">            viewAngleX-=<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">87</span>:        <span class="comment">//w</span></span><br><span class="line">            angleX-=<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">83</span>:        <span class="comment">//s</span></span><br><span class="line">            angleX+=<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">65</span>:        <span class="comment">//a</span></span><br><span class="line">            angleY+=<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">68</span>:        <span class="comment">//d</span></span><br><span class="line">            angleY-=<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">187</span>:       <span class="comment">//zoom in</span></span><br><span class="line">            <span class="keyword">if</span>(viewLEN&gt;<span class="number">6</span>) viewLEN--;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">189</span>:       <span class="comment">//zoom out</span></span><br><span class="line">            <span class="keyword">if</span>(viewLEN&lt;<span class="number">30</span>) viewLEN++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;最后，个人感觉建立3D模型还是挺费时间，需要花心机慢慢调整，才能做出比较完美的模型。</p>
</div>
    	
		<div class="post-footer">
			<div class="share" data-url="/2017/12/26/webglspitfire/" data-desc="
&emsp;&emsp;相信很多人是以创建逼真酷炫的三维效果为目标而学习webGL的吧，首先..."><a href="javascript:;" data-type="share" class="icon icon-share"> 分享</a></div>
			<div class="tags">
			<i class="icon icon-tag"></i> 
			
				
				
                    
                        <a href="/tags/前端/">前端</a>
                    
				
                    
                        <a href="/tags/js/">js</a>
                    
				
                    
                        <a href="/tags/webGL/">webGL</a>
                    
				
			
			</div>
		</div>
	</div>
</article>
</div>

<nav class="pagination clearfix">
  
    
      
      <a href="/2018/01/12/webglpolygons/" class="prev post-prev">&larr; WebGL多模型光照综合实例</a>
      

      
      <a href="/2017/12/01/netgrab/" class="next post-next">NodeJS网络爬虫 &rarr;</a>
      
    
  
</nav>

<div class="wxshare-popup">
    <a class="close" href="javascript:;"><i class="icon icon-cancel"></i></a>
    <p>扫一扫，分享到微信</p>
    <div id="qrcode" class="wx-qrcode"></div>
</div>

    
    <footer class="footer">
<p class="theme">
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/edwardzhong/simply.git">simply</a>
</p>
<p class="copy">Copyright &copy; 2019 Jeff Zhong</p>
</footer>
    <div class="top-bottom">
      <div class="to-top hide" title="to top"><i class="icon icon-up-open"></i></div>
      <div class="to-bottom hide" title="to bottom"><i class="icon icon-down-open"></i></div>
    </div>
    </div>

  </div>
<input type="hidden" name="isPost" id="isPost" value="true">
<i id="barBtn" class="icon icon-menu"></i>
<div id="payMe" class="payme">
    <i class="icon icon-cancel"></i>
    <p class="pay-title">给我的早餐加个蛋吧 <i class="icon icon-smile"></i></p>
    <div>
      <img src="/img/weixinpay.jpg" alt="weixinpay">
      <img src="/img/alipay.jpg" alt="alipay" style="display:none;">
    </div>
    <div class="pay-selects">
        <input type="radio" name="pay" id="weixinpay" checked="checked"><label for="weixinpay"> 微信 </label>&nbsp;&nbsp;
        <input type="radio" name="pay" id="alipay"><label for="alipay"> 支付宝 </label>
    </div>
</div>

  
  
    <script src="/lib/jquery-2.2.3.min.js"></script>
  
    <script src="/lib/qrcode.min.js"></script>
  
    <script src="/dist/js/index.js"></script>
  

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


</body>
</html>
