<!doctype html>
<html lang="zh-CN">









<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <!-- ä¼˜å…ˆä½¿ç”¨ IE æœ€æ–°ç‰ˆæœ¬å’Œ Chrome -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <!-- ä¸ºç§»åŠ¨è®¾å¤‡æ·»åŠ  viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <!-- æ·»åŠ åˆ°ä¸»å±åçš„æ ‡é¢˜ï¼ˆiOS 6 æ–°å¢ï¼‰ -->
  <meta name="apple-mobile-web-app-title" content="WebGLä¹‹å»¶è¿Ÿç€è‰² - Jeff's world">
  <!-- æ˜¯å¦å¯ç”¨ WebApp å…¨å±æ¨¡å¼ï¼Œåˆ é™¤è‹¹æœé»˜è®¤çš„å·¥å…·æ å’Œèœå•æ  -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <!-- è®¾ç½®è‹¹æœå·¥å…·æ é¢œè‰² -->
  <meta name="apple-mobile-web-app-status-bar-style" content = "black" />
  <!-- æ·»åŠ æ™ºèƒ½ App å¹¿å‘Šæ¡ Smart App Bannerï¼ˆiOS 6+ Safariï¼‰ -->
  <!-- <meta name = "apple-itunes-app" content = "app-id=myAppStoreID, affiliate-data=myAffiliateData, app-argument=myURL"> -->
  <!-- å¿½ç•¥é¡µé¢ä¸­çš„æ•°å­—è¯†åˆ«ä¸ºç”µè¯ï¼Œå¿½ç•¥emailè¯†åˆ« -->
  <meta name="format-detection" content = "telphone=no, email=no" />
  <!--ä¸‹é¢ä¸‰ä¸ªæ˜¯æ¸…é™¤ç¼“å­˜ å¾®ä¿¡æµè§ˆå™¨ç¼“å­˜ä¸¥é‡åˆæ— åˆ·æ–°ï¼›è¿™ä¸ªæ–¹æ³•è°ƒè¯•çš„æ—¶å€™å¾ˆæ–¹ä¾¿-->
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <link rel="dns-prefetch" href="https://jeff_zhong.gitee.io/blog">
  <link rel="icon shortcut" type="image/ico" href="/favicon.ico">
  <meta name="author" content="Jeff Zhong">
  <meta name="description" content="it's a blog by hexo">
  <meta name="keywords" content="hexo theme">
  <title >WebGLä¹‹å»¶è¿Ÿç€è‰² - Jeff's world</title>
    <!-- The Open Graph protocol -->
  <meta property="og:url" content="https://jeff_zhong.gitee.io/blog">
  <meta property="og:type" content="blog">
  <meta property="og:title" content="WebGLä¹‹å»¶è¿Ÿç€è‰² - Jeff's world">
  <meta property="og:description" content="it's a blog by hexo">
  
    
    
      <link rel="stylesheet" href="/blog/lib/fontello/fontello.css">
    
      <link rel="stylesheet" href="/blog/lib/reboto/roboto.css">
    
      <link rel="stylesheet" href="/blog/css/index.css">
    
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5255e97b442092b8e1a219e6a48a0d42";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/blog/atom.xml" title="Jeff's world" type="application/atom+xml">
</head>
<body>
<header class="header">
  <div class="top"></div>
  <h2>Jeff's World</h2>
  <h3>Things that I'm interested in</h3>
  <div class="menu">
  
  
  
      <a  href="/blog/" title="ä¸» é¡µ">
        <i class="icon-home"></i>
        <span>ä¸» é¡µ</span>
      </a>
  
      <a  href="https://jeff_zhong.gitee.io/demo/" title="Demo">
        <i class="icon-page"></i>
        <span>Demo</span>
      </a>
  
      <a  data-tag="search"  href="javascript:;" title="æœ ç´¢">
        <i class="icon-search"></i>
        <span>æœ ç´¢</span>
      </a>
  
  </div>
  <div class="state">
  
    <a href="/blog/archives">48<br>æ–‡ ç« </a><a href="/blog/categories">2<br>åˆ† ç±»</a><a href="/blog/tags">64<br>æ ‡ ç­¾</a>
  </div>
  <div class="social">
  
  
  
      <a href="https://github.com/edwardzhong" target="_blank" rel="noopener" title="Github"><i class="icon-github"></i></a>
  
      <a href="https://twitter.com/JianfengEdward" target="_blank" rel="noopener" title="Twitter"><i class="icon-twitter"></i></a>
  
      <a href="https://www.facebook.com/jianfeng.edward" target="_blank" rel="noopener" title="Facebook"><i class="icon-facebook"></i></a>
  
      <a href="http://weibo.com/1593251850" target="_blank" rel="noopener" title="Weibo"><i class="icon-weibo"></i></a>
  
      <a href="/blog/atom.xml" title="Rss"><i class="icon-rss"></i></a>
  
  </div>
  <div id="payBtn" class="pay-icon" title="è°¢è°¢æ‚¨çš„èµèµ">èµ</div>
</header>
  <div class="container">
    <div class="main">
    
        
<div class="post-list">
	<article class="post" style="animation:listshow 0.6s ease-out both 0.30000000000000004s">
    
    
        
    
	
	<a href="javascript:;">
        <div class="post-banner" style="background: url(/images/banner8.jpg)  center top / 100% no-repeat">
    		<h3 class="post-title">WebGLä¹‹å»¶è¿Ÿç€è‰²</h3>
    	</div>
	</a>
	<div class="post-inner">
	
    	<div class="post-info">
    		<time><i class="icon-calendar"></i> 2020/09/17 19:30:00</time>
    		<span class="category">
    		
    			
    			<i class="icon-book"></i>
    			
                    
                        <a href="/blog/categories/%E6%8A%80%E6%9C%AF/">æŠ€æœ¯</a>
                    
    			
    		
    		</span>
    	</div>
    	<!-- <p><p>ä»€ä¹ˆæ˜¯å»¶è¿Ÿç€è‰²(Deferred Shading)ï¼Ÿå®ƒæ˜¯ç›¸å¯¹äºæ­£å¸¸ä½¿ç”¨çš„æ­£å‘ç€è‰²(Forward Shading)è€Œè¨€çš„ï¼Œæ­£å‘ç€è‰²çš„å·¥ä½œæ¨¡å¼ï¼šéå†å…‰æºï¼Œè·å–å…‰ç…§æ¡ä»¶ï¼Œæ¥ç€éå†ç‰©ä½“ï¼Œè·å–ç‰©ä½“çš„å‡ ä½•â€¦</p>
</p> -->
    	
    		<div class="post-content"><p>ä»€ä¹ˆæ˜¯<strong>å»¶è¿Ÿç€è‰²(Deferred Shading)</strong>ï¼Ÿå®ƒæ˜¯ç›¸å¯¹äºæ­£å¸¸ä½¿ç”¨çš„<strong>æ­£å‘ç€è‰²(Forward Shading)</strong>è€Œè¨€çš„ï¼Œæ­£å‘ç€è‰²çš„å·¥ä½œæ¨¡å¼ï¼šéå†å…‰æºï¼Œè·å–å…‰ç…§æ¡ä»¶ï¼Œæ¥ç€éå†ç‰©ä½“ï¼Œè·å–ç‰©ä½“çš„å‡ ä½•æ•°æ®ï¼Œæœ€åæ ¹æ®å…‰ç…§å’Œç‰©ä½“å‡ ä½•æ•°æ®è¿›è¡Œè®¡ç®—ã€‚</p>
<p>ä½†æ˜¯<strong>æ­£å‘ç€è‰²(Forward Shading)</strong>åœ¨å…‰æºéå¸¸å¤šçš„æƒ…å†µä¸‹ï¼Œå¯¹æ€§èƒ½çš„æ¶ˆè€—éå¸¸å¤§ã€‚å› ä¸ºç¨‹åºè¦å¯¹æ¯ä¸€ä¸ªå…‰æºï¼Œæ¯ä¸€ä¸ªéœ€è¦æ¸²æŸ“çš„ç‰©ä½“ï¼Œæ¯ä¸€ä¸ªéœ€è¦æ¸²æŸ“çš„ç‰‡æ®µè¿›è¡Œè¿­ä»£ï¼è¿˜æœ‰ç‰‡æ®µç€è‰²å™¨çš„è¾“å‡ºä¼šè¢«ä¹‹åçš„è¾“å‡ºè¦†ç›–ï¼Œæ­£å‘æ¸²æŸ“ä¼šåœ¨åœºæ™¯ä¸­å› å¤šä¸ªç‰©ä½“é‡åˆåœ¨ä¸€ä¸ªåƒç´ ä¸Šæµªè´¹å¤§é‡çš„ç‰‡æ®µç€è‰²å™¨è¿è¡Œæ—¶é—´ã€‚</p>
<p><strong>å»¶è¿Ÿç€è‰²(Deferred Shading)</strong>ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜è€Œç”Ÿï¼Œå°¤å…¶æ˜¯éœ€è¦æ¸²æŸ“å‡ ç™¾ä¸Šåƒä¸ªå…‰æºçš„åœºæ™¯ã€‚</p>
<a id="more"></a>

<p>æœ¬èŠ‚å®ç°çš„æ•ˆæœè¯·çœ‹ï¼š<em><a href="https://jeff_zhong.gitee.io/demo/dist/deferredShading.html">å»¶è¿Ÿç€è‰² deferred sharding</a></em></p>
<img src="/images/deferred.gif" width="400" alt="å»¶è¿Ÿç€è‰²">

<p>æ­£å‘ç€è‰²ä¼ªä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">foreach light &#123;</span><br><span class="line">  foreach visible mesh &#123;</span><br><span class="line">    <span class="keyword">if</span> (light volume intersects mesh) &#123;</span><br><span class="line">      render using <span class="keyword">this</span> material/light shader;</span><br><span class="line">      accumulate <span class="keyword">in</span> framebuffer using additive blending;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å»¶è¿Ÿç€è‰²"><a href="#å»¶è¿Ÿç€è‰²" class="headerlink" title="å»¶è¿Ÿç€è‰²"></a>å»¶è¿Ÿç€è‰²</h2><p><strong>å»¶è¿Ÿç€è‰²(Deferred Shading)</strong>å·¥ä½œæ¨¡å¼å°±æ˜¯å°†è®¡ç®—é‡å¤§çš„æ¸²æŸ“å…‰ç…§éƒ¨åˆ† <strong>å»¶è¿Ÿ(Defer)</strong> åˆ°åæœŸè¿›è¡Œå¤„ç†ï¼Œå› æ­¤å®ƒåŒ…å«ä¸¤ä¸ªå¤„ç†é˜¶æ®µ(Pass)ï¼š</p>
<ol>
<li>ç¬¬ä¸€ä¸ª <strong>å‡ ä½•å¤„ç†é˜¶æ®µ(Geometry Pass)</strong> æ˜¯å°†å¯¹è±¡çš„å„ç§å‡ ä½•ä¿¡æ¯è¿›è¡Œæ¸²æŸ“å¹¶å‚¨å­˜åœ¨å«åš<strong>Gç¼“å†²(G-buffer)</strong>çš„çº¹ç†ä¸­ã€‚ä¸»è¦åŒ…æ‹¬<strong>ä½ç½®å‘é‡(Position Vector)</strong>ã€<strong>é¢œè‰²å‘é‡(Color Vector)</strong>ã€<strong>æ³•å‘é‡(Normal Vector)</strong>ã€‚è¿™äº›å‚¨å­˜åœ¨Gç¼“å†²ä¸­çš„å‡ ä½•ä¿¡æ¯å°†ä¼šç”¨æ¥åšä¹‹åçš„å…‰ç…§è®¡ç®—ã€‚</li>
<li>ç¬¬äºŒä¸ª <strong>å…‰ç…§å¤„ç†é˜¶æ®µ(Lighting Pass)</strong> æ˜¯å¯¹Gç¼“å†²ä¸­çš„å‡ ä½•æ•°æ®çš„æ¯ä¸€ä¸ªç‰‡æ®µè¿›è¡Œå…‰ç…§è®¡ç®—ã€‚å…‰ç…§å¤„ç†é˜¶æ®µä¸æ˜¯ç›´æ¥å°†æ¯ä¸ªå¯¹è±¡ä»é¡¶ç‚¹ç€è‰²å™¨å¸¦åˆ°ç‰‡æ®µç€è‰²å™¨ï¼Œè€Œæ˜¯å¯¹Gç¼“å†²ä¸­çš„æ¯ä¸ªåƒç´ è¿›è¡Œè¿­ä»£ï¼Œä»å¯¹åº”çš„Gç¼“å†²çº¹ç†è·å–è¾“å…¥å˜é‡ã€‚</li>
</ol>
<p>å»¶è¿Ÿç€è‰²ä¼ªä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// g-buffer pass</span></span><br><span class="line">foreach visible mesh &#123;</span><br><span class="line">  write material properties to g-buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// light accumulation pass</span></span><br><span class="line">foreach light &#123;</span><br><span class="line">  compute light by reading g-buffer;</span><br><span class="line">  accumulate <span class="keyword">in</span> framebuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="å¸§ç¼“å†²"><a href="#å¸§ç¼“å†²" class="headerlink" title="å¸§ç¼“å†²"></a>å¸§ç¼“å†²</h2><p><strong>å»¶è¿Ÿç€è‰²(Deferred Shading)</strong> çš„ <strong>Gç¼“å†²(G-buffer)</strong> æ˜¯åŸºäº <strong>å¸§ç¼“å†²(frameBuffer)</strong> å®ç°çš„ï¼Œæ¶‰åŠåˆ°é«˜çº§åº”ç”¨ï¼Œå¸§ç¼“å†² çœŸçš„æ˜¯æ— å¤„ä¸åœ¨å•Šï¼è¯¥demoçš„å‡ ä½•å¤„ç†é˜¶æ®µåˆ†åˆ«å¯¹<strong>ä½ç½®(position)</strong>ï¼Œ<strong>æ³•å‘é‡(normal)</strong>ï¼Œ<strong>é¢œè‰²(color)</strong> è¿›è¡Œç¼“å­˜ï¼Œé‚£ä¹ˆå¯¹åº”å°±è¦å»ºç«‹3ä¸ªé¢œè‰²é™„ä»¶ï¼Œåˆ«å¿˜äº†åŒæ—¶å»ºç«‹ç”¨äºæ·±åº¦æµ‹è¯•ç”¨çš„ <strong>æ·±åº¦ç¼“å†²(Z-Buffer)</strong>ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fb = gl.createFramebuffer();</span><br><span class="line">gl.bindFramebuffer(gl.FRAMEBUFFER, fb);</span><br><span class="line"><span class="keyword">const</span> fbo = &#123;</span><br><span class="line">  framebuffer: fb,</span><br><span class="line">  textures: []</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºé¢œè‰²çº¹ç†</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line">  <span class="keyword">const</span> tex = initTexture(gl, &#123; <span class="attr">informat</span>: gl.RGBA16F, <span class="attr">type</span>: gl.FLOAT &#125;, width, height);</span><br><span class="line">  framebufferInfo.textures.push(tex);</span><br><span class="line">  gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0 + i, gl.TEXTURE_2D, tex, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºæ·±åº¦æ¸²æŸ“ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">const</span> depthBuffer = gl.createRenderbuffer();</span><br><span class="line">gl.bindRenderbuffer(gl.RENDERBUFFER, depthBuffer);</span><br><span class="line">gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, width, height);</span><br><span class="line">gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, depthBuffer);</span><br></pre></td></tr></table></figure>



<h2 id="å¤šæ¸²æŸ“ç›®æ ‡-draw-buffers"><a href="#å¤šæ¸²æŸ“ç›®æ ‡-draw-buffers" class="headerlink" title="å¤šæ¸²æŸ“ç›®æ ‡ draw buffers"></a>å¤šæ¸²æŸ“ç›®æ ‡ draw buffers</h2><p><strong>WebGL</strong> å®ç°å¤šæ¸²æŸ“ç›®æ ‡éœ€è¦æ‰“å¼€ <strong>WEBGL_draw_buffers</strong> è¿™ä¸ªæ‰©å±•ï¼Œä½†æ˜¯ <strong>WebGL 2.0</strong> ç›´æ¥å°±èƒ½ä½¿ç”¨çš„ã€‚æˆ‘è¿™é‡Œä¸ºäº†æ–¹ä¾¿å°±åŸºäº <strong>WebGL 2.0</strong> æ¥å®ç°ï¼Œå¤šæ¸²æŸ“ç›®æ ‡è°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">gl.drawBuffers([gl.COLOR_ATTACHMENT0, gl.COLOR_ATTACHMENT1, gl.COLOR_ATTACHMENT2]);</span><br></pre></td></tr></table></figure>



<h2 id="ç€è‰²å™¨"><a href="#ç€è‰²å™¨" class="headerlink" title="ç€è‰²å™¨"></a>ç€è‰²å™¨</h2><p>å› ä¸ºå»¶è¿Ÿç€è‰²å™¨åˆ†ä¸¤ä¸ªé˜¶æ®µï¼Œé‚£ä¹ˆå¯¹åº”å°±éœ€è¦ä¸¤å¯¹ç€è‰²å™¨ï¼Œé¦–å…ˆæ¥çœ‹å‡ ä½•å¤„ç†é˜¶æ®µçš„ç€è‰²å™¨ã€‚</p>
<p>å‡ ä½•å¤„ç†é˜¶æ®µ <strong>é¡¶ç‚¹ç€è‰²å™¨(vertex)</strong></p>
<figure class="highlight glsl"><table><tr><td class="code"><pre><span class="line"><span class="meta">#version 300 es</span></span><br><span class="line"><span class="keyword">in</span> <span class="type">vec4</span> aPosition;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec4</span> aNormal;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> modelMatrix;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> vpMatrix;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec3</span> vPosition;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec3</span> vNormal;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">  <span class="built_in">gl_Position</span> = vpMatrix * modelMatrix * aPosition;</span><br><span class="line">  vNormal = <span class="type">vec3</span>(<span class="built_in">transpose</span>(<span class="built_in">inverse</span>(modelMatrix)) * aNormal);</span><br><span class="line">  vPosition = <span class="type">vec3</span>(modelMatrix * aPosition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡ ä½•å¤„ç†é˜¶æ®µ <strong>ç‰‡æ®µç€è‰²å™¨(fragment)</strong>ï¼Œè¿™é‡Œçš„ä¸‰ä¸ªè¾“å‡ºå˜é‡å¯¹åº”å°±æ˜¯å¸§ç¼“å†²ä¸­çš„ä¸‰ä¸ªé¢œè‰²çº¹ç†ã€‚</p>
<figure class="highlight glsl"><table><tr><td class="code"><pre><span class="line"><span class="meta">#version 300 es</span></span><br><span class="line"><span class="keyword">precision</span> <span class="keyword">highp</span> <span class="type">float</span>;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">out</span> <span class="type">vec3</span> gPosition;<span class="comment">// ä½ç½®</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">out</span> <span class="type">vec3</span> gNormal;  <span class="comment">// æ³•å‘é‡</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">2</span>) <span class="keyword">out</span> <span class="type">vec4</span> gColor;   <span class="comment">// é¢œè‰²</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec4</span> color;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec3</span> vPosition;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec3</span> vNormal;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">  gPosition = vPosition;</span><br><span class="line">  gNormal = <span class="built_in">normalize</span>(vNormal);</span><br><span class="line">  gColor = color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€å°±æ˜¯å…‰ç…§å¤„ç†é˜¶æ®µçš„ç€è‰²å™¨ç»„äº†ã€‚</p>
<p>å…‰ç…§å¤„ç†é˜¶æ®µ <strong>é¡¶ç‚¹ç€è‰²å™¨(vertex)</strong>ï¼Œè¿™ä¸ªéå¸¸ç®€å•ï¼Œæ˜ å°„åˆ°å¸§ç¼“å†²ï¼Œä¹Ÿå°±æ˜¯ä¸ªå¹³é¢è´´å›¾è€Œå·²ã€‚</p>
<figure class="highlight glsl"><table><tr><td class="code"><pre><span class="line"><span class="meta">#version 300 es</span></span><br><span class="line"><span class="keyword">in</span> <span class="type">vec3</span> aPosition;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec2</span> aTexcoord;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec2</span> texcoord;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">  texcoord = aTexcoord;</span><br><span class="line">  <span class="built_in">gl_Position</span> = <span class="type">vec4</span>(aPosition, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…‰ç…§å¤„ç†é˜¶æ®µ <strong>ç‰‡æ®µç€è‰²å™¨(fragment)</strong>ï¼Œéœ€è¦ä»å¯¹åº”çš„çº¹ç†è´´å›¾å–å‡ºå¯¹åº”çš„å‡ ä½•æ•°æ®ã€‚ä¹Ÿå°±æ˜¯ä½¿ç”¨ <strong>texture</strong> å‡½æ•°ç»“åˆè´´å›¾å’Œ <strong>è´´å›¾åæ ‡(texcoord)</strong> å°±å¯ä»¥è®¡ç®—å‡ºå¯¹åº”çš„å‡ ä½•æ•°æ®ï¼Œå†ç»“åˆå…‰ç…§æ•°æ®æ¸²æŸ“å‡ºæœ€ç»ˆç»“æœã€‚</p>
<figure class="highlight glsl"><table><tr><td class="code"><pre><span class="line"><span class="meta">#version 300 es</span></span><br><span class="line"><span class="keyword">precision</span> <span class="keyword">highp</span> <span class="type">float</span>;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> viewPosition;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> lightDirection;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> lightColor;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> ambientColor;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> shininess;</span><br><span class="line"><span class="comment">// å„ç§è‡ªå®šä¹‰å˜é‡ ...</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> gPosition;<span class="comment">// ä½ç½®</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> gNormal;  <span class="comment">// æ³•å‘é‡</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> gColor;   <span class="comment">// é¢œè‰²</span></span><br><span class="line"><span class="keyword">in</span> <span class="type">vec2</span> texcoord;           <span class="comment">// åæ ‡</span></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> FragColor;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">  <span class="type">vec3</span> fragPos = <span class="built_in">texture</span>(gPosition, texcoord).rgb;</span><br><span class="line">  <span class="type">vec3</span> normal = <span class="built_in">texture</span>(gNormal, texcoord).rgb;</span><br><span class="line">  <span class="type">vec3</span> color = <span class="built_in">texture</span>(gColor, texcoord).rgb;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// todo: å„ç§è®¡ç®—è¿‡ç¨‹...</span></span><br><span class="line">  <span class="comment">// ç¯å¢ƒå…‰</span></span><br><span class="line">  <span class="type">vec3</span> ambient = ambientColor * color;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// æ¼«åå°„</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="type">vec3</span> diffuse = lightColor * color * cosTheta;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// é«˜å…‰</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="type">vec3</span> specular = lightColor * specularIntensity;</span><br><span class="line"></span><br><span class="line">  FragColor = <span class="type">vec4</span>(ambient + diffuse + specular, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="WebGL-æµç¨‹"><a href="#WebGL-æµç¨‹" class="headerlink" title="WebGL æµç¨‹"></a>WebGL æµç¨‹</h2><p>æœ€åå°±æ˜¯ä½¿ç”¨ <strong>JavaScript</strong> å°†æ•´ä¸ªæµç¨‹ä¸²èµ·æ¥ï¼Œ<strong>WebGL</strong> çš„å…¶ä»–æŠ€æœ¯ç»†èŠ‚ä¸å†è¯¦ç»†ä»‹ç»äº†ï¼Œå…·ä½“å¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„ <strong>WebGL</strong> æ•™ç¨‹ã€‚è¿™é‡Œä»‹ç»ä¸€ä¸‹å¤§ä½“çš„æµç¨‹ï¼š</p>
<ol>
<li>å‡ ä½•å¤„ç†é˜¶æ®µï¼šç»‘å®šå¸§ç¼“å†²ï¼Œåˆ‡æ¢åˆ°å¯¹åº”çš„programï¼Œè®¾ç½®å„ç§å˜é‡ï¼Œè¾“å‡ºåˆ°å¸§ç¼“å†²ï¼›</li>
<li>å…‰ç…§å¤„ç†é˜¶æ®µï¼šåˆ‡æ¢å›æ­£å¸¸ç¼“å†²ï¼Œåˆ‡æ¢åˆ°å¯¹åº”çš„programï¼Œè®¾ç½®å„ç§å˜é‡ï¼ŒåŒæ—¶å°†å‰é¢å‡ ä½•å¤„ç†é˜¶æ®µå¾—åˆ°çš„çº¹ç†ä½œä¸ºè¾“å…¥å˜é‡ï¼Œè¾“å‡ºæ¸²æŸ“ç»“æœï¼›</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœºæ™¯ç»˜åˆ¶åˆ°å¸§ç¼“å†²åŒº </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line">gl.bindFramebuffer(target, fbo.framebuffer); <span class="comment">// ç»‘å®šå¸§ç¼“å†²</span></span><br><span class="line">gl.viewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT); <span class="comment">// æ¸…å±</span></span><br><span class="line">gl.useProgram(program);</span><br><span class="line"><span class="comment">//é‡‡æ ·åˆ°3ä¸ªé¢œè‰²é™„ä»¶(å¯¹åº”çš„å‡ ä½•çº¹ç†)</span></span><br><span class="line">gl.drawBuffers([gl.COLOR_ATTACHMENT0, gl.COLOR_ATTACHMENT1, gl.COLOR_ATTACHMENT2]);</span><br><span class="line">setUniforms(program, uniforms);<span class="comment">// è®¾ç½®uniformå˜é‡</span></span><br><span class="line">setBuffersAndAttributes(gl, vao);<span class="comment">// è®¾ç½®ç¼“å­˜å’Œattributeå˜é‡</span></span><br><span class="line">drawBufferInfo(gl, vao); <span class="comment">// å†™å…¥ç¼“å†²åŒº</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»å¸§ç¼“å­˜æ¸²æŸ“åˆ°æ­£å¸¸ç¼“å†²åŒº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">gl.bindFramebuffer(target, <span class="literal">null</span>); <span class="comment">// åˆ‡æ¢å›æ­£å¸¸ç¼“å†²</span></span><br><span class="line">gl.viewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);</span><br><span class="line">gl.useProgram(fProgram);</span><br><span class="line"><span class="keyword">const</span> uniforms = &#123;</span><br><span class="line">  <span class="comment">// å…¶ä»–å˜é‡ ...</span></span><br><span class="line">  gPosition: fbo.textures[<span class="number">0</span>],<span class="comment">// ä½ç½®çº¹ç†</span></span><br><span class="line">  gNormal: fbo.textures[<span class="number">1</span>],<span class="comment">// æ³•å‘é‡çº¹ç†</span></span><br><span class="line">  gColor: fbo.textures[<span class="number">2</span>], <span class="comment">// é¢œè‰²çº¹ç†</span></span><br><span class="line">&#125;;</span><br><span class="line">setUniforms(fProgram, uniforms);</span><br><span class="line">setBuffersAndAttributes(gl, fVao);</span><br><span class="line">drawBufferInfo(gl, fVao); <span class="comment">// è¾“å‡ºç”»é¢</span></span><br></pre></td></tr></table></figure>

<p>æœ¬èŠ‚å®ç°çš„æ•ˆæœè¯·çœ‹ï¼š<em><a href="https://jeff_zhong.gitee.io/demo/dist/deferredShading.html">å»¶è¿Ÿç€è‰² deferred sharding</a></em></p>
<p><strong>demo</strong> ä½¿ç”¨äº†1ä¸ªå¹³è¡Œå…‰æºï¼Œ10ä¸ªç‚¹å…‰æºï¼Œ3ä¸ªèšå…‰ç¯å®ç°äº†ç±»ä¼¼èˆå…äº”å½©æ–‘æ–“çš„æ¸²æŸ“æ•ˆæœã€‚</p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p><strong>å»¶è¿Ÿç€è‰²(Deferred Shading)</strong> åœ¨å¤æ‚å…‰ç…§æ¡ä»¶ä¸‹æœ‰ç€æ€§èƒ½ä¼˜åŠ¿ï¼Œä½†å®ƒä¹Ÿæœ‰ç¼ºç‚¹ï¼šå¤§å†…å­˜å¼€é”€ã€‚è¿˜æœ‰åœ¨å…‰æºä¸æ˜¯å¾ˆå¤šçš„åœºæ™¯ä¸­ï¼Œå»¶è¿Ÿæ¸²æŸ“å¹¶ä¸ä¸€å®šä¼šæ›´å¿«ï¼Œç”šè‡³æœ‰æ—¶å€™ç”±äºå¼€é”€è¿‡å¤§è¿˜ä¼šå˜å¾—æ›´æ…¢ã€‚å½“ç„¶åœ¨æ›´å¤æ‚çš„åœºæ™¯ä¸­ï¼Œå»¶è¿Ÿæ¸²æŸ“ä¼šå˜æˆä¸€ä¸ªé‡è¦çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚</p>
</div>
    	
		<div class="post-footer">
			<div class="tags">
				<i class="icon-tags"></i> 
				
					
					
						
							<a href="/blog/tags/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a>
						
					
						
							<a href="/blog/tags/js/">js</a>
						
					
						
							<a href="/blog/tags/webGL/">webGL</a>
						
					
				
			</div>
			<a class="share" href="javascript:;" data-url="/blog/2020/09/17/webgldeferred/" data-desc="ä»€ä¹ˆæ˜¯å»¶è¿Ÿç€è‰²(Deferred Shading)ï¼Ÿå®ƒæ˜¯ç›¸å¯¹äºæ­£å¸¸ä½¿ç”¨çš„æ­£å‘ç€è‰²(Forwar..." data-type="share" title="share"><i class="icon-share"></i></a>
		</div>
	</div>
</article>
</div>
<nav class="pagination clearfix">
  
    
      
        <a href="/blog/2021/04/25/webglsphere/" class="prev post-prev"> <i class="icon-leftarrow"></i> WebGLä¹‹ç»˜åˆ¶ä¸‰ç»´åœ°çƒ</a>
      

      
        <a href="/blog/2020/07/13/docker/" class="next post-next"> Dockeræ­å»ºéƒ¨ç½²Nodeé¡¹ç›® <i class="icon-rightarrow"></i></a>
      
    
  
</nav>

<div class="wxshare-popup">
    <a class="close" href="javascript:;"></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div id="qrcode" class="wx-qrcode"></div>
</div>

    
    <footer class="footer">
<p class="theme">
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/edwardzhong/simply.git" target="_blank" rel="noopener">simply</a>
</p>
<p class="copy">Copyright &copy; 2021 Jeff Zhong</p>
</footer>
    <div class="top-bottom">
      <div class="to-top hide" title="to top"><i class="icon-up"></i></div>
      <div class="to-bottom hide" title="to bottom"><i class="icon-down"></i></div>
    </div>
    </div>

  </div>
<input type="hidden" name="isPost" id="isPost" value="true">
<i id="barBtn" class="icon icon-menu"></i>
<div id="payMe" class="payme">
    <i class="icon icon-cancel"></i>
    <p class="pay-title">ç»™æˆ‘çš„æ—©é¤åŠ ä¸ªè›‹å§ ğŸ˜Š</p>
    <div>
      <img src="/images/weixinpay.jpg" alt="weixinpay">
      <img src="/images/alipay.jpg" alt="alipay" style="display:none;">
    </div>
    <div class="pay-selects">
        <input type="radio" name="pay" id="weixinpay" checked="checked"><label for="weixinpay"> å¾®ä¿¡ </label>&nbsp;&nbsp;
        <input type="radio" name="pay" id="alipay"><label for="alipay"> æ”¯ä»˜å® </label>
    </div>
</div>

  
  
    <script src="/blog/lib/jquery-2.2.3.min.js"></script>
  
    <script src="/blog/lib/qrcode.min.js"></script>
  
    <script src="/blog/js/index.js"></script>
  

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</body>
</html>
