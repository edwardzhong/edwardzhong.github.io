<!doctype html>
<html lang="zh-CN">









<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <!-- ä¼˜å…ˆä½¿ç”¨ IE æœ€æ–°ç‰ˆæœ¬å’Œ Chrome -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <!-- ä¸ºç§»åŠ¨è®¾å¤‡æ·»åŠ  viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <!-- æ·»åŠ åˆ°ä¸»å±åçš„æ ‡é¢˜ï¼ˆiOS 6 æ–°å¢ï¼‰ -->
  <meta name="apple-mobile-web-app-title" content="koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹web apiç¯‡ - Jeff's world">
  <!-- æ˜¯å¦å¯ç”¨ WebApp å…¨å±æ¨¡å¼ï¼Œåˆ é™¤è‹¹æœé»˜è®¤çš„å·¥å…·æ å’Œèœå•æ  -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <!-- è®¾ç½®è‹¹æœå·¥å…·æ é¢œè‰² -->
  <meta name="apple-mobile-web-app-status-bar-style" content = "black" />
  <!-- æ·»åŠ æ™ºèƒ½ App å¹¿å‘Šæ¡ Smart App Bannerï¼ˆiOS 6+ Safariï¼‰ -->
  <!-- <meta name = "apple-itunes-app" content = "app-id=myAppStoreID, affiliate-data=myAffiliateData, app-argument=myURL"> -->
  <!-- å¿½ç•¥é¡µé¢ä¸­çš„æ•°å­—è¯†åˆ«ä¸ºç”µè¯ï¼Œå¿½ç•¥emailè¯†åˆ« -->
  <meta name="format-detection" content = "telphone=no, email=no" />
  <!--ä¸‹é¢ä¸‰ä¸ªæ˜¯æ¸…é™¤ç¼“å­˜ å¾®ä¿¡æµè§ˆå™¨ç¼“å­˜ä¸¥é‡åˆæ— åˆ·æ–°ï¼›è¿™ä¸ªæ–¹æ³•è°ƒè¯•çš„æ—¶å€™å¾ˆæ–¹ä¾¿-->
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <link rel="dns-prefetch" href="https://jeff_zhong.gitee.io/blog">
  <link rel="icon shortcut" type="image/ico" href="/favicon.ico">
  <meta name="author" content="Jeff Zhong">
  <meta name="description" content="it's a blog by hexo">
  <meta name="keywords" content="hexo theme">
  <title >koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹web apiç¯‡ - Jeff's world</title>
    <!-- The Open Graph protocol -->
  <meta property="og:url" content="https://jeff_zhong.gitee.io/blog">
  <meta property="og:type" content="blog">
  <meta property="og:title" content="koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹web apiç¯‡ - Jeff's world">
  <meta property="og:description" content="it's a blog by hexo">
  
    
    
      <link rel="stylesheet" href="/lib/fontello/fontello.css">
    
      <link rel="stylesheet" href="/lib/reboto/roboto.css">
    
      <link rel="stylesheet" href="/css/index.css">
    
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5255e97b442092b8e1a219e6a48a0d42";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Jeff's world" type="application/atom+xml">
</head>
<body>
<header class="header">
  <div class="top"></div>
  <h2>Jeff's World</h2>
  <h3>Things that I'm interested in</h3>
  <div class="menu">
  
  
  
      <a  href="/" title="ä¸» é¡µ">
        <i class="icon-home"></i>
        <span>ä¸» é¡µ</span>
      </a>
  
      <a  href="https://jeff_zhong.gitee.io/demo/" title="Demo">
        <i class="icon-page"></i>
        <span>Demo</span>
      </a>
  
      <a  data-tag="search"  href="javascript:;" title="æœ ç´¢">
        <i class="icon-search"></i>
        <span>æœ ç´¢</span>
      </a>
  
  </div>
  <div class="state">
  
    <a href="/archives">53<br>æ–‡ ç« </a><a href="/categories">2<br>åˆ† ç±»</a><a href="/tags">70<br>æ ‡ ç­¾</a>
  </div>
  <div class="social">
  
  
  
      <a href="https://github.com/edwardzhong" target="_blank" rel="noopener" title="Github"><i class="icon-github"></i></a>
  
      <a href="https://twitter.com/JianfengEdward" target="_blank" rel="noopener" title="Twitter"><i class="icon-twitter"></i></a>
  
      <a href="https://www.facebook.com/jianfeng.edward" target="_blank" rel="noopener" title="Facebook"><i class="icon-facebook"></i></a>
  
      <a href="http://weibo.com/1593251850" target="_blank" rel="noopener" title="Weibo"><i class="icon-weibo"></i></a>
  
      <a href="/atom.xml" title="Rss"><i class="icon-rss"></i></a>
  
  </div>
  <div id="payBtn" class="pay-icon" title="è°¢è°¢æ‚¨çš„èµèµ">èµ</div>
</header>
  <div class="container">
    <div class="main">
    
        
<div class="post-list">
	<article class="post" style="animation:listshow 0.6s ease-out both 0.30000000000000004s">
    
    
        
    
	
	<a href="javascript:;">
        <div class="post-banner" style="background: url(/blog/images/banner7.jpg)  center top / 100% no-repeat">
    		<h3 class="post-title">koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹web apiç¯‡</h3>
    	</div>
	</a>
	<div class="post-inner">
	
    	<div class="post-info">
    		<time><i class="icon-calendar"></i> 2019/04/08 15:50:00</time>
    		<span class="category">
    		
    			
    			<i class="icon-book"></i>
    			
                    
                        <a href="/categories/%E6%8A%80%E6%9C%AF/">æŠ€æœ¯</a>
                    
    			
    		
    		</span>
    	</div>
    	<!-- <p><p>ç›®æ ‡æ˜¯å»ºç«‹ä¸€ä¸ª web QQ çš„é¡¹ç›®ï¼Œä½¿ç”¨çš„æŠ€æœ¯æ ˆå¦‚ä¸‹ï¼š</p>
<p>åç«¯æ˜¯åŸºäº koa2 çš„ web api æœåŠ¡å±‚ï¼Œæä¾› curd æ“ä½œçš„ http æ¥å£ï¼Œç™»å½•éªŒè¯ä½¿ç”¨çš„æ˜¯ json web tokeâ€¦</p>
</p> -->
    	
    		<div class="post-content"><p>ç›®æ ‡æ˜¯å»ºç«‹ä¸€ä¸ª <strong>web QQ</strong> çš„é¡¹ç›®ï¼Œä½¿ç”¨çš„æŠ€æœ¯æ ˆå¦‚ä¸‹ï¼š</p>
<ol>
<li><p>åç«¯æ˜¯åŸºäº <strong>koa2</strong> çš„ web api æœåŠ¡å±‚ï¼Œæä¾› curd æ“ä½œçš„ http æ¥å£ï¼Œç™»å½•éªŒè¯ä½¿ç”¨çš„æ˜¯ <strong>json web token</strong>ï¼Œè·¨åŸŸæ–¹æ¡ˆä½¿ç”¨çš„æ˜¯ <strong>cors</strong>ï¼›</p>
</li>
<li><p>æ•°æ®åº“ä½¿ç”¨çš„æ˜¯ <strong>mysql</strong>ï¼›</p>
</li>
<li><p>ä¸ºäº†å®æ—¶é€šä¿¡ï¼Œä½¿ç”¨çš„æ˜¯åŸºäº websocket åè®®çš„ <strong>socket.io</strong> æ¡†æ¶ï¼›</p>
</li>
<li><p>å‰ç«¯åˆ™ä½¿ç”¨çš„æ˜¯ <strong>vue + vuex</strong>ã€‚</p>
</li>
</ol>
<a id="more"></a>

<p>æœ¬ç¯‡åˆ™è®²å™æœåŠ¡ç«¯çš„æ­å»ºï¼Œä¹‹æ‰€ä»¥ä½¿ç”¨ <strong>koa</strong>ï¼Œè€Œä¸ä½¿ç”¨å…¶ä»–å°è£…è¿‡çš„æ¡†æ¶ï¼Œæ¯”å¦‚ <strong>Egg.js</strong>, <strong>Thinkjs</strong>ã€‚å› ä¸ºåœ¨æˆ‘çœ‹æ¥, <strong>koa2</strong> å·²ç»å¤Ÿæ–¹ä¾¿ï¼Œæ’ä»¶ä¹Ÿè¶³å¤Ÿå¤šï¼Œå®Œå…¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œåƒæ­ç§¯æœ¨ä¸€æ ·æ„å»ºå‡ºæœ€é€‚åˆä¸šåŠ¡éœ€æ±‚çš„æ¡†æ¶ã€‚è¿™æ ·ä¸ä½†æ‘’å¼ƒäº†å¾ˆå¤šç”¨ä¸åˆ°çš„æ’ä»¶ï¼Œä½¿æ•´ä¸ªæ¡†æ¶æ›´åŠ ç²¾ç®€ï¼Œä¹Ÿèƒ½å¯¹æ•´ä¸ªæ¡†æ¶çŸ¥æ ¹çŸ¥åº•ï¼Œå‡å°‘äº†å¾ˆå¤šä¸å¯é¢„çŸ¥å› ç´ çš„å½±å“ã€‚</p>
<p>å½“ç„¶æˆ‘è§‰å¾—æœ€ä¸»è¦çš„æ˜¯æˆ‘æ¯”è¾ƒæ‡’ ğŸ˜„ï¼Œä¸æƒ³å†å»å­¦å…¶ä»–æ¡†æ¶ç‰¹æœ‰çš„ apiï¼Œç‰¹æœ‰çš„é…ç½®ã€‚å› ä¸ºå‰ç«¯æœ‰å¤ªå¤šæ¡†æ¶å¤ªå¤š api éœ€è¦æŒæ¡äº†ï¼Œå¯¹äºéäº’è”ç½‘å…¬è®¤çš„æŠ€æœ¯æ ‡å‡†ï¼Œæˆ‘è§‰å¾—å­¦ä¹ çš„ä¼˜å…ˆçº§è¿˜æ˜¯è¦é åä¸€ç‚¹çš„ã€‚å› ä¸ºè¿™äº›ä¸ªæ¡†æ¶ï¼Œä¸‰å¤©ä¸¤å¤´å°±å†’å‡ºä¸ªçƒ­é—¨çš„ï¼Œç®€ç›´å¤šä¸èƒœæ•°ï¼Œå­¦ä¸è¿‡æ¥å•Šï¼Œè€Œ koa åŸºæœ¬éƒ½æ˜¯è¿™äº›æ¡†æ¶çš„åº•å±‚ï¼Œæ˜æ˜¾é è°±å¤šäº†ã€‚</p>
<h2 id="åŸºæœ¬æ¡†æ¶æ­å»º"><a href="#åŸºæœ¬æ¡†æ¶æ­å»º" class="headerlink" title="åŸºæœ¬æ¡†æ¶æ­å»º"></a>åŸºæœ¬æ¡†æ¶æ­å»º</h2><p>è¿™å‡ ä¸ª koa æ’ä»¶å¤§éƒ¨åˆ†é¡¹ç›®å…«ä¹ä¸ç¦»åè¦ç”¨åˆ°ï¼š</p>
<ul>
<li>koa-body è§£æ http æ•°æ®</li>
<li>koa-compress gzip å‹ç¼©</li>
<li>koa-router è·¯ç”±</li>
<li>koa-static è®¾ç½®é™æ€ç›®å½•</li>
<li>koa2-cors è·¨åŸŸ cors</li>
<li>log4js è€ç‰Œçš„æ—¥å¿—ç»„ä»¶</li>
<li>jsonwebtoken jwt ç»„ä»¶</li>
</ul>
<h2 id="åŸºæœ¬çš„ç›®å½•ç»“æ„"><a href="#åŸºæœ¬çš„ç›®å½•ç»“æ„" class="headerlink" title="åŸºæœ¬çš„ç›®å½•ç»“æ„"></a>åŸºæœ¬çš„ç›®å½•ç»“æ„</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">public <span class="comment">#å…¬å…±ç›®å½•</span></span><br><span class="line">src    <span class="comment">#å‰ç«¯ç›®å½•</span></span><br><span class="line">server <span class="comment">#åç«¯ç›®å½•</span></span><br><span class="line">â”œâ”€â”€ common <span class="comment">#å·¥å…·</span></span><br><span class="line">â”œâ”€â”€ config <span class="comment">#é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ controller <span class="comment">#æ§åˆ¶å™¨</span></span><br><span class="line">â”œâ”€â”€ daos   <span class="comment">#æ•°æ®åº“è®¿é—®å±‚</span></span><br><span class="line">â”œâ”€â”€ logs   <span class="comment">#æ—¥å¿—ç›®å½•</span></span><br><span class="line">â”œâ”€â”€ middleware  <span class="comment">#ä¸­é—´ä»¶ç›®å½•</span></span><br><span class="line">â”œâ”€â”€ socket <span class="comment">#socketioç›®å½•</span></span><br><span class="line">â”œâ”€â”€ app.js <span class="comment">#å…¥å£æ–‡ä»¶</span></span><br><span class="line">â””â”€â”€ router.js <span class="comment">#è·¯ç”±</span></span><br></pre></td></tr></table></figure>

<h2 id="å…¥å£æ–‡ä»¶-app-js"><a href="#å…¥å£æ–‡ä»¶-app-js" class="headerlink" title="å…¥å£æ–‡ä»¶ app.js"></a>å…¥å£æ–‡ä»¶ app.js</h2><p>ä¸»è¦å°±æ˜¯å‡ ä¸ªä¸­é—´ä»¶é…ç½®éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡ŒåŒæ—¶è¿˜åŠ è½½äº† socket.io æœåŠ¡ã€‚socket.io ç›¸å…³çš„åŸºæœ¬çŸ¥è¯†ç‚¹å¯ä»¥çœ‹æˆ‘ä¹‹å‰å†™çš„æ–‡ç« <a href="https://www.cnblogs.com/edwardloveyou/p/10625152.html" target="_blank" rel="noopener">å…³äº socket.io çš„ä½¿ç”¨</a>ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> baseDir = path.normalize(__dirname + <span class="string">'/..'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// gzip</span></span><br><span class="line">app.use(</span><br><span class="line">  compress(&#123;</span><br><span class="line">    filter: <span class="function"><span class="keyword">function</span>(<span class="params">content_type</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="regexp">/text|javascript/i</span>.test(content_type);</span><br><span class="line">    &#125;,</span><br><span class="line">    threshold: <span class="number">2048</span>,</span><br><span class="line">    flush: <span class="built_in">require</span>(<span class="string">'zlib'</span>).Z_SYNC_FLUSH,</span><br><span class="line">  &#125;),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£æè¯·æ±‚</span></span><br><span class="line">app.use(</span><br><span class="line">  koaBody(&#123;</span><br><span class="line">    jsonLimit: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,</span><br><span class="line">    formLimit: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,</span><br><span class="line">    textLimit: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,</span><br><span class="line">    multipart: <span class="literal">true</span>, <span class="comment">// è§£æFormDataæ•°æ®</span></span><br><span class="line">    formidable: &#123; <span class="attr">uploadDir</span>: path.join(baseDir, <span class="string">'public/upload'</span>) &#125;, <span class="comment">//ä¸Šä¼ æ–‡ä»¶ç›®å½•</span></span><br><span class="line">  &#125;),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®é™æ€ç›®å½•</span></span><br><span class="line">app.use(<span class="keyword">static</span>(path.join(baseDir, <span class="string">'public'</span>), &#123; <span class="attr">index</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(favicon(path.join(baseDir, <span class="string">'public/favicon.ico'</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//cors</span></span><br><span class="line">app.use(</span><br><span class="line">  cors(&#123;</span><br><span class="line">    origin: <span class="string">'http://localhost:'</span> + config.clientPort,</span><br><span class="line">    credentials: <span class="literal">true</span>,</span><br><span class="line">    allowMethods: [<span class="string">'GET'</span>, <span class="string">'POST'</span>, <span class="string">'DELETE'</span>],</span><br><span class="line">    exposeHeaders: [<span class="string">'Authorization'</span>],</span><br><span class="line">    allowHeaders: [<span class="string">'Content-Type'</span>, <span class="string">'Authorization'</span>, <span class="string">'Accept'</span>],</span><br><span class="line">  &#125;),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//json-web-tokenä¸­é—´ä»¶</span></span><br><span class="line">app.use(</span><br><span class="line">  jwt(&#123;</span><br><span class="line">    secret: config.secret,</span><br><span class="line">    exp: config.exp,</span><br><span class="line">  &#125;),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç™»å½•éªŒè¯ä¸­é—´ä»¶ï¼Œexclude è¡¨ç¤ºä¸éªŒè¯çš„é¡µé¢ï¼Œinclude è¡¨ç¤ºè¦éªŒè¯çš„é¡µé¢</span></span><br><span class="line">app.use(</span><br><span class="line">  verify(&#123;</span><br><span class="line">    exclude: [<span class="string">'/login'</span>, <span class="string">'/register'</span>, <span class="string">'/search'</span>],</span><br><span class="line">  &#125;),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”™è¯¯å¤„ç†ä¸­é—´ä»¶</span></span><br><span class="line">app.use(errorHandler());</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±</span></span><br><span class="line">addRouters(router);</span><br><span class="line">app.use(router.routes()).use(router.allowedMethods());</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†404</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  log.error(<span class="string">`404 <span class="subst">$&#123;ctx.message&#125;</span> : <span class="subst">$&#123;ctx.href&#125;</span>`</span>);</span><br><span class="line">  ctx.status = <span class="number">404</span>;</span><br><span class="line">  ctx.body = &#123; <span class="attr">code</span>: <span class="number">404</span>, <span class="attr">message</span>: <span class="string">'404! not found !'</span> &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†ä¸­é—´ä»¶å’Œç³»ç»Ÿé”™è¯¯</span></span><br><span class="line">app.on(<span class="string">'error'</span>, (err, ctx) =&gt; &#123;</span><br><span class="line">  log.error(err); <span class="comment">//log all errors</span></span><br><span class="line">  ctx.status = <span class="number">500</span>;</span><br><span class="line">  ctx.statusText = <span class="string">'Internal Server Error'</span>;</span><br><span class="line">  <span class="keyword">if</span> (ctx.app.env === <span class="string">'development'</span>) &#123;</span><br><span class="line">    <span class="comment">//throw the error to frontEnd when in the develop mode</span></span><br><span class="line">    ctx.res.end(err.stack); <span class="comment">//finish the response</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ctx.body = &#123; <span class="attr">code</span>: <span class="number">-1</span>, <span class="attr">message</span>: <span class="string">'Server Error'</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">module</span>.parent) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; port, socketPort &#125; = config;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * koa app</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  app.listen(port);</span><br><span class="line">  log.info(<span class="string">`=== app server running on port <span class="subst">$&#123;port&#125;</span>===`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'app server running at: http://localhost:%d'</span>, port);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * socket.io</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  addSocket(io);</span><br><span class="line">  server.listen(socketPort);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è·¨åŸŸ-cors-å’Œ-json-web-token"><a href="#è·¨åŸŸ-cors-å’Œ-json-web-token" class="headerlink" title="è·¨åŸŸ cors å’Œ json web token"></a>è·¨åŸŸ cors å’Œ json web token</h2><p>è¿™é‡Œè§£é‡Šä¸€ä¸‹ koa-cors å‚æ•°çš„è®¾ç½®ï¼Œæˆ‘é¡¹ç›®ä½¿ç”¨çš„æ˜¯ json web tokenï¼Œéœ€è¦æŠŠè®¤è¯å­—æ®µ Authorization æ·»åŠ åˆ° headerï¼Œå‰ç«¯è·å–è¯¥ header å­—æ®µï¼Œä¹‹åç»™åå°å‘é€ http è¯·æ±‚çš„æ—¶å€™ï¼Œå†å¸¦ä¸Šè¯¥ Authorizationã€‚</p>
<ul>
<li>originï¼šå¦‚æœè¦è®¿é—® header é‡Œé¢çš„å­—æ®µæˆ–è€…è®¾ç½® cookieï¼Œè¦å†™å…·ä½“çš„åŸŸååœ°å€ï¼Œç”¨ æ˜Ÿå· * æ˜¯ä¸è¡Œçš„ï¼›</li>
<li>credentialsï¼šä¸»è¦æ˜¯ç»™å‰ç«¯è·å– cookieï¼›</li>
<li>allowMethodsï¼šå…è®¸è®¿é—®çš„æ–¹æ³•ï¼›</li>
<li>exposeHeadersï¼šå‰ç«¯å¦‚æœè¦è·å–è¯¥ header å­—æ®µï¼Œå¿…é¡»å†™æ˜ï¼ˆjson web token ç”¨ï¼‰ï¼›</li>
<li>allowHeadersï¼šæ·»åŠ åˆ° header çš„å­—æ®µï¼›</li>
</ul>
<p>è‡³äº json web token çš„åŸç†ï¼Œç½‘ä¸Šèµ„æ–™é½å…¨ï¼Œè¿™é‡Œä¸å†ä»‹ç»äº†ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.use(</span><br><span class="line">  cors(&#123;</span><br><span class="line">    origin: <span class="string">'http://localhost:'</span> + config.clientPort, <span class="comment">// è®¿é—®header,è¦å†™æ˜å…·ä½“åŸŸåæ‰è¡Œ</span></span><br><span class="line">    credentials: <span class="literal">true</span>, <span class="comment">//å°†å‡­è¯æš´éœ²å‡ºæ¥, å‰ç«¯æ‰èƒ½è·å–cookie</span></span><br><span class="line">    allowMethods: [<span class="string">'GET'</span>, <span class="string">'POST'</span>, <span class="string">'DELETE'</span>],</span><br><span class="line">    exposeHeaders: [<span class="string">'Authorization'</span>], <span class="comment">// å°†headerå­—æ®µexposeå‡ºå»</span></span><br><span class="line">    allowHeaders: [<span class="string">'Content-Type'</span>, <span class="string">'Authorization'</span>, <span class="string">'Accept'</span>], <span class="comment">// å…è®¸æ·»åŠ åˆ°headerçš„å­—æ®µ</span></span><br><span class="line">  &#125;),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="ä¸­é—´ä»¶-middleware"><a href="#ä¸­é—´ä»¶-middleware" class="headerlink" title="ä¸­é—´ä»¶ middleware"></a>ä¸­é—´ä»¶ middleware</h2><p>koa çš„ä¸­é—´ä»¶å°±æ˜¯ web å¼€å‘çš„åˆ©å™¨ï¼Œé€šè¿‡å®ƒå¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç° å¼ºç±»å‹è¯­è¨€ä¸­çš„ <strong>aop</strong> åˆ‡é¢ç¼–ç¨‹ï¼Œè€Œ koa2 ä¸­é—´ä»¶ çš„ç¼–å†™ä¹Ÿè¶³å¤Ÿç®€å• <a href="http://koajs.cn/" target="_blank" rel="noopener">koajs</a>ã€‚</p>
<p>é¡¹ç›®åœ¨ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹éƒ½ç”¨ä¸­é—´ä»¶è¿›è¡Œäº†å°è£…ï¼Œå¾ˆå¤šé‡å¤çš„æ ·æ¿ä»£ç å› æ­¤å¾—ä»¥ç®€åŒ–ã€‚</p>
<ul>
<li>json web tokenï¼ˆjwtï¼‰</li>
<li>ç™»å½•éªŒè¯ï¼ˆverifyï¼‰</li>
<li>é”™è¯¯å¤„ç†ï¼ˆerrorHandlerï¼‰</li>
</ul>
<p>å°±ä»¥æœ€ç®€å•çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶ä¸ºä¾‹å­ï¼Œå¦‚æœä¸ä½¿ç”¨é”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬éœ€è¦æ¯ä¸ªæ§åˆ¶å™¨æ–¹æ³•è¿›è¡Œ <strong>try{â€¦} catch{â€¦}</strong> ï¼Œå…¶ä»–ä¸­é—´ä»¶ç¼–å†™æ–¹å¼ç±»ä¼¼ï¼Œå°±ä¸å†ä»‹ç»ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * error handler ä¸­é—´ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> next(); <span class="comment">//æ²¡æœ‰é”™è¯¯åˆ™è¿›å…¥ä¸‹ä¸€ä¸ªä¸­é—´ä»¶</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      log.error(err);</span><br><span class="line">      <span class="keyword">let</span> obj = &#123;</span><br><span class="line">        code: <span class="number">-1</span>,</span><br><span class="line">        message: <span class="string">'æœåŠ¡å™¨é”™è¯¯'</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">if</span> (ctx.app.env === <span class="string">'development'</span>) &#123;</span><br><span class="line">        obj.err = err;</span><br><span class="line">      &#125;</span><br><span class="line">      ctx.body = obj;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§åˆ¶å™¨ä»£ç ä½¿ç”¨error handlerä¸­é—´ä»¶åï¼Œæ¯ä¸ªæ–¹æ³•éƒ½ä¸éœ€è¦ try catchå¤„ç†é”™è¯¯ï¼Œè®°å½•é”™è¯¯æ—¥å¿—ï¼Œå¤„ç†é€»è¾‘éƒ½é›†ä¸­åœ¨ä¸­é—´ä»¶é‡Œé¢äº†ã€‚</span></span><br><span class="line">exports.getInfo = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// try &#123;</span></span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">await</span> ctx.verify();</span><br><span class="line">  <span class="keyword">const</span> [users, friends] = <span class="keyword">await</span> <span class="built_in">Promise</span>.all([userDao.getUser(&#123; <span class="attr">id</span>: token.uid &#125;), getFriends([token.uid])]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> msgs = applys.map(formatTime);</span><br><span class="line">  ctx.body = &#123;</span><br><span class="line">    code: <span class="number">0</span>,</span><br><span class="line">    message: <span class="string">'å¥½å‹åˆ—è¡¨'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      user: users[<span class="number">0</span>],</span><br><span class="line">      friends: mergeReads(friends, reads),</span><br><span class="line">      groups,</span><br><span class="line">      msgs,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// &#125; catch (err) &#123;</span></span><br><span class="line">  <span class="comment">//     log.error(err);</span></span><br><span class="line">  <span class="comment">//     let obj = &#123;</span></span><br><span class="line">  <span class="comment">//         code: -1,</span></span><br><span class="line">  <span class="comment">//         message: "æœåŠ¡å™¨é”™è¯¯"</span></span><br><span class="line">  <span class="comment">//     &#125;;</span></span><br><span class="line">  <span class="comment">//     if (ctx.app.env === "development") &#123;</span></span><br><span class="line">  <span class="comment">//         obj.err = err;</span></span><br><span class="line">  <span class="comment">//     &#125;</span></span><br><span class="line">  <span class="comment">//     ctx.body = obj;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="è·¯ç”±é…ç½®"><a href="#è·¯ç”±é…ç½®" class="headerlink" title="è·¯ç”±é…ç½®"></a>è·¯ç”±é…ç½®</h2><p>è·¯ç”±é…ç½®åªä½¿ç”¨äº† getï¼Œpost æ–¹æ³•ï¼Œå½“ç„¶è¦ä½¿ç”¨ putï¼Œdelete ä¹Ÿåªæ˜¯æ”¹ä¸€ä¸‹åå­—å°±è¡Œã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// router.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; uploadFile &#125; = <span class="built_in">require</span>(<span class="string">'./controller/file'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; login, register &#125; = <span class="built_in">require</span>(<span class="string">'./controller/sign'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; addGroup, delGroup, updateGroup &#125; = <span class="built_in">require</span>(<span class="string">'./controller/group'</span>);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">router</span>) </span>&#123;</span><br><span class="line">  router</span><br><span class="line">    .post(<span class="string">'/login'</span>, login)</span><br><span class="line">    .post(<span class="string">'/register'</span>, register)</span><br><span class="line">    .post(<span class="string">'/upload'</span>, uploadFile)</span><br><span class="line">    .post(<span class="string">'/addgroup'</span>, addGroup)</span><br><span class="line">    .post(<span class="string">'/delgroup'</span>, delGroup)</span><br><span class="line">    .post(<span class="string">'/updategroup'</span>, updateGroup);</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="æ§åˆ¶å™¨"><a href="#æ§åˆ¶å™¨" class="headerlink" title="æ§åˆ¶å™¨"></a>æ§åˆ¶å™¨</h2><p>ä»¥ updateInfo æ–¹æ³•ä¸ºä¾‹ï¼Œkoa2 å·²ç»å…¨é¢æ”¯æŒ <strong>async await</strong>ï¼Œç¼–å†™æ–¹å¼å’ŒåŒæ­¥ä»£ç æ²¡å¤šå¤§åŒºåˆ«ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">exports.updateInfo = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> form = ctx.request.body;</span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">await</span> ctx.verify();</span><br><span class="line">  <span class="keyword">const</span> ret = <span class="keyword">await</span> userDao.update([form, token.uid]);</span><br><span class="line">  <span class="keyword">if</span> (!ret.affectedRows) &#123;</span><br><span class="line">    <span class="keyword">return</span> (ctx.body = &#123;</span><br><span class="line">      code: <span class="number">2</span>,</span><br><span class="line">      message: <span class="string">'æ›´æ–°å¤±è´¥'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.body = &#123;</span><br><span class="line">    code: <span class="number">0</span>,</span><br><span class="line">    message: <span class="string">'æ›´æ–°æˆåŠŸ'</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>æ¥ç€ä¸‹ä¸€ç¼–å°±æ˜¯åŸºäº mysql æ„å»º æ•°æ®åº“è®¿é—®å±‚ã€‚</p>
</div>
    	
		<div class="post-footer">
			<div class="tags">
				<i class="icon-tags"></i> 
				
					
					
						
							<a href="/tags/node/">node</a>
						
					
						
							<a href="/tags/koa/">koa</a>
						
					
						
							<a href="/tags/jwt/">jwt</a>
						
					
				
			</div>
			<a class="share" href="javascript:;" data-url="/2019/04/08/fullstack/" data-desc="ç›®æ ‡æ˜¯å»ºç«‹ä¸€ä¸ª web QQ çš„é¡¹ç›®ï¼Œä½¿ç”¨çš„æŠ€æœ¯æ ˆå¦‚ä¸‹ï¼š

åç«¯æ˜¯åŸºäº koa2 çš„ web ..." data-type="share" title="share"><i class="icon-share"></i></a>
		</div>
	</div>
</article>
</div>
<nav class="pagination clearfix">
  
    
      
        <a href="/2019/04/12/fullstack2/" class="prev post-prev"> <i class="icon-leftarrow"></i> koa+mysql+vue+soc...</a>
      

      
        <a href="/2019/03/29/socketio/" class="next post-next"> å…³äºsocket.ioçš„ä½¿ç”¨ <i class="icon-rightarrow"></i></a>
      
    
  
</nav>

<div class="wxshare-popup">
    <a class="close" href="javascript:;"></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div id="qrcode" class="wx-qrcode"></div>
</div>

    
    <footer class="footer">
<p class="theme">
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/edwardzhong/simply.git" target="_blank" rel="noopener">simply</a>
</p>
<p class="copy">Copyright &copy; 2025 Jeff Zhong</p>
</footer>
    <div class="top-bottom">
      <div class="to-top hide" title="to top"><i class="icon-up"></i></div>
      <div class="to-bottom hide" title="to bottom"><i class="icon-down"></i></div>
    </div>
    </div>

  </div>
<input type="hidden" name="isPost" id="isPost" value="true">
<i id="barBtn" class="icon icon-menu"></i>
<div id="payMe" class="payme">
    <i class="icon icon-cancel"></i>
    <p class="pay-title">ç»™æˆ‘çš„æ—©é¤åŠ ä¸ªè›‹å§ ğŸ˜Š</p>
    <div>
      <img src="/images/weixinpay.jpg" alt="weixinpay">
      <img src="/images/alipay.jpg" alt="alipay" style="display:none;">
    </div>
    <div class="pay-selects">
        <input type="radio" name="pay" id="weixinpay" checked="checked"><label for="weixinpay"> å¾®ä¿¡ </label>&nbsp;&nbsp;
        <input type="radio" name="pay" id="alipay"><label for="alipay"> æ”¯ä»˜å® </label>
    </div>
</div>

  
  
    <script src="/lib/jquery-2.2.3.min.js"></script>
  
    <script src="/lib/qrcode.min.js"></script>
  
    <script src="/js/index.js"></script>
  

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</body>
</html>
