<!doctype html>
<html lang="zh-CN">









<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <!-- 优先使用 IE 最新版本和 Chrome -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <!-- 为移动设备添加 viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <!-- 添加到主屏后的标题（iOS 6 新增） -->
  <meta name="apple-mobile-web-app-title" content="WebGL学习之法线贴图 - Jeff's world">
  <!-- 是否启用 WebApp 全屏模式，删除苹果默认的工具栏和菜单栏 -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <!-- 设置苹果工具栏颜色 -->
  <meta name="apple-mobile-web-app-status-bar-style" content = "black" />
  <!-- 添加智能 App 广告条 Smart App Banner（iOS 6+ Safari） -->
  <!-- <meta name = "apple-itunes-app" content = "app-id=myAppStoreID, affiliate-data=myAffiliateData, app-argument=myURL"> -->
  <!-- 忽略页面中的数字识别为电话，忽略email识别 -->
  <meta name="format-detection" content = "telphone=no, email=no" />
  <!--下面三个是清除缓存 微信浏览器缓存严重又无刷新；这个方法调试的时候很方便-->
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <link rel="dns-prefetch" href="https://edwardzhong.github.io">
  <link rel="icon shortcut" type="image/ico" href="/favicon.ico">
  <meta name="author" content="Jeff Zhong">
  <meta name="description" content="it's a blog by hexo">
  <meta name="keywords" content="hexo theme">
  <title >WebGL学习之法线贴图 - Jeff's world</title>
    <!-- The Open Graph protocol -->
  <meta property="og:url" content="https://edwardzhong.github.io">
  <meta property="og:type" content="blog">
  <meta property="og:title" content="WebGL学习之法线贴图 - Jeff's world">
  <meta property="og:description" content="it's a blog by hexo">
  
    
    
      <link rel="stylesheet" href="/lib/fontello/fontello.css">
    
      <link rel="stylesheet" href="/lib/reboto/roboto.css">
    
      <link rel="stylesheet" href="/css/index.css">
    
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5255e97b442092b8e1a219e6a48a0d42";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Jeff's world" type="application/atom+xml">
</head>
<body>
<header class="header">
  <div class="top"></div>
  <h2>Jeff's World</h2>
  <h3>Things that I'm interested in</h3>
  <div class="menu">
  
  
  
      <a  href="/" title="主 页">
        <i class="icon-home"></i>
        <span>主 页</span>
      </a>
  
      <a  href="/sites/demo/" title="Demo">
        <i class="icon-page"></i>
        <span>Demo</span>
      </a>
  
      <a  data-tag="search"  href="javascript:;" title="搜 索">
        <i class="icon-search"></i>
        <span>搜 索</span>
      </a>
  
  </div>
  <div class="state">
  
    <a href="/archives">40<br>文 章</a><a href="/categories">2<br>分 类</a><a href="/tags">58<br>标 签</a>
  </div>
  <div class="social">
  
  
  
      <a href="https://github.com/edwardzhong" target="_blank" rel="noopener" title="Github"><i class="icon-github"></i></a>
  
      <a href="https://twitter.com/JianfengEdward" target="_blank" rel="noopener" title="Twitter"><i class="icon-twitter"></i></a>
  
      <a href="https://www.facebook.com/jianfeng.edward" target="_blank" rel="noopener" title="Facebook"><i class="icon-facebook"></i></a>
  
      <a href="http://weibo.com/1593251850" target="_blank" rel="noopener" title="Weibo"><i class="icon-weibo"></i></a>
  
      <a href="/atom.xml" title="Rss"><i class="icon-rss"></i></a>
  
  </div>
  <div id="payBtn" class="pay-icon" title="谢谢您的赞赏">赏</div>
</header>
  <div class="container">
    <div class="main">
    
        
<div class="post-list">
	<article class="post" style="animation:listshow 0.6s ease-out both 0.30000000000000004s">
    
    
        
    
	
	<a href="javascript:;">
        <div class="post-banner" style="background: url(/images/banner5.jpg)  center top / 100% no-repeat">
    		<h3 class="post-title">WebGL学习之法线贴图</h3>
    	</div>
	</a>
	<div class="post-inner">
	
    	<div class="post-info">
    		<time><i class="icon-calendar"></i> 2019/04/30 11:07:00</time>
    		<span class="category">
    		
    			
    			<i class="icon-book"></i>
    			
                    
                        <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
                    
    			
    		
    		</span>
    	</div>
    	<!-- <p><p>实际效果请看demo：纹理贴图</p>
<p>为了增加额外细节，提升真实感，我们使用了漫反射贴图和高光贴图，它们都是向三角形进行附加纹理。但是从光的视角来看是表面法线向量使表面被视为平坦光滑的表面。以光照…</p>
</p> -->
    	
    		<div class="post-content"><p>实际效果请看demo：<strong><a href="https://edwardzhong.github.io/sites/demo/dist/webglTexture.html">纹理贴图</a></strong></p>
<img src="https://upload-images.jianshu.io/upload_images/127924-a2003e57ddd79184.png" width="400" alt="法线贴图">

<p>为了增加额外细节，提升真实感，我们使用了漫反射贴图和高光贴图，它们都是向三角形进行附加纹理。但是从光的视角来看是表面法线向量使表面被视为平坦光滑的表面。以光照算法的视角考虑的话，只有一件事决定物体的形状，那就是垂直于它的法线向量。砖块表面只有一个法向量，表面完全根据这个法向量被以一致的方式照亮。如果每个片元都用不同的法线会怎样？这样我们就可以根据表面细微的细节对法线向量进行改变；这样就会获得一种表面看起来要复杂得多的幻觉：<br><img src="https://upload-images.jianshu.io/upload_images/127924-91a0ac5e7a16904f.png" alt="表面法线"></p>
<a id="more"></a>
<p>每个片元使用了自己的法线，我们就可以让光照相信一个表面由很多微小的（垂直于法线向量的）平面所组成，物体表面的细节将会得到极大提升。这种每个片元使用各自的法线，替代一个面上所有片元使用同一个法线的技术叫做法线贴图（normal mapping）或凹凸贴图（bump mapping）。</p>
<p>以上都是从 LearnOpenGL CN 相关的文章摘抄 <strong><a href="https://learnopengl-cn.github.io/05%20Advanced%20Lighting/04%20Normal%20Mapping/" target="_blank" rel="noopener">法线贴图</a></strong>。没办法，WebGL相关比较深入的知识你只能去看openGL，好在原理基本相同，WebGL1就是基于openGL es 2.0，WebGL2就是基于openGL es 3.0。</p>
<h2 id="法线贴图"><a href="#法线贴图" class="headerlink" title="法线贴图"></a>法线贴图</h2><p>法线贴图就是用纹理中的颜色向量r、g、b存储法线向量的x、y、z。不过它们有另外的称呼：t (切线)、b (副切线)、n (法线)，它们组成了一个切线空间，被称为TBN坐标系。由于颜色与方向的表示范围有区别，颜色范围是[0,1]，而作为表示位置方向的TBN坐标系则是[-1,1]，那么从法线贴图取出来的值要使用的话，得进行转换。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将法线向量转换为范围[-1,1]</span></span><br><span class="line">vec3 normal = normalize(normal * <span class="number">2.0</span> - <span class="number">1.0</span>);</span><br></pre></td></tr></table></figure>

<p>法线贴图偏蓝是因为所有法线的指向都偏向z轴（0, 0, 1）， 对应于rgb 中的 blue分量，也就是蓝色。法线向量从z轴方向向其他方向轻微偏移，于是颜色也就发生轻微变化，这样看起来便有了一种深度。例如，你可以看到顶部颜色倾向于偏绿，这是因为顶部的法线偏向于指向正y轴方向（0, 1, 0）对应于rgb总的 green分量，也就是绿色。<br><img src="https://upload-images.jianshu.io/upload_images/127924-31c207a874927a96.png" width="400" alt="法线贴图颜色"></p>
<p>法线贴图的优点是可以用一个低精度模型表现出非常高的细节，看起来像高精度模型那样。<br><img src="https://upload-images.jianshu.io/upload_images/127924-2cb177969bbac3e9.png" alt="高精度模型"></p>
<p>只需要500个三角形的简单网格加上法线贴图就能达到媲美4M个三角形的精细网格模型的效果，可以说法线贴图优势巨大，处理4M个三角形的复杂度简直不可想象。</p>
<p>但法线贴图也不是万能的，它也有缺点。因为它只是改变了物体表面的光照计算方式，所以不适合用在凹凸起伏较大的物体上，这些物体会有遮挡的效果，法线贴图是无法实现的。</p>
<p>而文章 <strong><a href="https://learnopengl-cn.github.io/05%20Advanced%20Lighting/04%20Normal%20Mapping/" target="_blank" rel="noopener">法线贴图</a></strong> 里面有很详细的原理讲解和切线推导过程，最后求出如下的公式，我这里也不再叙述了。<br><img src="https://upload-images.jianshu.io/upload_images/127924-69ffbf23bd54803f.png" alt="公式"></p>
<h2 id="着色器"><a href="#着色器" class="headerlink" title="着色器"></a>着色器</h2><p>我这里使用了另外一种更加方便的算法，能达到同样的效果，原理就是使用导数(dFdx/dFdy)求出每个像素在插值化传值过来的点的变化率当成一个法线，请看函数 <strong>dHdxy_fwd</strong>。然后再通过与当前平面的法向量进行叉积 (cross)，即可求得同时垂直于这两个方向的法向量，请看函数 <strong>perturbNormalArb</strong>，而最终的这个法向量就是我们所要求的值，非常地高明。下面是glsl 内置的几个关键函数。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">dFdx(p) <span class="comment">//在x方向的偏导数</span></span><br><span class="line">dFdy(p) <span class="comment">//在y方向的偏导数</span></span><br><span class="line">cross(p0,p1) <span class="comment">//向量p0,p1的叉乘</span></span><br></pre></td></tr></table></figure>

<p>我们用到的求导函数 dFdx / dFdy，在WebGL1是需要开启扩展的，顶点着色器无需变动，主要变动的是片元着色器。具体的计算过程，请看如下片元着色器代码：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#extension GL_OES_standard_derivatives : enable<span class="comment">// 注意要开启该扩展</span></span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">uniform sampler2D u_diffMap;</span><br><span class="line">uniform sampler2D u_specMap;</span><br><span class="line">uniform sampler2D u_normMap;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="function">vec2 <span class="title">dHdxy_fwd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec2 dSTdx = dFdx( v_texcoord );</span><br><span class="line">    vec2 dSTdy = dFdy( v_texcoord );</span><br><span class="line">    <span class="keyword">float</span> Hll = bumpScale * texture2D( u_normMap, v_texcoord ).x;</span><br><span class="line">    <span class="keyword">float</span> dBx = bumpScale * texture2D( u_normMap, v_texcoord + dSTdx ).x - Hll;</span><br><span class="line">    <span class="keyword">float</span> dBy = bumpScale * texture2D( u_normMap, v_texcoord + dSTdy ).x - Hll;</span><br><span class="line">    <span class="keyword">return</span> vec2( dBx, dBy );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">vec3 <span class="title">perturbNormalArb</span><span class="params">( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy )</span> </span>&#123;</span><br><span class="line">    vec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );</span><br><span class="line">    vec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );</span><br><span class="line">    vec3 vN = surf_norm;</span><br><span class="line">    vec3 R1 = cross( vSigmaY, vN );</span><br><span class="line">    vec3 R2 = cross( vN, vSigmaX );</span><br><span class="line">    <span class="keyword">float</span> fDet = dot( vSigmaX, R1 );</span><br><span class="line">    fDet *= ( <span class="keyword">float</span>( gl_FrontFacing ) * <span class="number">2.0</span> - <span class="number">1.0</span> );</span><br><span class="line">    vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );</span><br><span class="line">    <span class="keyword">return</span> normalize( <span class="built_in">abs</span>( fDet ) * surf_norm - vGrad );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">// 从法线贴图计算出逐像素法线向量</span></span><br><span class="line">vec3 normal = perturbNormalArb( -v_position, normal, dHdxy_fwd());</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">// 总的光照</span></span><br><span class="line">gl_FragColor = vec4(ambient + diffuse + specular, diffuseColor.a);</span><br></pre></td></tr></table></figure>

<p>最后效果请看demo：<strong><a href="https://edwardzhong.github.io/sites/demo/dist/webglTexture.html">纹理贴图</a></strong></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>相关资料 <strong><a href="https://learnopengl-cn.github.io/" target="_blank" rel="noopener">LearnOpenGL CN</a></strong></p>
</div>
    	
		<div class="post-footer">
			<div class="tags">
				<i class="icon-tags"></i> 
				
					
					
						
							<a href="/tags/%E5%89%8D%E7%AB%AF/">前端</a>
						
					
						
							<a href="/tags/js/">js</a>
						
					
						
							<a href="/tags/webGL/">webGL</a>
						
					
				
			</div>
			<a class="share" href="javascript:;" data-url="/2019/04/30/webglnormap/" data-desc="实际效果请看demo：纹理贴图


为了增加额外细节，提升真实感，我们使用了漫反射贴图和高光贴..." data-type="share" title="share"><i class="icon-share"></i></a>
		</div>
	</div>
</article>
</div>
<nav class="pagination clearfix">
  
    
      
        <a href="/2019/05/02/webglalpha/" class="prev post-prev"> <i class="icon-leftarrow"></i> WebGL半透明物体的绘制</a>
      

      
        <a href="/2019/04/29/webgltexture/" class="next post-next"> WebGL学习之纹理贴图 <i class="icon-rightarrow"></i></a>
      
    
  
</nav>

<div class="wxshare-popup">
    <a class="close" href="javascript:;"></a>
    <p>扫一扫，分享到微信</p>
    <div id="qrcode" class="wx-qrcode"></div>
</div>

    
    <footer class="footer">
<p class="theme">
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/edwardzhong/simply.git" target="_blank" rel="noopener">simply</a>
</p>
<p class="copy">Copyright &copy; 2020 Jeff Zhong</p>
</footer>
    <div class="top-bottom">
      <div class="to-top hide" title="to top"><i class="icon-up"></i></div>
      <div class="to-bottom hide" title="to bottom"><i class="icon-down"></i></div>
    </div>
    </div>

  </div>
<input type="hidden" name="isPost" id="isPost" value="true">
<i id="barBtn" class="icon icon-menu"></i>
<div id="payMe" class="payme">
    <i class="icon icon-cancel"></i>
    <p class="pay-title">给我的早餐加个蛋吧 😊</p>
    <div>
      <img src="/images/weixinpay.jpg" alt="weixinpay">
      <img src="/images/alipay.jpg" alt="alipay" style="display:none;">
    </div>
    <div class="pay-selects">
        <input type="radio" name="pay" id="weixinpay" checked="checked"><label for="weixinpay"> 微信 </label>&nbsp;&nbsp;
        <input type="radio" name="pay" id="alipay"><label for="alipay"> 支付宝 </label>
    </div>
</div>

  
  
    <script src="/lib/jquery-2.2.3.min.js"></script>
  
    <script src="/lib/qrcode.min.js"></script>
  
    <script src="/js/index.js"></script>
  

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</body>
</html>
