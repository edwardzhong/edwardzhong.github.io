<!doctype html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <!-- 优先使用 IE 最新版本和 Chrome -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!-- 为移动设备添加 viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <!-- 添加到主屏后的标题（iOS 6 新增） -->
  <meta name="apple-mobile-web-app-title" content="koa+mysql+vue+socket.io全栈开发之前端篇 - Jeff's world">
  <!-- 是否启用 WebApp 全屏模式，删除苹果默认的工具栏和菜单栏 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- 设置苹果工具栏颜色 -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <!-- 添加智能 App 广告条 Smart App Banner（iOS 6+ Safari） -->
  <!-- <meta name = "apple-itunes-app" content = "app-id=myAppStoreID, affiliate-data=myAffiliateData, app-argument=myURL"> -->
  <!-- 忽略页面中的数字识别为电话，忽略email识别 -->
  <meta name="format-detection" content="telphone=no, email=no">
  <!--下面三个是清除缓存 微信浏览器缓存严重又无刷新；这个方法调试的时候很方便-->
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <link rel="dns-prefetch" href="http://jeffzhong.space">
  <link rel="icon shortcut" type="image/ico" href="/favicon.ico">
  <meta name="author" content="Jeff Zhong">
  <meta name="description" content="it's a blog by hexo">
  <meta name="keywords" content="hexo theme">
  <title>koa+mysql+vue+socket.io全栈开发之前端篇 - Jeff's world</title>
    <!-- The Open Graph protocol -->
  <meta property="og:url" content="http://jeffzhong.space">
  <meta property="og:type" content="blog">
  <meta property="og:title" content="koa+mysql+vue+socket.io全栈开发之前端篇 - Jeff's world">
  <meta property="og:description" content="it's a blog by hexo">
  <!-- UC Browser Compatible -->
<!--   <script>
      var agent = navigator.userAgent.toLowerCase();
      if(agent.indexOf('ucbrowser')>0) {
          alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
      }
  </script> -->
  
    
    
      <link rel="stylesheet" href="/lib/fontello/fontello.css?t=1">
    
      <link rel="stylesheet" href="/lib/reboto/roboto.css?t=1">
    
      <link rel="stylesheet" href="/dist/css/index.css?t=1">
    
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5255e97b442092b8e1a219e6a48a0d42";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>
<header class="header">
  <div class="top"></div>
  <h2>Jeff's World</h2>
  <h3>Things that I'm interested in</h3>
  <div class="menu">
  
  
  
      <a href="/">
        <i class="icon icon-home"></i>
        主页
      </a>
  
      <a href="http://jeffzhong.space/sites/demo/">
        <i class="icon icon-tag"></i>
        Demo
      </a>
  
      <a data-tag="search" href="javascript:;">
        <i class="icon icon-search"></i>
        搜索
      </a>
  
  </div>
  <div class="state">
  
    <a href="/archives">40<br>文章</a><a href="/categories">2<br>分类</a><a href="/tags">58<br>标签</a>
  </div>
  <div class="social">
  
  
  
      <a href="https://github.com/edwardzhong" title="Github"><i class="icon icon-github-circled"></i></a>
  
      <a href="https://twitter.com/JianfengEdward" title="Twitter"><i class="icon icon-twitter"></i></a>
  
      <a href="https://www.facebook.com/jianfeng.edward" title="Facebook"><i class="icon icon-facebook"></i></a>
  
      <a href="http://weibo.com/1593251850" title="Weibo"><i class="icon icon-weibo"></i></a>
  
      <a href="/atom.xml" title="Rss"><i class="icon icon-rss"></i></a>
  
  </div>
  <div id="payBtn" class="pay-icon" title="谢谢您的赞赏">赏</div>
</header>
  <div class="container">
    <div class="main">
    
        
<div class="post-list">
	<article class="post" style="animation:listshow 0.6s ease-out both 0.30000000000000004s">
    
    
        
    
	
	<a href="javascript:;">
        <div class="post-banner" style="background: url(https://upload-images.jianshu.io/upload_images/127924-85f6e78cffe1c63c.jpg)  center top / 100% no-repeat">
    		<h3 class="post-title">koa+mysql+vue+socket.io全栈开发之前端篇</h3>
    	</div>
	</a>
	<div class="post-inner">
	
    	<div class="post-info">
    		<time class="icon icon-calendar"> 2019/04/13 13:43:00</time>
    		<span class="category">
    		
    			
    			<i class="icon icon-book"></i>
    			
                    
                        <a href="/categories/技术/">技术</a>
                    
        			
    			
    		
    		</span>
    	</div>
    	<!-- <p><p>React 与 Vue 之间的对比，是前端的一大热门话题。</p>
<p>vue 简易上手的脚手架，以及官方提供必备的基础组件，比如 vuex，vue-router，对新手真的比较友好；react 则把这些…</p>
</p> -->
    	
    	<div class="post-content"><p><strong>React</strong> 与 <strong>Vue</strong> 之间的对比，是前端的一大热门话题。</p>
<ul>
<li><p><strong>vue</strong> 简易上手的脚手架，以及官方提供必备的基础组件，比如 <strong>vuex</strong>，<strong>vue-router</strong>，对新手真的比较友好；<strong>react</strong> 则把这些都交给社区去做，虽然这壮大了 <strong>react</strong>  的生态链，但新手要弄出一套趁手的方案挺麻烦的，不过好在现在有很多类似 dva的方案了。</p>
</li>
<li><p><strong>vue</strong> 比较讨喜的一点，就是它的数据双向流动在表单开发时特别方便，而 <strong>react</strong> 在这方面可就麻烦多了。</p>
</li>
<li><p>但是 <strong>vue</strong> 复杂的 api ，简直让人头大，光是文档说明都几十页了。太多的语法，太多的魔法符号，对进化速度越来越快的前端届来说，就是入手这个框架的最大阻碍。</p>
</li>
<li><p>而相反 <strong>react</strong> 的 api 数量简直可以忽略不计了，顶多花几小时就能看完官方文档。你只要理解 <strong>JavaScript</strong>，就能理解 <strong>react</strong> 的很多行为。<strong>react</strong> 的很多用法，它的 api 都是符合直觉的，你对它用法的猜测基本都是八九不离十的，这真是大大降低了心智负担。</p>
</li>
<li><p>除此之外，<strong>react</strong> 的 <strong>jsx</strong> 语法表达能力更强，还有 <strong>hoc</strong> 和 <strong>hooks</strong> 使代码也更容易组织和复用。</p>
</li>
</ul>
<p>虽然我更喜欢 <strong>React</strong> ，但工作上的需求，还不是要你用什么你就得用什么😂，所以这个 demo 就当是探索 <strong>Vue</strong> 的前奏。</p>
<a id="more"></a>
<p>之前我还是有用过 <strong>vue</strong> 的，记得还是 1.0 版本，当时的潮流就是类似 <strong>angular</strong> 1.x 的 <strong>mvvm</strong> 方案，数据双向流动。那时的 <strong>vue</strong> 远没有现在的热度，组件也少，没有 <strong>vue-router</strong>，没有 <strong>vuex</strong>，组件之前的通信简直太痛苦了。现在 <strong>vue</strong> 2.x 比起之前，已经发生了天翻地覆的变化，<strong>vue</strong> 也在不断向 <strong>react</strong> 靠拢，而我也只能从头开始学起。</p>
<p>闲话说得有点多，还是赶紧进入主题吧</p>
<h2 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h2><p>选择 webpack 4 打包和管理，template 引擎使用 pug ，css 预编译是 scss。</p>
<h4 id="webpack-common-js-的配置"><a href="#webpack-common-js-的配置" class="headerlink" title="webpack.common.js 的配置"></a>webpack.common.js 的配置</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// webpack.common.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: <span class="string">'./src/main.js'</span>,</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'[name]-[hash].js'</span><span class="comment">//输出文件添加hash</span></span><br><span class="line">    &#125;,</span><br><span class="line">    optimization: &#123; <span class="comment">// 代替commonchunk, 代码分割</span></span><br><span class="line">        runtimeChunk: <span class="string">'single'</span>,</span><br><span class="line">        splitChunks: &#123;</span><br><span class="line">            cacheGroups: &#123;</span><br><span class="line">                vendor: &#123;</span><br><span class="line">                    test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">                    name: <span class="string">'vendors'</span>,</span><br><span class="line">                    chunks: <span class="string">'all'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test:<span class="regexp">/\.vue$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                use:[<span class="string">'vue-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js?$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                use: [<span class="string">'babel-loader'</span>]<span class="comment">//'eslint-loader'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.pug$/</span>,</span><br><span class="line">                use: [<span class="string">'pug-plain-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                use: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">                use: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>, <span class="string">'postcss-loader'</span>, <span class="string">'sass-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;   </span><br><span class="line">                test: <span class="regexp">/\.(png|jpg|jpeg|gif|eot|ttf|woff|woff2|svg|svgz)(\?.+)?$/</span>,</span><br><span class="line">                use: [&#123;</span><br><span class="line">                    loader: <span class="string">'url-loader'</span>,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        limit: <span class="number">1000</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> VueLoaderPlugin(),</span><br><span class="line">        <span class="keyword">new</span> CleanWebpackPlugin([resolve(__dirname, <span class="string">'dist'</span>)]),<span class="comment">//生成新文件时，清空生出目录</span></span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">            template: <span class="string">'./public/index.html'</span>,<span class="comment">//模版路径</span></span><br><span class="line">            filename: <span class="string">'index.html'</span>,<span class="comment">//生成后的文件名,默认index.html</span></span><br><span class="line">            favicon: <span class="string">'./public/favicon.ico'</span>,</span><br><span class="line">            minify: &#123;</span><br><span class="line">                removeAttributeQuotes:<span class="literal">true</span>,</span><br><span class="line">                removeComments: <span class="literal">true</span>,</span><br><span class="line">                collapseWhitespace: <span class="literal">true</span>,</span><br><span class="line">                removeScriptTypeAttributes:<span class="literal">true</span>,</span><br><span class="line">                removeStyleLinkTypeAttributes:<span class="literal">true</span></span><br><span class="line">             &#125;</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> HotModuleReplacementPlugin()<span class="comment">//HMR</span></span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="webpack-dev-js-的配置"><a href="#webpack-dev-js-的配置" class="headerlink" title="webpack.dev.js 的配置"></a>webpack.dev.js 的配置</h4><p>就是开发服务器 devServer的配置，监控代码变更。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// webpack.dev.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = merge(common, &#123;</span><br><span class="line">    mode: <span class="string">'development'</span>,</span><br><span class="line">    devtool: <span class="string">'inline-source-map'</span>,</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        contentBase: <span class="string">'./dist'</span>,</span><br><span class="line">        index:<span class="string">'index.html'</span>,</span><br><span class="line">        port: <span class="number">3002</span>,</span><br><span class="line">        compress: <span class="literal">true</span>,</span><br><span class="line">        historyApiFallback: <span class="literal">true</span>,</span><br><span class="line">        hot: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="babel-config-js-的配置"><a href="#babel-config-js-的配置" class="headerlink" title="babel.config.js 的配置"></a>babel.config.js 的配置</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  presets: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'@vue/app'</span>, &#123;</span><br><span class="line">        <span class="string">"useBuiltIns"</span>: <span class="string">"entry"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">public <span class="comment">#公共目录</span></span><br><span class="line">server <span class="comment">#后端目录</span></span><br><span class="line">src    <span class="comment">#前端目录</span></span><br><span class="line">├── assets <span class="comment">#静态文件目录</span></span><br><span class="line">├── common <span class="comment">#工具目录</span></span><br><span class="line">├── components <span class="comment">#组件目录</span></span><br><span class="line">├── store   <span class="comment"># vuex store目录</span></span><br><span class="line">├── App.vue <span class="comment"># 根组件</span></span><br><span class="line">├── main.js <span class="comment"># 入口文件</span></span><br><span class="line">└── router.js <span class="comment">#路由</span></span><br></pre></td></tr></table></figure>
<h2 id="入口和路由"><a href="#入口和路由" class="headerlink" title="入口和路由"></a>入口和路由</h2><h4 id="路由文件"><a href="#路由文件" class="headerlink" title="路由文件"></a>路由文件</h4><p>下面使用了嵌套路由，使用的是基于 history 的路由，也可以选择基于 hashchange的路由。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">Vue.use(Router)</span><br><span class="line"></span><br><span class="line"><span class="comment">//路由</span></span><br><span class="line"><span class="keyword">const</span> routes = [&#123;</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    name: <span class="string">'home'</span>,</span><br><span class="line">    component: Index</span><br><span class="line">&#125;,&#123;</span><br><span class="line">    path: <span class="string">'/sign'</span>,</span><br><span class="line">    name: <span class="string">'sign'</span>,</span><br><span class="line">    component: Sign,</span><br><span class="line">    children: [ <span class="comment">//嵌套路由</span></span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">"log"</span>,</span><br><span class="line">            name: <span class="string">"login"</span>,</span><br><span class="line">            component: Login</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">"reg"</span>,</span><br><span class="line">            name: <span class="string">"register"</span>,</span><br><span class="line">            component: Register</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">'*'</span>, <span class="attr">redirect</span>: <span class="string">'log'</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;, &#123; <span class="attr">path</span>: <span class="string">'*'</span>, <span class="attr">redirect</span>: <span class="string">'/'</span> &#125;]</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">    mode: <span class="string">"history"</span>,</span><br><span class="line">    routes</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h4><p>把router，store 和根组件组合起来</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./store'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../public/base.min.css'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../public/fontello.css'</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">	router,</span><br><span class="line">	store,</span><br><span class="line">	render: <span class="function"><span class="params">h</span> =&gt;</span> h(App),</span><br><span class="line">&#125;).$mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="模块的编写"><a href="#模块的编写" class="headerlink" title="模块的编写"></a>模块的编写</h2><p>模版，逻辑代码，样式合成到一个页面也是我欣赏 <strong>vue</strong> 的一个方面，因为这样你就不需要在多个文件之间反复的切换。</p>
<h4 id="模版template"><a href="#模版template" class="headerlink" title="模版template"></a>模版template</h4><p><strong>pug</strong> 就是之前的 jade，它的简洁在复杂的页面下会让 <strong>template</strong> 清晰不少，最起码会让你少敲代码，这里以index 页面的部分代码为例。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;template lang=<span class="string">"pug"</span>&gt;</span><br><span class="line">div.content</span><br><span class="line">    div.bar</span><br><span class="line">        header(v-drag)</span><br><span class="line">            div.avatar(v-on:click=<span class="string">"profile(selfInfo)"</span>)</span><br><span class="line">                img(:src=<span class="string">"selfInfo.avatar? selfInfo.avatar: aPic.src"</span>) </span><br><span class="line">            div.name &#123;&#123; selfInfo.nick &#125;&#125;</span><br><span class="line">                p &#123;&#123; selfInfo.signature&#125;&#125;</span><br><span class="line">            i.icon-logout(v-on:click=<span class="string">"logout"</span>)</span><br><span class="line">        div.body</span><br><span class="line">            div.main-panel(v-<span class="keyword">if</span>=<span class="string">"!isSearch"</span>)        </span><br><span class="line">                nav</span><br><span class="line">                    div(v-on:click=<span class="string">"showTab(0)"</span> :<span class="class"><span class="keyword">class</span></span>=<span class="string">"&#123;active:tabIndex==0&#125;"</span>) 好友</span><br><span class="line">                    div(v-on:click=<span class="string">"showTab(1)"</span> :<span class="class"><span class="keyword">class</span></span>=<span class="string">"&#123;active:tabIndex==1&#125;"</span>) 分组</span><br><span class="line">                    div(v-on:click=<span class="string">"showTab(2)"</span> :<span class="class"><span class="keyword">class</span></span>=<span class="string">"&#123;active:tabIndex==2&#125;"</span>) 消息</span><br><span class="line">                        span(v-<span class="keyword">if</span>=<span class="string">"dealCount"</span>) &#123;&#123;dealCount&#125;&#125;    </span><br><span class="line">                ul.friends(v-<span class="keyword">if</span>=<span class="string">"tabIndex == 0"</span>)</span><br><span class="line">                    li(v-<span class="keyword">for</span>=<span class="string">"item in friends"</span> :key=<span class="string">"item.id"</span>)</span><br><span class="line">                        div.avatar(v-on:click=<span class="string">"profile(item)"</span>)</span><br><span class="line">                            img(:src=<span class="string">"item.avatar? item.avatar: aPic.src"</span>) </span><br><span class="line">                        p(v-on:click=<span class="string">"chatWin(item)"</span>) &#123;&#123;item.nick&#125;&#125;</span><br><span class="line">                        span(v-<span class="keyword">if</span>=<span class="string">"item.reads &amp;&amp; item.reads &gt; 0"</span>) (&#123;&#123;item.reads&#125;&#125;)</span><br><span class="line">		<span class="comment">//动态创建组件</span></span><br><span class="line">    component(:is=<span class="string">"item.component"</span>  v-<span class="keyword">for</span>=<span class="string">"(item,i) in wins"</span> :key=<span class="string">"item.id"</span> </span><br><span class="line">        :info=<span class="string">"item.info"</span></span><br><span class="line">        :sty=<span class="string">"item.sty"</span></span><br><span class="line">        :msgs=<span class="string">"item.msgs"</span></span><br><span class="line">        v-on:close=<span class="string">"closeWin(i)"</span></span><br><span class="line">        v-on:setZ=<span class="string">"setZ(i)"</span>)</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="动态创建组件"><a href="#动态创建组件" class="headerlink" title="动态创建组件"></a>动态创建组件</h4><p>上面用到了 vue 的 动态创建组件 的概念，什么意思呢？这个组件在当前页面中是不存在的，需要我们触发之后，才开始创建。比如，当你点击某个按钮，才开始加载创建组件，然后填充到页面中来。下面就是动态组件相关功能的编写。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">       wins: [] <span class="comment">//组件列表</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;  </span><br><span class="line">  addWin(info, com) &#123; <span class="comment">// 添加组件的方法</span></span><br><span class="line">      <span class="keyword">this</span>.wins.push(&#123;</span><br><span class="line">          msgs: info.msgs || [],</span><br><span class="line">          info,</span><br><span class="line">          sty: &#123;</span><br><span class="line">              left: l * <span class="number">30</span> + <span class="number">270</span>,</span><br><span class="line">              top: l * <span class="number">30</span> + <span class="number">30</span>,</span><br><span class="line">              z: <span class="number">0</span></span><br><span class="line">          &#125;,</span><br><span class="line">          component: com</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//填充组件</span></span><br><span class="line">component(:is=<span class="string">"item.component"</span>  v-<span class="keyword">for</span>=<span class="string">"(item,i) in wins"</span> :key=<span class="string">"item.id"</span> </span><br><span class="line">  :info=<span class="string">"item.info"</span></span><br><span class="line">  :sty=<span class="string">"item.sty"</span></span><br><span class="line">  :msgs=<span class="string">"item.msgs"</span></span><br><span class="line">  v-on:close=<span class="string">"closeWin(i)"</span></span><br><span class="line">  v-on:setZ=<span class="string">"setZ(i)"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="javascript部分"><a href="#javascript部分" class="headerlink" title="javascript部分"></a>javascript部分</h4><p>这里就是业务逻辑的部分了，以部分代码为例, 具体的部分参考官方的文档</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; mapState, mapGetters &#125; <span class="keyword">from</span> <span class="string">"vuex"</span>;</span><br><span class="line"><span class="keyword">import</span> ChatMsg <span class="keyword">from</span> <span class="string">"./ChatMsg.vue"</span>;</span><br><span class="line"><span class="keyword">import</span> Profile <span class="keyword">from</span> <span class="string">"./Profile.vue"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">get</span>, post &#125; from "../common/request";</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">    name: <span class="string">"index"</span>,</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            tabIndex: <span class="number">0</span>,</span><br><span class="line">            wins: [],</span><br><span class="line">            aPic: &#123;</span><br><span class="line">                src: <span class="built_in">require</span>(<span class="string">"../assets/avatar.jpg"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  	<span class="keyword">async</span> created() &#123;</span><br><span class="line">    	<span class="comment">//...</span></span><br><span class="line">  	&#125;,</span><br><span class="line">    computed: &#123;</span><br><span class="line">        ...mapState([<span class="string">"selfInfo"</span>]),</span><br><span class="line">        ...mapGetters([</span><br><span class="line">            <span class="string">"isLogin"</span>,</span><br><span class="line">            <span class="string">"friends"</span>,</span><br><span class="line">            <span class="string">"msgs"</span></span><br><span class="line">        ])</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line">        isLogin: &#123;</span><br><span class="line">            <span class="comment">//监听登录状态</span></span><br><span class="line">            handler: <span class="function"><span class="keyword">function</span>(<span class="params">val, old</span>) </span>&#123;</span><br><span class="line">							<span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ,immediate: true //进入组件立即执行一次</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">  		addWin(info, com) &#123;&#125;,</span><br><span class="line">      sendMsg(user,data)&#123;&#125;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line"> 	  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="style部分"><a href="#style部分" class="headerlink" title="style部分"></a>style部分</h4><p>使用了 <strong>vue</strong> 默认的 <strong>scoped</strong> ，当然最完善的方案是 <strong>css-module</strong>，配置要复杂一些，当然这要看你项目需求。预编译器使用的是 <strong>scss</strong>，个人认为比较强大和方便。</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">&lt;style lang="scss" scoped&gt;</span><br><span class="line"><span class="variable">$blue</span>: hsl(<span class="number">200</span>, <span class="number">100%</span>, <span class="number">45%</span>);</span><br><span class="line">@<span class="keyword">mixin</span> nowrap &#123;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.content</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">1000px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.main-panel</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.search-panel</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">min-height</span>: <span class="number">313px</span>;</span><br><span class="line">    <span class="attribute">max-height</span>: <span class="number">513px</span>;</span><br><span class="line">    <span class="selector-tag">li</span> &#123;</span><br><span class="line">        <span class="attribute">line-height</span>: <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.bar</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">250px</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#fff</span>;</span><br><span class="line">    user-<span class="selector-tag">select</span>: none;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">6px</span> <span class="number">20px</span> <span class="number">0</span> hsla(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">0%</span>, <span class="number">0.19</span>),</span><br><span class="line">        <span class="number">0</span> <span class="number">8px</span> <span class="number">17px</span> <span class="number">0</span> hsla(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">0%</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="selector-tag">header</span> &#123;</span><br><span class="line">        <span class="attribute">display</span>: flex;</span><br><span class="line">        <span class="attribute">align-items</span>: flex-start;</span><br><span class="line">        <span class="attribute">align-items</span>: center;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="variable">$blue</span>;</span><br><span class="line">        <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">        <span class="selector-class">.avatar</span> &#123;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">            <span class="attribute">margin</span>: <span class="number">10px</span>;</span><br><span class="line">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="variable">$blue</span>;</span><br><span class="line">            <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">            <span class="attribute">overflow</span>: hidden;</span><br><span class="line">            <span class="attribute">cursor</span>: pointer;</span><br><span class="line">            &amp;:hover &#123;</span><br><span class="line">                <span class="attribute">border-color</span>: <span class="number">#fff</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="selector-tag">img</span> &#123;</span><br><span class="line">                <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">                <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="selector-tag">style</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="vuex的使用"><a href="#vuex的使用" class="headerlink" title="vuex的使用"></a>vuex的使用</h2><p><strong>vuex</strong> 相比 <strong>react</strong> 中的 <strong>redux</strong>，使用起来也更加简单和方便，尽管相比 <strong>redux</strong> 可能没有那么 “纯”，但好用就行。 <strong>vuex</strong> 直接把异步的 action 封装进里面，使用module将不同组件的状态区分开来。可以说 <strong>vuex</strong> 的 store 集中了 项目大部分与 状态相关的业务逻辑，这也是 <strong>vue</strong> 项目的一大关键点。</p>
<h4 id="store"><a href="#store" class="headerlink" title="store"></a>store</h4><p> <strong>vuex</strong> 的 store 和 <strong>redux</strong> 的 store 一样。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"><span class="keyword">import</span> &#123; state, mutations &#125; <span class="keyword">from</span> <span class="string">'./mutations'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> getters <span class="keyword">from</span> <span class="string">'./getters'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> actions <span class="keyword">from</span> <span class="string">'./actions'</span></span><br><span class="line"><span class="keyword">import</span> friend <span class="keyword">from</span> <span class="string">'./modules/friend'</span></span><br><span class="line"><span class="keyword">import</span> msg <span class="keyword">from</span> <span class="string">'./modules/msg'</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">	actions,</span><br><span class="line">	getters,</span><br><span class="line">	state,</span><br><span class="line">	mutations,</span><br><span class="line">	modules: &#123;</span><br><span class="line">		friend,</span><br><span class="line">		msg</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="全局-state-和-mutations"><a href="#全局-state-和-mutations" class="headerlink" title="全局 state 和 mutations"></a>全局 state 和 mutations</h4><p><strong>vuex</strong> 中的 <strong>state</strong> 对应 <strong>redux</strong> 的 <strong>state</strong>，<strong>mutations</strong> 则类似 <strong>redux</strong> 中的 <strong>action</strong>，其中mutations是同步的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> state = &#123;</span><br><span class="line">    loginInfo: &#123; token &#125;,</span><br><span class="line">    selfInfo: selfInfo,</span><br><span class="line">    dialog: &#123; <span class="attr">txt</span>: <span class="string">'content'</span>, <span class="attr">cancal</span>: <span class="literal">false</span>, <span class="attr">callback</span>: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;, <span class="attr">show</span>: <span class="literal">false</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mutations = &#123;</span><br><span class="line">    showDialog(state, payload) &#123;</span><br><span class="line">        state.modal.visible = <span class="literal">true</span>;</span><br><span class="line">        state.dialog = <span class="built_in">Object</span>.assign(&#123;&#125;, state.dialog, payload);</span><br><span class="line">        state.dialog.show = <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    closeDialog(state) &#123;</span><br><span class="line">        state.modal.visible = <span class="literal">false</span>;</span><br><span class="line">        state.dialog.show = <span class="literal">false</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    setLoginInfo(state) &#123;</span><br><span class="line">        state.loginInfo = &#123; <span class="attr">token</span>: localStorage.getItem(<span class="string">"token"</span>) &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    setSelfInfo(state, payload) &#123;</span><br><span class="line">        state.selfInfo = payload;</span><br><span class="line">        localStorage.setItem(<span class="string">"selfInfo"</span>, <span class="built_in">JSON</span>.stringify(payload));</span><br><span class="line">    &#125;,</span><br><span class="line">    logout() &#123;</span><br><span class="line">        state.loginInfo = &#123;&#125;;</span><br><span class="line">        state.selfInfo = &#123;&#125;;</span><br><span class="line">        localStorage.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="全局-action-和-getters"><a href="#全局-action-和-getters" class="headerlink" title="全局 action 和 getters"></a>全局 action 和 getters</h4><p><strong>vuex</strong> 的 <strong>aciton</strong> 就是将异步的动作封装起来。而<strong>redux</strong> 得通过 <strong>redux-saga</strong> 之类的中间件才能实现类似的效果。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">get</span>, post &#125; from "../common/request";</span><br><span class="line"></span><br><span class="line">export const getInfo = (&#123; commit &#125;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">get</span>("/getinfo").then(res =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.code == <span class="number">0</span>) &#123;</span><br><span class="line">            commit(<span class="string">"setSelfInfo"</span>, res.data.user);</span><br><span class="line">            commit(<span class="string">"setFriends"</span>, res.data.friends);</span><br><span class="line">            commit(<span class="string">"setGroup"</span>, res.data.groups);</span><br><span class="line">            commit(<span class="string">"setMsgs"</span>, res.data.msgs);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.code == <span class="number">1</span>) &#123;</span><br><span class="line">            commit(<span class="string">"logout"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:res.message&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">        commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:err.message&#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> updateSelf=<span class="function">(<span class="params">&#123;commit&#125;,form</span>)=&gt;</span>&#123;</span><br><span class="line">    post(<span class="string">"/updateinfo"</span>, form).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.code == <span class="number">0</span>) &#123;</span><br><span class="line">            commit(<span class="string">"updateSelfInfo"</span>, form);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.code == <span class="number">1</span>) &#123;</span><br><span class="line">            commit(<span class="string">"logout"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:res.message&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">        commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:err.message&#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getters可以看成是对state 中某些字段的封装</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> visible = <span class="function"><span class="params">state</span> =&gt;</span> state.modal.visible</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isLogin = <span class="function"><span class="params">state</span> =&gt;</span> !!state.loginInfo.token</span><br></pre></td></tr></table></figure>
<h4 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h4><p>随着项目规模的扩展，拆分和模块化都是一个必然。针对某个子模块而设置的store，它的结构和根store一样，module 的 store 最终会合并到根 store里面。msg为例的编写方式如下:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">get</span>, post &#125; from "../../common/request";</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">    state: &#123;</span><br><span class="line">        msgs: []</span><br><span class="line">    &#125;,</span><br><span class="line">    getters: &#123;</span><br><span class="line">        msgs: <span class="function"><span class="params">state</span> =&gt;</span> state.msgs,</span><br><span class="line">        dealCount: <span class="function"><span class="params">state</span> =&gt;</span> state.msgs.filter(<span class="function"><span class="params">i</span> =&gt;</span> i.status == <span class="number">0</span>).length</span><br><span class="line">    &#125;,</span><br><span class="line">    actions: &#123;</span><br><span class="line">        accept(&#123; commit &#125;, form) &#123;</span><br><span class="line">            <span class="keyword">return</span> post(<span class="string">"/accept"</span>, &#123; <span class="attr">id</span>: form.id, <span class="attr">friend_id</span>: form.from_id &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (res.code == <span class="number">0</span>) &#123;</span><br><span class="line">                    commit(<span class="string">"setMsgState"</span>, &#123; <span class="attr">id</span>: form.id, <span class="attr">status</span>: <span class="number">1</span> &#125;);</span><br><span class="line">                    commit(<span class="string">"addFriend"</span>, <span class="built_in">Object</span>.assign(&#123;&#125;, form, &#123; <span class="attr">id</span>: form.from_id &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:res.message&#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">                commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:err.message&#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        reject(&#123; commit &#125;, form) &#123;</span><br><span class="line">            post(<span class="string">"/reject"</span>, &#123; <span class="attr">id</span>: form.id &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (res.code == <span class="number">0</span>) &#123;</span><br><span class="line">                    form.status = <span class="number">2</span>;</span><br><span class="line">                    commit(<span class="string">"setMsgState"</span>, form);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:res.message&#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">                commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:err.message&#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    mutations: &#123;</span><br><span class="line">        setMsgs(state, payload) &#123;</span><br><span class="line">            state.msgs = payload;</span><br><span class="line">        &#125;,</span><br><span class="line">        setMsgState(state, payload) &#123;</span><br><span class="line">            state.msgs.forEach(<span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (i.id == payload.id) &#123;</span><br><span class="line">                    i.status = payload.status;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        addMsg(state, payload) &#123;</span><br><span class="line">            state.msgs.unshift(payload);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="socket-io的接入"><a href="#socket-io的接入" class="headerlink" title="socket.io的接入"></a>socket.io的接入</h2><p>接着将websocket使用起来，让我们实现 好友聊天和分组聊天的功能，socket.io 的介绍可以看我之前的文章 <em><a href="/2019/03/29/socketio/">关于socket.io的使用</a></em>。</p>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>首先连接服务端的 socket，然后将自身的用户信息注册到 socket.io 服务，这样服务端才知道你是谁，也才能与其他人实行通信。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> created() &#123;<span class="comment">// vue 组件创建时建立socket连接</span></span><br><span class="line">  <span class="keyword">const</span> token = localStorage.getItem(<span class="string">"token"</span>) || <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.$router.push(<span class="string">"/sign/log"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">this</span>.$store.dispatch(<span class="string">"getInfo"</span>);</span><br><span class="line">  <span class="keyword">this</span>.socket = io(<span class="string">"http://localhost:3001?token="</span> + token);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//注册用户信息后才开始与服务端通信</span></span><br><span class="line">  <span class="keyword">this</span>.socket.emit(<span class="string">"sign"</span>, &#123; <span class="attr">user</span>: <span class="keyword">this</span>.selfInfo, rooms &#125;, res =&gt; &#123;</span><br><span class="line">    <span class="comment">// console.log(res);</span></span><br><span class="line">    <span class="keyword">this</span>.$store.commit(<span class="string">"friendStatus"</span>, res.data);</span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"userin"</span>, (map, user) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">"friendStatus"</span>, map);</span><br><span class="line">      showTip(user, <span class="string">"上线了"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"userout"</span>, (map, user) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">"friendStatus"</span>, map);</span><br><span class="line">      showTip(user, <span class="string">"下线了"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"auth"</span>, data =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:data.message&#125;)</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">"logout"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收申请好友和组群</span></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"apply"</span>, data =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">"addMsg"</span>, data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收聊天信息</span></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"reply"</span>, (user, data) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.sendMsg(user, data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收群组聊天信息</span></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"groupReply"</span>, (info, data) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.sendGroupMsg(info, data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br><span class="line">beforeDestroy() &#123; <span class="comment">//组件销毁之前，将socket 关闭</span></span><br><span class="line">	<span class="keyword">this</span>.socket.close();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><p>socket.io 对应的服务端部分，逻辑主要包括用户注册，两人聊天，群聊天，当然对应的信息需要保存到数据库。 这里的技巧就是使用变量记录当前所有登录用户的信息。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> auth = <span class="built_in">require</span>(<span class="string">'./auth.js'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; insertMsg, insertToUser &#125; = <span class="built_in">require</span>(<span class="string">'../daos/message'</span>);</span><br><span class="line"><span class="keyword">const</span> log = <span class="built_in">require</span>(<span class="string">'../common/logger'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> MAP = &#123;&#125;;<span class="comment">//用户id和socket id</span></span><br><span class="line"><span class="keyword">let</span> LIST = []; <span class="comment">//用户信息</span></span><br><span class="line"><span class="keyword">let</span> ROOMS = []; <span class="comment">//房间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> currTime = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(), date = <span class="string">`<span class="subst">$&#123;d.getFullYear()&#125;</span>-<span class="subst">$&#123;d.getMonth()&#125;</span>-<span class="subst">$&#123;d.getDate()&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="string">'0'</span> + d.getHours()).slice(<span class="number">-2</span>) + <span class="string">':'</span> + (<span class="string">'0'</span> + d.getMinutes()).slice(<span class="number">-2</span>) + <span class="string">':'</span> + (<span class="string">'0'</span> + d.getSeconds()).slice(<span class="number">-2</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">io</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// middleware</span></span><br><span class="line">    io.use(auth);</span><br><span class="line">    <span class="comment">//namespace (/)</span></span><br><span class="line">    io.on(<span class="string">'connection'</span>, socket =&gt; &#123;</span><br><span class="line">        socket.emit(<span class="string">'open'</span>, &#123;</span><br><span class="line">            code: <span class="number">0</span>,</span><br><span class="line">            handshake: socket.handshake,</span><br><span class="line">            namespace: <span class="string">'/'</span>,</span><br><span class="line">            message: <span class="string">'welcome to main channel, please sign'</span></span><br><span class="line">        &#125;);</span><br><span class="line">				</span><br><span class="line">      	<span class="comment">//用户注册</span></span><br><span class="line">        socket.on(<span class="string">'sign'</span>, (&#123; user, rooms &#125;, fn) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!user.id) &#123;</span><br><span class="line">                <span class="keyword">return</span> fn(&#123; <span class="attr">code</span>: <span class="number">2</span>, <span class="attr">message</span>: <span class="string">'id not exist'</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            MAP[user.id] = socket.id;</span><br><span class="line">            user.socketId = socket.id;</span><br><span class="line">            LIST.push(user);</span><br><span class="line"></span><br><span class="line">            socket.join(rooms);<span class="comment">//加入自己所在的组</span></span><br><span class="line">            socket.emit(<span class="string">'userin'</span>, MAP, user);</span><br><span class="line">            socket.broadcast.emit(<span class="string">'userin'</span>, MAP, user);</span><br><span class="line"></span><br><span class="line">            fn(&#123;</span><br><span class="line">                code: <span class="number">0</span>,</span><br><span class="line">                message: <span class="string">'sign success'</span>,</span><br><span class="line">                data: MAP</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//两人聊天</span></span><br><span class="line">        socket.on(<span class="string">'send'</span>, <span class="keyword">async</span> (uid, msg) =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> sid = MAP[uid];<span class="comment">//接收用户socket.id</span></span><br><span class="line">            <span class="keyword">const</span> cid = findUid(socket.id);<span class="comment">//发送用户id</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sid) &#123; <span class="comment">// 好友在线则发送</span></span><br><span class="line">                socket.to(sid).emit(<span class="string">'reply'</span>, &#123; <span class="attr">id</span>: cid, <span class="attr">self</span>: <span class="literal">false</span> &#125;, &#123; <span class="attr">date</span>: currTime(), msg &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 给自己也发一份</span></span><br><span class="line">            socket.emit(<span class="string">'reply'</span>, &#123; <span class="attr">id</span>: uid, <span class="attr">self</span>: <span class="literal">true</span> &#125;, &#123; <span class="attr">date</span>: currTime(), msg &#125;);</span><br><span class="line">            <span class="comment">// 保存数据库</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> ret = <span class="keyword">await</span> insertMsg(&#123; <span class="attr">send_id</span>: cid, <span class="attr">receive_id</span>: uid, <span class="attr">content</span>: msg &#125;);</span><br><span class="line">                insertToUser(&#123; <span class="attr">user_id</span>: uid, <span class="attr">send_id</span>: cid, <span class="attr">message_id</span>: ret.insertId, <span class="attr">is_read</span>: sid ? <span class="number">1</span> : <span class="number">0</span> &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                log.error(err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//群组聊天</span></span><br><span class="line">        socket.on(<span class="string">'groupSend'</span>, <span class="keyword">async</span> (&#123;gid,user&#125;, msg) =&gt; &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        socket.on(<span class="string">'acceptFriend'</span>, (uid) =&gt; &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        socket.on(<span class="string">'sendApply'</span>, (uid, data) =&gt; &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        socket.on(<span class="string">'disconnect'</span>, () =&gt; &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="客户端的启动"><a href="#客户端的启动" class="headerlink" title="客户端的启动"></a>客户端的启动</h2><p>首先得编写client.js，将前端服务启动起来，依然还是使用我们高效的koa框架。我这里图省事，和之前的服务端所在同一个根目录下，真正项目会将服务端部分和客户端部分 分离到不同目录或不同的服务器的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> koa()</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">'koa-static'</span>)</span><br><span class="line"><span class="keyword">const</span> compress = <span class="built_in">require</span>(<span class="string">'koa-compress'</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line"><span class="keyword">const</span> &#123; clientPort &#125; = <span class="built_in">require</span>(<span class="string">'./server/config/app'</span>)</span><br><span class="line"><span class="keyword">const</span> tpl = <span class="built_in">require</span>(<span class="string">'./server/middleware/tpl'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// gzip</span></span><br><span class="line">app.use(compress(&#123;</span><br><span class="line">    filter: <span class="function"><span class="keyword">function</span> (<span class="params">content_type</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="regexp">/text|javascript/i</span>.test(content_type)</span><br><span class="line">    &#125;,</span><br><span class="line">    threshold: <span class="number">2048</span>,</span><br><span class="line">    flush: <span class="built_in">require</span>(<span class="string">'zlib'</span>).Z_SYNC_FLUSH</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// set static directiory</span></span><br><span class="line">app.use(<span class="keyword">static</span>(path.join(__dirname, <span class="string">'dist'</span>), &#123; <span class="attr">index</span>: <span class="literal">false</span> &#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// simple template engine</span></span><br><span class="line">app.use(tpl(&#123;</span><br><span class="line">    path: path.join(__dirname, <span class="string">'dist'</span>)</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// add routers</span></span><br><span class="line">router</span><br><span class="line">    .get(<span class="string">'/'</span>, ctx =&gt; &#123;</span><br><span class="line">        ctx.render(<span class="string">'index.html'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .get(<span class="string">'/sign/*'</span>, ctx =&gt; &#123;</span><br><span class="line">        ctx.redirect(<span class="string">'/'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br><span class="line">    .use(router.allowedMethods());</span><br><span class="line"></span><br><span class="line"><span class="comment">// deal 404</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.status = <span class="number">404</span>;</span><br><span class="line">    ctx.body = &#123; <span class="attr">code</span>: <span class="number">404</span>, <span class="attr">message</span>: <span class="string">'404! not found !'</span> &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// koa already had event to deal with the error, just rigister it</span></span><br><span class="line">app.on(<span class="string">'error'</span>, (err, ctx) =&gt; &#123;</span><br><span class="line">    ctx.status = <span class="number">500</span>;</span><br><span class="line">    ctx.statusText = <span class="string">'Internal Server Error'</span>;</span><br><span class="line">    <span class="keyword">if</span> (ctx.app.env === <span class="string">'development'</span>) &#123; <span class="comment">//throw the error to frontEnd when in the develop mode</span></span><br><span class="line">        ctx.res.end(err.stack); <span class="comment">//finish the response</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.body = &#123; <span class="attr">code</span>: <span class="number">-1</span>, <span class="attr">message</span>: <span class="string">'Server Error'</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">module</span>.parent) &#123;</span><br><span class="line">    app.listen(clientPort);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'app server running at: http://localhost:%d'</span>, clientPort);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动服务端和客户端，我们整个demo就能运行，主要实现如下功能点：</p>
<ol>
<li>主页面的所有的窗口都可以拖动，关闭</li>
<li>可以编辑用户信息，群组信息，每个用户可以新建3个群组</li>
<li>可以好友聊天，群组聊天</li>
<li>搜索用户和群组</li>
<li>好友申请和群组申请</li>
<li>在线时，可以获得好友上线下线提醒，实时答复用户申请</li>
<li>离线时，仍然可以给用户和群组留言，下次登录获得提醒</li>
</ol>
<p><img src="https://upload-images.jianshu.io/upload_images/127924-0cb17ea3a9c6d4df.png" alt="web QQ"></p>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>接下来可以优化和增强的地方，我想到以下几点：</p>
<ol>
<li>使用 <strong>nuxt</strong> 将 vue 进行服务端渲染 ，进一步提高性能</li>
<li>node 部分，使用 pm2 进行部署。</li>
</ol>
<p>源代码: <em><a href="https://github.com/edwardzhong/vue_qq" target="_blank" rel="noopener">vue_qq</a></em></p>
</div>
    	
		<div class="post-footer">
			<div class="share" data-url="/2019/04/13/fullstack3/" data-desc="React 与 Vue 之间的对比，是前端的一大热门话题。

vue 简易上手的脚手架，以及官..."><a href="javascript:;" data-type="share" class="icon icon-share"> 分享</a></div>
			<div class="tags">
			<i class="icon icon-tag"></i> 
			
				
				
                    
                        <a href="/tags/前端/">前端</a>
                    
				
                    
                        <a href="/tags/vue/">vue</a>
                    
				
                    
                        <a href="/tags/socket-io/">socket.io</a>
                    
				
                    
                        <a href="/tags/vuex/">vuex</a>
                    
				
			
			</div>
		</div>
	</div>
</article>
</div>

<nav class="pagination clearfix">
  
    
      
      <a href="/2019/04/26/weappcloud/" class="prev post-prev">&larr; 小试小程序云开发</a>
      

      
      <a href="/2019/04/12/fullstack2/" class="next post-next">koa+mysql+vue+soc... &rarr;</a>
      
    
  
</nav>

<div class="wxshare-popup">
    <a class="close" href="javascript:;"><i class="icon icon-cancel"></i></a>
    <p>扫一扫，分享到微信</p>
    <div id="qrcode" class="wx-qrcode"></div>
</div>

    
    <footer class="footer">
<p class="theme">
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/edwardzhong/simply.git">simply</a>
</p>
<p class="copy">Copyright &copy; 2019 Jeff Zhong</p>
</footer>
    <div class="top-bottom">
      <div class="to-top hide" title="to top"><i class="icon icon-up-open"></i></div>
      <div class="to-bottom hide" title="to bottom"><i class="icon icon-down-open"></i></div>
    </div>
    </div>

  </div>
<input type="hidden" name="isPost" id="isPost" value="true">
<i id="barBtn" class="icon icon-menu"></i>
<div id="payMe" class="payme">
    <i class="icon icon-cancel"></i>
    <p class="pay-title">给我的早餐加个蛋吧 <i class="icon icon-smile"></i></p>
    <div>
      <img src="/img/weixinpay.jpg" alt="weixinpay">
      <img src="/img/alipay.jpg" alt="alipay" style="display:none;">
    </div>
    <div class="pay-selects">
        <input type="radio" name="pay" id="weixinpay" checked="checked"><label for="weixinpay"> 微信 </label>&nbsp;&nbsp;
        <input type="radio" name="pay" id="alipay"><label for="alipay"> 支付宝 </label>
    </div>
</div>

  
  
    <script src="/lib/jquery-2.2.3.min.js"></script>
  
    <script src="/lib/qrcode.min.js"></script>
  
    <script src="/dist/js/index.js"></script>
  

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


</body>
</html>
