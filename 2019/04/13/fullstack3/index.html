<!doctype html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <!-- ä¼˜å…ˆä½¿ç”¨ IE æœ€æ–°ç‰ˆæœ¬å’Œ Chrome -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!-- ä¸ºç§»åŠ¨è®¾å¤‡æ·»åŠ  viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <!-- æ·»åŠ åˆ°ä¸»å±åçš„æ ‡é¢˜ï¼ˆiOS 6 æ–°å¢ï¼‰ -->
  <meta name="apple-mobile-web-app-title" content="koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹å‰ç«¯ç¯‡ - Jeff's world">
  <!-- æ˜¯å¦å¯ç”¨ WebApp å…¨å±æ¨¡å¼ï¼Œåˆ é™¤è‹¹æœé»˜è®¤çš„å·¥å…·æ å’Œèœå•æ  -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- è®¾ç½®è‹¹æœå·¥å…·æ é¢œè‰² -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <!-- æ·»åŠ æ™ºèƒ½ App å¹¿å‘Šæ¡ Smart App Bannerï¼ˆiOS 6+ Safariï¼‰ -->
  <!-- <meta name = "apple-itunes-app" content = "app-id=myAppStoreID, affiliate-data=myAffiliateData, app-argument=myURL"> -->
  <!-- å¿½ç•¥é¡µé¢ä¸­çš„æ•°å­—è¯†åˆ«ä¸ºç”µè¯ï¼Œå¿½ç•¥emailè¯†åˆ« -->
  <meta name="format-detection" content="telphone=no, email=no">
  <!--ä¸‹é¢ä¸‰ä¸ªæ˜¯æ¸…é™¤ç¼“å­˜ å¾®ä¿¡æµè§ˆå™¨ç¼“å­˜ä¸¥é‡åˆæ— åˆ·æ–°ï¼›è¿™ä¸ªæ–¹æ³•è°ƒè¯•çš„æ—¶å€™å¾ˆæ–¹ä¾¿-->
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <link rel="dns-prefetch" href="http://jeffzhong.space">
  <link rel="icon shortcut" type="image/ico" href="/favicon.ico">
  <meta name="author" content="Jeff Zhong">
  <meta name="description" content="it's a blog by hexo">
  <meta name="keywords" content="hexo theme">
  <title>koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹å‰ç«¯ç¯‡ - Jeff's world</title>
    <!-- The Open Graph protocol -->
  <meta property="og:url" content="http://jeffzhong.space">
  <meta property="og:type" content="blog">
  <meta property="og:title" content="koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹å‰ç«¯ç¯‡ - Jeff's world">
  <meta property="og:description" content="it's a blog by hexo">
  <!-- UC Browser Compatible -->
<!--   <script>
      var agent = navigator.userAgent.toLowerCase();
      if(agent.indexOf('ucbrowser')>0) {
          alert('ç”±äº UC æµè§ˆå™¨ä½¿ç”¨ææ—§çš„å†…æ ¸ï¼Œè€Œæœ¬ç½‘ç«™ä½¿ç”¨äº†ä¸€äº›æ–°çš„ç‰¹æ€§ã€‚\nä¸ºäº†æ‚¨èƒ½æ›´å¥½çš„æµè§ˆï¼Œæ¨èä½¿ç”¨ Chrome æˆ– Firefox æµè§ˆå™¨ã€‚');
      }
  </script> -->
  
    
    
      <link rel="stylesheet" href="/lib/fontello/fontello.css?t=1">
    
      <link rel="stylesheet" href="/lib/reboto/roboto.css?t=1">
    
      <link rel="stylesheet" href="/dist/css/index.css?t=1">
    
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5255e97b442092b8e1a219e6a48a0d42";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>
<header class="header">
  <div class="top"></div>
  <h2>Jeff's World</h2>
  <h3>Things that I'm interested in</h3>
  <div class="menu">
  
  
  
      <a href="/">
        <i class="icon icon-home"></i>
        ä¸»é¡µ
      </a>
  
      <a href="/sites/demo/">
        <i class="icon icon-tag"></i>
        Demo
      </a>
  
      <a data-tag="search" href="javascript:;">
        <i class="icon icon-search"></i>
        æœç´¢
      </a>
  
  </div>
  <div class="state">
  
    <a href="/archives">40<br>æ–‡ç« </a><a href="/categories">2<br>åˆ†ç±»</a><a href="/tags">58<br>æ ‡ç­¾</a>
  </div>
  <div class="social">
  
  
  
      <a href="https://github.com/edwardzhong" title="Github"><i class="icon icon-github-circled"></i></a>
  
      <a href="https://twitter.com/JianfengEdward" title="Twitter"><i class="icon icon-twitter"></i></a>
  
      <a href="https://www.facebook.com/jianfeng.edward" title="Facebook"><i class="icon icon-facebook"></i></a>
  
      <a href="http://weibo.com/1593251850" title="Weibo"><i class="icon icon-weibo"></i></a>
  
      <a href="/atom.xml" title="Rss"><i class="icon icon-rss"></i></a>
  
  </div>
  <div id="payBtn" class="pay-icon" title="è°¢è°¢æ‚¨çš„èµèµ">èµ</div>
</header>
  <div class="container">
    <div class="main">
    
        
<div class="post-list">
	<article class="post" style="animation:listshow 0.6s ease-out both 0.30000000000000004s">
    
    
        
    
	
	<a href="javascript:;">
        <div class="post-banner" style="background: url(https://upload-images.jianshu.io/upload_images/127924-85f6e78cffe1c63c.jpg)  center top / 100% no-repeat">
    		<h3 class="post-title">koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹å‰ç«¯ç¯‡</h3>
    	</div>
	</a>
	<div class="post-inner">
	
    	<div class="post-info">
    		<time class="icon icon-calendar"> 2019/04/13 13:43:00</time>
    		<span class="category">
    		
    			
    			<i class="icon icon-book"></i>
    			
                    
                        <a href="/categories/æŠ€æœ¯/">æŠ€æœ¯</a>
                    
        			
    			
    		
    		</span>
    	</div>
    	<!-- <p><p>React ä¸ Vue ä¹‹é—´çš„å¯¹æ¯”ï¼Œæ˜¯å‰ç«¯çš„ä¸€å¤§çƒ­é—¨è¯é¢˜ã€‚</p>
<p>vue ç®€æ˜“ä¸Šæ‰‹çš„è„šæ‰‹æ¶ï¼Œä»¥åŠå®˜æ–¹æä¾›å¿…å¤‡çš„åŸºç¡€ç»„ä»¶ï¼Œæ¯”å¦‚ vuexï¼Œvue-routerï¼Œå¯¹æ–°æ‰‹çœŸçš„æ¯”è¾ƒå‹å¥½ï¼›react åˆ™æŠŠè¿™äº›â€¦</p>
</p> -->
    	
    	<div class="post-content"><p><strong>React</strong> ä¸ <strong>Vue</strong> ä¹‹é—´çš„å¯¹æ¯”ï¼Œæ˜¯å‰ç«¯çš„ä¸€å¤§çƒ­é—¨è¯é¢˜ã€‚</p>
<ul>
<li><p><strong>vue</strong> ç®€æ˜“ä¸Šæ‰‹çš„è„šæ‰‹æ¶ï¼Œä»¥åŠå®˜æ–¹æä¾›å¿…å¤‡çš„åŸºç¡€ç»„ä»¶ï¼Œæ¯”å¦‚ <strong>vuex</strong>ï¼Œ<strong>vue-router</strong>ï¼Œå¯¹æ–°æ‰‹çœŸçš„æ¯”è¾ƒå‹å¥½ï¼›<strong>react</strong> åˆ™æŠŠè¿™äº›éƒ½äº¤ç»™ç¤¾åŒºå»åšï¼Œè™½ç„¶è¿™å£®å¤§äº† <strong>react</strong>  çš„ç”Ÿæ€é“¾ï¼Œä½†æ–°æ‰‹è¦å¼„å‡ºä¸€å¥—è¶æ‰‹çš„æ–¹æ¡ˆæŒºéº»çƒ¦çš„ï¼Œä¸è¿‡å¥½åœ¨ç°åœ¨æœ‰å¾ˆå¤šç±»ä¼¼ dvaçš„æ–¹æ¡ˆäº†ã€‚</p>
</li>
<li><p><strong>vue</strong> æ¯”è¾ƒè®¨å–œçš„ä¸€ç‚¹ï¼Œå°±æ˜¯å®ƒçš„æ•°æ®åŒå‘æµåŠ¨åœ¨è¡¨å•å¼€å‘æ—¶ç‰¹åˆ«æ–¹ä¾¿ï¼Œè€Œ <strong>react</strong> åœ¨è¿™æ–¹é¢å¯å°±éº»çƒ¦å¤šäº†ã€‚</p>
</li>
<li><p>ä½†æ˜¯ <strong>vue</strong> å¤æ‚çš„ api ï¼Œç®€ç›´è®©äººå¤´å¤§ï¼Œå…‰æ˜¯æ–‡æ¡£è¯´æ˜éƒ½å‡ åé¡µäº†ã€‚å¤ªå¤šçš„è¯­æ³•ï¼Œå¤ªå¤šçš„é­”æ³•ç¬¦å·ï¼Œå¯¹è¿›åŒ–é€Ÿåº¦è¶Šæ¥è¶Šå¿«çš„å‰ç«¯å±Šæ¥è¯´ï¼Œå°±æ˜¯å…¥æ‰‹è¿™ä¸ªæ¡†æ¶çš„æœ€å¤§é˜»ç¢ã€‚</p>
</li>
<li><p>è€Œç›¸å <strong>react</strong> çš„ api æ•°é‡ç®€ç›´å¯ä»¥å¿½ç•¥ä¸è®¡äº†ï¼Œé¡¶å¤šèŠ±å‡ å°æ—¶å°±èƒ½çœ‹å®Œå®˜æ–¹æ–‡æ¡£ã€‚ä½ åªè¦ç†è§£ <strong>JavaScript</strong>ï¼Œå°±èƒ½ç†è§£ <strong>react</strong> çš„å¾ˆå¤šè¡Œä¸ºã€‚<strong>react</strong> çš„å¾ˆå¤šç”¨æ³•ï¼Œå®ƒçš„ api éƒ½æ˜¯ç¬¦åˆç›´è§‰çš„ï¼Œä½ å¯¹å®ƒç”¨æ³•çš„çŒœæµ‹åŸºæœ¬éƒ½æ˜¯å…«ä¹ä¸ç¦»åçš„ï¼Œè¿™çœŸæ˜¯å¤§å¤§é™ä½äº†å¿ƒæ™ºè´Ÿæ‹…ã€‚</p>
</li>
<li><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<strong>react</strong> çš„ <strong>jsx</strong> è¯­æ³•è¡¨è¾¾èƒ½åŠ›æ›´å¼ºï¼Œè¿˜æœ‰ <strong>hoc</strong> å’Œ <strong>hooks</strong> ä½¿ä»£ç ä¹Ÿæ›´å®¹æ˜“ç»„ç»‡å’Œå¤ç”¨ã€‚</p>
</li>
</ul>
<p>è™½ç„¶æˆ‘æ›´å–œæ¬¢ <strong>React</strong> ï¼Œä½†å·¥ä½œä¸Šçš„éœ€æ±‚ï¼Œè¿˜ä¸æ˜¯è¦ä½ ç”¨ä»€ä¹ˆä½ å°±å¾—ç”¨ä»€ä¹ˆğŸ˜‚ï¼Œæ‰€ä»¥è¿™ä¸ª demo å°±å½“æ˜¯æ¢ç´¢ <strong>Vue</strong> çš„å‰å¥ã€‚</p>
<a id="more"></a>
<p>ä¹‹å‰æˆ‘è¿˜æ˜¯æœ‰ç”¨è¿‡ <strong>vue</strong> çš„ï¼Œè®°å¾—è¿˜æ˜¯ 1.0 ç‰ˆæœ¬ï¼Œå½“æ—¶çš„æ½®æµå°±æ˜¯ç±»ä¼¼ <strong>angular</strong> 1.x çš„ <strong>mvvm</strong> æ–¹æ¡ˆï¼Œæ•°æ®åŒå‘æµåŠ¨ã€‚é‚£æ—¶çš„ <strong>vue</strong> è¿œæ²¡æœ‰ç°åœ¨çš„çƒ­åº¦ï¼Œç»„ä»¶ä¹Ÿå°‘ï¼Œæ²¡æœ‰ <strong>vue-router</strong>ï¼Œæ²¡æœ‰ <strong>vuex</strong>ï¼Œç»„ä»¶ä¹‹å‰çš„é€šä¿¡ç®€ç›´å¤ªç—›è‹¦äº†ã€‚ç°åœ¨ <strong>vue</strong> 2.x æ¯”èµ·ä¹‹å‰ï¼Œå·²ç»å‘ç”Ÿäº†å¤©ç¿»åœ°è¦†çš„å˜åŒ–ï¼Œ<strong>vue</strong> ä¹Ÿåœ¨ä¸æ–­å‘ <strong>react</strong> é æ‹¢ï¼Œè€Œæˆ‘ä¹Ÿåªèƒ½ä»å¤´å¼€å§‹å­¦èµ·ã€‚</p>
<p>é—²è¯è¯´å¾—æœ‰ç‚¹å¤šï¼Œè¿˜æ˜¯èµ¶ç´§è¿›å…¥ä¸»é¢˜å§</p>
<h2 id="é¡¹ç›®é…ç½®"><a href="#é¡¹ç›®é…ç½®" class="headerlink" title="é¡¹ç›®é…ç½®"></a>é¡¹ç›®é…ç½®</h2><p>é€‰æ‹© webpack 4 æ‰“åŒ…å’Œç®¡ç†ï¼Œtemplate å¼•æ“ä½¿ç”¨ pug ï¼Œcss é¢„ç¼–è¯‘æ˜¯ scssã€‚</p>
<h4 id="webpack-common-js-çš„é…ç½®"><a href="#webpack-common-js-çš„é…ç½®" class="headerlink" title="webpack.common.js çš„é…ç½®"></a>webpack.common.js çš„é…ç½®</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// webpack.common.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: <span class="string">'./src/main.js'</span>,</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'[name]-[hash].js'</span><span class="comment">//è¾“å‡ºæ–‡ä»¶æ·»åŠ hash</span></span><br><span class="line">    &#125;,</span><br><span class="line">    optimization: &#123; <span class="comment">// ä»£æ›¿commonchunk, ä»£ç åˆ†å‰²</span></span><br><span class="line">        runtimeChunk: <span class="string">'single'</span>,</span><br><span class="line">        splitChunks: &#123;</span><br><span class="line">            cacheGroups: &#123;</span><br><span class="line">                vendor: &#123;</span><br><span class="line">                    test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">                    name: <span class="string">'vendors'</span>,</span><br><span class="line">                    chunks: <span class="string">'all'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test:<span class="regexp">/\.vue$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                use:[<span class="string">'vue-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js?$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                use: [<span class="string">'babel-loader'</span>]<span class="comment">//'eslint-loader'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.pug$/</span>,</span><br><span class="line">                use: [<span class="string">'pug-plain-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                use: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">                use: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>, <span class="string">'postcss-loader'</span>, <span class="string">'sass-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;   </span><br><span class="line">                test: <span class="regexp">/\.(png|jpg|jpeg|gif|eot|ttf|woff|woff2|svg|svgz)(\?.+)?$/</span>,</span><br><span class="line">                use: [&#123;</span><br><span class="line">                    loader: <span class="string">'url-loader'</span>,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        limit: <span class="number">1000</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> VueLoaderPlugin(),</span><br><span class="line">        <span class="keyword">new</span> CleanWebpackPlugin([resolve(__dirname, <span class="string">'dist'</span>)]),<span class="comment">//ç”Ÿæˆæ–°æ–‡ä»¶æ—¶ï¼Œæ¸…ç©ºç”Ÿå‡ºç›®å½•</span></span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">            template: <span class="string">'./public/index.html'</span>,<span class="comment">//æ¨¡ç‰ˆè·¯å¾„</span></span><br><span class="line">            filename: <span class="string">'index.html'</span>,<span class="comment">//ç”Ÿæˆåçš„æ–‡ä»¶å,é»˜è®¤index.html</span></span><br><span class="line">            favicon: <span class="string">'./public/favicon.ico'</span>,</span><br><span class="line">            minify: &#123;</span><br><span class="line">                removeAttributeQuotes:<span class="literal">true</span>,</span><br><span class="line">                removeComments: <span class="literal">true</span>,</span><br><span class="line">                collapseWhitespace: <span class="literal">true</span>,</span><br><span class="line">                removeScriptTypeAttributes:<span class="literal">true</span>,</span><br><span class="line">                removeStyleLinkTypeAttributes:<span class="literal">true</span></span><br><span class="line">             &#125;</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> HotModuleReplacementPlugin()<span class="comment">//HMR</span></span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="webpack-dev-js-çš„é…ç½®"><a href="#webpack-dev-js-çš„é…ç½®" class="headerlink" title="webpack.dev.js çš„é…ç½®"></a>webpack.dev.js çš„é…ç½®</h4><p>å°±æ˜¯å¼€å‘æœåŠ¡å™¨ devServerçš„é…ç½®ï¼Œç›‘æ§ä»£ç å˜æ›´ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// webpack.dev.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = merge(common, &#123;</span><br><span class="line">    mode: <span class="string">'development'</span>,</span><br><span class="line">    devtool: <span class="string">'inline-source-map'</span>,</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        contentBase: <span class="string">'./dist'</span>,</span><br><span class="line">        index:<span class="string">'index.html'</span>,</span><br><span class="line">        port: <span class="number">3002</span>,</span><br><span class="line">        compress: <span class="literal">true</span>,</span><br><span class="line">        historyApiFallback: <span class="literal">true</span>,</span><br><span class="line">        hot: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="babel-config-js-çš„é…ç½®"><a href="#babel-config-js-çš„é…ç½®" class="headerlink" title="babel.config.js çš„é…ç½®"></a>babel.config.js çš„é…ç½®</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  presets: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'@vue/app'</span>, &#123;</span><br><span class="line">        <span class="string">"useBuiltIns"</span>: <span class="string">"entry"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">public <span class="comment">#å…¬å…±ç›®å½•</span></span><br><span class="line">server <span class="comment">#åç«¯ç›®å½•</span></span><br><span class="line">src    <span class="comment">#å‰ç«¯ç›®å½•</span></span><br><span class="line">â”œâ”€â”€ assets <span class="comment">#é™æ€æ–‡ä»¶ç›®å½•</span></span><br><span class="line">â”œâ”€â”€ common <span class="comment">#å·¥å…·ç›®å½•</span></span><br><span class="line">â”œâ”€â”€ components <span class="comment">#ç»„ä»¶ç›®å½•</span></span><br><span class="line">â”œâ”€â”€ store   <span class="comment"># vuex storeç›®å½•</span></span><br><span class="line">â”œâ”€â”€ App.vue <span class="comment"># æ ¹ç»„ä»¶</span></span><br><span class="line">â”œâ”€â”€ main.js <span class="comment"># å…¥å£æ–‡ä»¶</span></span><br><span class="line">â””â”€â”€ router.js <span class="comment">#è·¯ç”±</span></span><br></pre></td></tr></table></figure>
<h2 id="å…¥å£å’Œè·¯ç”±"><a href="#å…¥å£å’Œè·¯ç”±" class="headerlink" title="å…¥å£å’Œè·¯ç”±"></a>å…¥å£å’Œè·¯ç”±</h2><h4 id="è·¯ç”±æ–‡ä»¶"><a href="#è·¯ç”±æ–‡ä»¶" class="headerlink" title="è·¯ç”±æ–‡ä»¶"></a>è·¯ç”±æ–‡ä»¶</h4><p>ä¸‹é¢ä½¿ç”¨äº†åµŒå¥—è·¯ç”±ï¼Œä½¿ç”¨çš„æ˜¯åŸºäº history çš„è·¯ç”±ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åŸºäº hashchangeçš„è·¯ç”±ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">Vue.use(Router)</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·¯ç”±</span></span><br><span class="line"><span class="keyword">const</span> routes = [&#123;</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    name: <span class="string">'home'</span>,</span><br><span class="line">    component: Index</span><br><span class="line">&#125;,&#123;</span><br><span class="line">    path: <span class="string">'/sign'</span>,</span><br><span class="line">    name: <span class="string">'sign'</span>,</span><br><span class="line">    component: Sign,</span><br><span class="line">    children: [ <span class="comment">//åµŒå¥—è·¯ç”±</span></span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">"log"</span>,</span><br><span class="line">            name: <span class="string">"login"</span>,</span><br><span class="line">            component: Login</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">"reg"</span>,</span><br><span class="line">            name: <span class="string">"register"</span>,</span><br><span class="line">            component: Register</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; <span class="attr">path</span>: <span class="string">'*'</span>, <span class="attr">redirect</span>: <span class="string">'log'</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;, &#123; <span class="attr">path</span>: <span class="string">'*'</span>, <span class="attr">redirect</span>: <span class="string">'/'</span> &#125;]</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">    mode: <span class="string">"history"</span>,</span><br><span class="line">    routes</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="å…¥å£æ–‡ä»¶"><a href="#å…¥å£æ–‡ä»¶" class="headerlink" title="å…¥å£æ–‡ä»¶"></a>å…¥å£æ–‡ä»¶</h4><p>æŠŠrouterï¼Œstore å’Œæ ¹ç»„ä»¶ç»„åˆèµ·æ¥</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./store'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../public/base.min.css'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../public/fontello.css'</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">	router,</span><br><span class="line">	store,</span><br><span class="line">	render: <span class="function"><span class="params">h</span> =&gt;</span> h(App),</span><br><span class="line">&#125;).$mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="æ¨¡å—çš„ç¼–å†™"><a href="#æ¨¡å—çš„ç¼–å†™" class="headerlink" title="æ¨¡å—çš„ç¼–å†™"></a>æ¨¡å—çš„ç¼–å†™</h2><p>æ¨¡ç‰ˆï¼Œé€»è¾‘ä»£ç ï¼Œæ ·å¼åˆæˆåˆ°ä¸€ä¸ªé¡µé¢ä¹Ÿæ˜¯æˆ‘æ¬£èµ <strong>vue</strong> çš„ä¸€ä¸ªæ–¹é¢ï¼Œå› ä¸ºè¿™æ ·ä½ å°±ä¸éœ€è¦åœ¨å¤šä¸ªæ–‡ä»¶ä¹‹é—´åå¤çš„åˆ‡æ¢ã€‚</p>
<h4 id="æ¨¡ç‰ˆtemplate"><a href="#æ¨¡ç‰ˆtemplate" class="headerlink" title="æ¨¡ç‰ˆtemplate"></a>æ¨¡ç‰ˆtemplate</h4><p><strong>pug</strong> å°±æ˜¯ä¹‹å‰çš„ jadeï¼Œå®ƒçš„ç®€æ´åœ¨å¤æ‚çš„é¡µé¢ä¸‹ä¼šè®© <strong>template</strong> æ¸…æ™°ä¸å°‘ï¼Œæœ€èµ·ç ä¼šè®©ä½ å°‘æ•²ä»£ç ï¼Œè¿™é‡Œä»¥index é¡µé¢çš„éƒ¨åˆ†ä»£ç ä¸ºä¾‹ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;template lang=<span class="string">"pug"</span>&gt;</span><br><span class="line">div.content</span><br><span class="line">    div.bar</span><br><span class="line">        header(v-drag)</span><br><span class="line">            div.avatar(v-on:click=<span class="string">"profile(selfInfo)"</span>)</span><br><span class="line">                img(:src=<span class="string">"selfInfo.avatar? selfInfo.avatar: aPic.src"</span>) </span><br><span class="line">            div.name &#123;&#123; selfInfo.nick &#125;&#125;</span><br><span class="line">                p &#123;&#123; selfInfo.signature&#125;&#125;</span><br><span class="line">            i.icon-logout(v-on:click=<span class="string">"logout"</span>)</span><br><span class="line">        div.body</span><br><span class="line">            div.main-panel(v-<span class="keyword">if</span>=<span class="string">"!isSearch"</span>)        </span><br><span class="line">                nav</span><br><span class="line">                    div(v-on:click=<span class="string">"showTab(0)"</span> :<span class="class"><span class="keyword">class</span></span>=<span class="string">"&#123;active:tabIndex==0&#125;"</span>) å¥½å‹</span><br><span class="line">                    div(v-on:click=<span class="string">"showTab(1)"</span> :<span class="class"><span class="keyword">class</span></span>=<span class="string">"&#123;active:tabIndex==1&#125;"</span>) åˆ†ç»„</span><br><span class="line">                    div(v-on:click=<span class="string">"showTab(2)"</span> :<span class="class"><span class="keyword">class</span></span>=<span class="string">"&#123;active:tabIndex==2&#125;"</span>) æ¶ˆæ¯</span><br><span class="line">                        span(v-<span class="keyword">if</span>=<span class="string">"dealCount"</span>) &#123;&#123;dealCount&#125;&#125;    </span><br><span class="line">                ul.friends(v-<span class="keyword">if</span>=<span class="string">"tabIndex == 0"</span>)</span><br><span class="line">                    li(v-<span class="keyword">for</span>=<span class="string">"item in friends"</span> :key=<span class="string">"item.id"</span>)</span><br><span class="line">                        div.avatar(v-on:click=<span class="string">"profile(item)"</span>)</span><br><span class="line">                            img(:src=<span class="string">"item.avatar? item.avatar: aPic.src"</span>) </span><br><span class="line">                        p(v-on:click=<span class="string">"chatWin(item)"</span>) &#123;&#123;item.nick&#125;&#125;</span><br><span class="line">                        span(v-<span class="keyword">if</span>=<span class="string">"item.reads &amp;&amp; item.reads &gt; 0"</span>) (&#123;&#123;item.reads&#125;&#125;)</span><br><span class="line">		<span class="comment">//åŠ¨æ€åˆ›å»ºç»„ä»¶</span></span><br><span class="line">    component(:is=<span class="string">"item.component"</span>  v-<span class="keyword">for</span>=<span class="string">"(item,i) in wins"</span> :key=<span class="string">"item.id"</span> </span><br><span class="line">        :info=<span class="string">"item.info"</span></span><br><span class="line">        :sty=<span class="string">"item.sty"</span></span><br><span class="line">        :msgs=<span class="string">"item.msgs"</span></span><br><span class="line">        v-on:close=<span class="string">"closeWin(i)"</span></span><br><span class="line">        v-on:setZ=<span class="string">"setZ(i)"</span>)</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="åŠ¨æ€åˆ›å»ºç»„ä»¶"><a href="#åŠ¨æ€åˆ›å»ºç»„ä»¶" class="headerlink" title="åŠ¨æ€åˆ›å»ºç»„ä»¶"></a>åŠ¨æ€åˆ›å»ºç»„ä»¶</h4><p>ä¸Šé¢ç”¨åˆ°äº† vue çš„ åŠ¨æ€åˆ›å»ºç»„ä»¶ çš„æ¦‚å¿µï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿè¿™ä¸ªç»„ä»¶åœ¨å½“å‰é¡µé¢ä¸­æ˜¯ä¸å­˜åœ¨çš„ï¼Œéœ€è¦æˆ‘ä»¬è§¦å‘ä¹‹åï¼Œæ‰å¼€å§‹åˆ›å»ºã€‚æ¯”å¦‚ï¼Œå½“ä½ ç‚¹å‡»æŸä¸ªæŒ‰é’®ï¼Œæ‰å¼€å§‹åŠ è½½åˆ›å»ºç»„ä»¶ï¼Œç„¶åå¡«å……åˆ°é¡µé¢ä¸­æ¥ã€‚ä¸‹é¢å°±æ˜¯åŠ¨æ€ç»„ä»¶ç›¸å…³åŠŸèƒ½çš„ç¼–å†™ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">       wins: [] <span class="comment">//ç»„ä»¶åˆ—è¡¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;  </span><br><span class="line">  addWin(info, com) &#123; <span class="comment">// æ·»åŠ ç»„ä»¶çš„æ–¹æ³•</span></span><br><span class="line">      <span class="keyword">this</span>.wins.push(&#123;</span><br><span class="line">          msgs: info.msgs || [],</span><br><span class="line">          info,</span><br><span class="line">          sty: &#123;</span><br><span class="line">              left: l * <span class="number">30</span> + <span class="number">270</span>,</span><br><span class="line">              top: l * <span class="number">30</span> + <span class="number">30</span>,</span><br><span class="line">              z: <span class="number">0</span></span><br><span class="line">          &#125;,</span><br><span class="line">          component: com</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//å¡«å……ç»„ä»¶</span></span><br><span class="line">component(:is=<span class="string">"item.component"</span>  v-<span class="keyword">for</span>=<span class="string">"(item,i) in wins"</span> :key=<span class="string">"item.id"</span> </span><br><span class="line">  :info=<span class="string">"item.info"</span></span><br><span class="line">  :sty=<span class="string">"item.sty"</span></span><br><span class="line">  :msgs=<span class="string">"item.msgs"</span></span><br><span class="line">  v-on:close=<span class="string">"closeWin(i)"</span></span><br><span class="line">  v-on:setZ=<span class="string">"setZ(i)"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="javascriptéƒ¨åˆ†"><a href="#javascriptéƒ¨åˆ†" class="headerlink" title="javascriptéƒ¨åˆ†"></a>javascriptéƒ¨åˆ†</h4><p>è¿™é‡Œå°±æ˜¯ä¸šåŠ¡é€»è¾‘çš„éƒ¨åˆ†äº†ï¼Œä»¥éƒ¨åˆ†ä»£ç ä¸ºä¾‹, å…·ä½“çš„éƒ¨åˆ†å‚è€ƒå®˜æ–¹çš„æ–‡æ¡£</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; mapState, mapGetters &#125; <span class="keyword">from</span> <span class="string">"vuex"</span>;</span><br><span class="line"><span class="keyword">import</span> ChatMsg <span class="keyword">from</span> <span class="string">"./ChatMsg.vue"</span>;</span><br><span class="line"><span class="keyword">import</span> Profile <span class="keyword">from</span> <span class="string">"./Profile.vue"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">get</span>, post &#125; from "../common/request";</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">    name: <span class="string">"index"</span>,</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            tabIndex: <span class="number">0</span>,</span><br><span class="line">            wins: [],</span><br><span class="line">            aPic: &#123;</span><br><span class="line">                src: <span class="built_in">require</span>(<span class="string">"../assets/avatar.jpg"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  	<span class="keyword">async</span> created() &#123;</span><br><span class="line">    	<span class="comment">//...</span></span><br><span class="line">  	&#125;,</span><br><span class="line">    computed: &#123;</span><br><span class="line">        ...mapState([<span class="string">"selfInfo"</span>]),</span><br><span class="line">        ...mapGetters([</span><br><span class="line">            <span class="string">"isLogin"</span>,</span><br><span class="line">            <span class="string">"friends"</span>,</span><br><span class="line">            <span class="string">"msgs"</span></span><br><span class="line">        ])</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line">        isLogin: &#123;</span><br><span class="line">            <span class="comment">//ç›‘å¬ç™»å½•çŠ¶æ€</span></span><br><span class="line">            handler: <span class="function"><span class="keyword">function</span>(<span class="params">val, old</span>) </span>&#123;</span><br><span class="line">							<span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ,immediate: true //è¿›å…¥ç»„ä»¶ç«‹å³æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">  		addWin(info, com) &#123;&#125;,</span><br><span class="line">      sendMsg(user,data)&#123;&#125;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line"> 	  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="styleéƒ¨åˆ†"><a href="#styleéƒ¨åˆ†" class="headerlink" title="styleéƒ¨åˆ†"></a>styleéƒ¨åˆ†</h4><p>ä½¿ç”¨äº† <strong>vue</strong> é»˜è®¤çš„ <strong>scoped</strong> ï¼Œå½“ç„¶æœ€å®Œå–„çš„æ–¹æ¡ˆæ˜¯ <strong>css-module</strong>ï¼Œé…ç½®è¦å¤æ‚ä¸€äº›ï¼Œå½“ç„¶è¿™è¦çœ‹ä½ é¡¹ç›®éœ€æ±‚ã€‚é¢„ç¼–è¯‘å™¨ä½¿ç”¨çš„æ˜¯ <strong>scss</strong>ï¼Œä¸ªäººè®¤ä¸ºæ¯”è¾ƒå¼ºå¤§å’Œæ–¹ä¾¿ã€‚</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">&lt;style lang="scss" scoped&gt;</span><br><span class="line"><span class="variable">$blue</span>: hsl(<span class="number">200</span>, <span class="number">100%</span>, <span class="number">45%</span>);</span><br><span class="line">@<span class="keyword">mixin</span> nowrap &#123;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.content</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">1000px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.main-panel</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.search-panel</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">min-height</span>: <span class="number">313px</span>;</span><br><span class="line">    <span class="attribute">max-height</span>: <span class="number">513px</span>;</span><br><span class="line">    <span class="selector-tag">li</span> &#123;</span><br><span class="line">        <span class="attribute">line-height</span>: <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.bar</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">250px</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#fff</span>;</span><br><span class="line">    user-<span class="selector-tag">select</span>: none;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">6px</span> <span class="number">20px</span> <span class="number">0</span> hsla(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">0%</span>, <span class="number">0.19</span>),</span><br><span class="line">        <span class="number">0</span> <span class="number">8px</span> <span class="number">17px</span> <span class="number">0</span> hsla(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">0%</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="selector-tag">header</span> &#123;</span><br><span class="line">        <span class="attribute">display</span>: flex;</span><br><span class="line">        <span class="attribute">align-items</span>: flex-start;</span><br><span class="line">        <span class="attribute">align-items</span>: center;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="variable">$blue</span>;</span><br><span class="line">        <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">        <span class="selector-class">.avatar</span> &#123;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">            <span class="attribute">margin</span>: <span class="number">10px</span>;</span><br><span class="line">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="variable">$blue</span>;</span><br><span class="line">            <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">            <span class="attribute">overflow</span>: hidden;</span><br><span class="line">            <span class="attribute">cursor</span>: pointer;</span><br><span class="line">            &amp;:hover &#123;</span><br><span class="line">                <span class="attribute">border-color</span>: <span class="number">#fff</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="selector-tag">img</span> &#123;</span><br><span class="line">                <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">                <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="selector-tag">style</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="vuexçš„ä½¿ç”¨"><a href="#vuexçš„ä½¿ç”¨" class="headerlink" title="vuexçš„ä½¿ç”¨"></a>vuexçš„ä½¿ç”¨</h2><p><strong>vuex</strong> ç›¸æ¯” <strong>react</strong> ä¸­çš„ <strong>redux</strong>ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ›´åŠ ç®€å•å’Œæ–¹ä¾¿ï¼Œå°½ç®¡ç›¸æ¯” <strong>redux</strong> å¯èƒ½æ²¡æœ‰é‚£ä¹ˆ â€œçº¯â€ï¼Œä½†å¥½ç”¨å°±è¡Œã€‚ <strong>vuex</strong> ç›´æ¥æŠŠå¼‚æ­¥çš„ action å°è£…è¿›é‡Œé¢ï¼Œä½¿ç”¨moduleå°†ä¸åŒç»„ä»¶çš„çŠ¶æ€åŒºåˆ†å¼€æ¥ã€‚å¯ä»¥è¯´ <strong>vuex</strong> çš„ store é›†ä¸­äº† é¡¹ç›®å¤§éƒ¨åˆ†ä¸ çŠ¶æ€ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™ä¹Ÿæ˜¯ <strong>vue</strong> é¡¹ç›®çš„ä¸€å¤§å…³é”®ç‚¹ã€‚</p>
<h4 id="store"><a href="#store" class="headerlink" title="store"></a>store</h4><p> <strong>vuex</strong> çš„ store å’Œ <strong>redux</strong> çš„ store ä¸€æ ·ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"><span class="keyword">import</span> &#123; state, mutations &#125; <span class="keyword">from</span> <span class="string">'./mutations'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> getters <span class="keyword">from</span> <span class="string">'./getters'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> actions <span class="keyword">from</span> <span class="string">'./actions'</span></span><br><span class="line"><span class="keyword">import</span> friend <span class="keyword">from</span> <span class="string">'./modules/friend'</span></span><br><span class="line"><span class="keyword">import</span> msg <span class="keyword">from</span> <span class="string">'./modules/msg'</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">	actions,</span><br><span class="line">	getters,</span><br><span class="line">	state,</span><br><span class="line">	mutations,</span><br><span class="line">	modules: &#123;</span><br><span class="line">		friend,</span><br><span class="line">		msg</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="å…¨å±€-state-å’Œ-mutations"><a href="#å…¨å±€-state-å’Œ-mutations" class="headerlink" title="å…¨å±€ state å’Œ mutations"></a>å…¨å±€ state å’Œ mutations</h4><p><strong>vuex</strong> ä¸­çš„ <strong>state</strong> å¯¹åº” <strong>redux</strong> çš„ <strong>state</strong>ï¼Œ<strong>mutations</strong> åˆ™ç±»ä¼¼ <strong>redux</strong> ä¸­çš„ <strong>action</strong>ï¼Œå…¶ä¸­mutationsæ˜¯åŒæ­¥çš„ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> state = &#123;</span><br><span class="line">    loginInfo: &#123; token &#125;,</span><br><span class="line">    selfInfo: selfInfo,</span><br><span class="line">    dialog: &#123; <span class="attr">txt</span>: <span class="string">'content'</span>, <span class="attr">cancal</span>: <span class="literal">false</span>, <span class="attr">callback</span>: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;, <span class="attr">show</span>: <span class="literal">false</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mutations = &#123;</span><br><span class="line">    showDialog(state, payload) &#123;</span><br><span class="line">        state.modal.visible = <span class="literal">true</span>;</span><br><span class="line">        state.dialog = <span class="built_in">Object</span>.assign(&#123;&#125;, state.dialog, payload);</span><br><span class="line">        state.dialog.show = <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    closeDialog(state) &#123;</span><br><span class="line">        state.modal.visible = <span class="literal">false</span>;</span><br><span class="line">        state.dialog.show = <span class="literal">false</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    setLoginInfo(state) &#123;</span><br><span class="line">        state.loginInfo = &#123; <span class="attr">token</span>: localStorage.getItem(<span class="string">"token"</span>) &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    setSelfInfo(state, payload) &#123;</span><br><span class="line">        state.selfInfo = payload;</span><br><span class="line">        localStorage.setItem(<span class="string">"selfInfo"</span>, <span class="built_in">JSON</span>.stringify(payload));</span><br><span class="line">    &#125;,</span><br><span class="line">    logout() &#123;</span><br><span class="line">        state.loginInfo = &#123;&#125;;</span><br><span class="line">        state.selfInfo = &#123;&#125;;</span><br><span class="line">        localStorage.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å…¨å±€-action-å’Œ-getters"><a href="#å…¨å±€-action-å’Œ-getters" class="headerlink" title="å…¨å±€ action å’Œ getters"></a>å…¨å±€ action å’Œ getters</h4><p><strong>vuex</strong> çš„ <strong>aciton</strong> å°±æ˜¯å°†å¼‚æ­¥çš„åŠ¨ä½œå°è£…èµ·æ¥ã€‚è€Œ<strong>redux</strong> å¾—é€šè¿‡ <strong>redux-saga</strong> ä¹‹ç±»çš„ä¸­é—´ä»¶æ‰èƒ½å®ç°ç±»ä¼¼çš„æ•ˆæœã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">get</span>, post &#125; from "../common/request";</span><br><span class="line"></span><br><span class="line">export const getInfo = (&#123; commit &#125;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">get</span>("/getinfo").then(res =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.code == <span class="number">0</span>) &#123;</span><br><span class="line">            commit(<span class="string">"setSelfInfo"</span>, res.data.user);</span><br><span class="line">            commit(<span class="string">"setFriends"</span>, res.data.friends);</span><br><span class="line">            commit(<span class="string">"setGroup"</span>, res.data.groups);</span><br><span class="line">            commit(<span class="string">"setMsgs"</span>, res.data.msgs);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.code == <span class="number">1</span>) &#123;</span><br><span class="line">            commit(<span class="string">"logout"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:res.message&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">        commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:err.message&#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> updateSelf=<span class="function">(<span class="params">&#123;commit&#125;,form</span>)=&gt;</span>&#123;</span><br><span class="line">    post(<span class="string">"/updateinfo"</span>, form).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.code == <span class="number">0</span>) &#123;</span><br><span class="line">            commit(<span class="string">"updateSelfInfo"</span>, form);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.code == <span class="number">1</span>) &#123;</span><br><span class="line">            commit(<span class="string">"logout"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:res.message&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">        commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:err.message&#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getterså¯ä»¥çœ‹æˆæ˜¯å¯¹state ä¸­æŸäº›å­—æ®µçš„å°è£…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> visible = <span class="function"><span class="params">state</span> =&gt;</span> state.modal.visible</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isLogin = <span class="function"><span class="params">state</span> =&gt;</span> !!state.loginInfo.token</span><br></pre></td></tr></table></figure>
<h4 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h4><p>éšç€é¡¹ç›®è§„æ¨¡çš„æ‰©å±•ï¼Œæ‹†åˆ†å’Œæ¨¡å—åŒ–éƒ½æ˜¯ä¸€ä¸ªå¿…ç„¶ã€‚é’ˆå¯¹æŸä¸ªå­æ¨¡å—è€Œè®¾ç½®çš„storeï¼Œå®ƒçš„ç»“æ„å’Œæ ¹storeä¸€æ ·ï¼Œmodule çš„ store æœ€ç»ˆä¼šåˆå¹¶åˆ°æ ¹ storeé‡Œé¢ã€‚msgä¸ºä¾‹çš„ç¼–å†™æ–¹å¼å¦‚ä¸‹:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">get</span>, post &#125; from "../../common/request";</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">    state: &#123;</span><br><span class="line">        msgs: []</span><br><span class="line">    &#125;,</span><br><span class="line">    getters: &#123;</span><br><span class="line">        msgs: <span class="function"><span class="params">state</span> =&gt;</span> state.msgs,</span><br><span class="line">        dealCount: <span class="function"><span class="params">state</span> =&gt;</span> state.msgs.filter(<span class="function"><span class="params">i</span> =&gt;</span> i.status == <span class="number">0</span>).length</span><br><span class="line">    &#125;,</span><br><span class="line">    actions: &#123;</span><br><span class="line">        accept(&#123; commit &#125;, form) &#123;</span><br><span class="line">            <span class="keyword">return</span> post(<span class="string">"/accept"</span>, &#123; <span class="attr">id</span>: form.id, <span class="attr">friend_id</span>: form.from_id &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (res.code == <span class="number">0</span>) &#123;</span><br><span class="line">                    commit(<span class="string">"setMsgState"</span>, &#123; <span class="attr">id</span>: form.id, <span class="attr">status</span>: <span class="number">1</span> &#125;);</span><br><span class="line">                    commit(<span class="string">"addFriend"</span>, <span class="built_in">Object</span>.assign(&#123;&#125;, form, &#123; <span class="attr">id</span>: form.from_id &#125;));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:res.message&#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">                commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:err.message&#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        reject(&#123; commit &#125;, form) &#123;</span><br><span class="line">            post(<span class="string">"/reject"</span>, &#123; <span class="attr">id</span>: form.id &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (res.code == <span class="number">0</span>) &#123;</span><br><span class="line">                    form.status = <span class="number">2</span>;</span><br><span class="line">                    commit(<span class="string">"setMsgState"</span>, form);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:res.message&#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">                commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:err.message&#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    mutations: &#123;</span><br><span class="line">        setMsgs(state, payload) &#123;</span><br><span class="line">            state.msgs = payload;</span><br><span class="line">        &#125;,</span><br><span class="line">        setMsgState(state, payload) &#123;</span><br><span class="line">            state.msgs.forEach(<span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (i.id == payload.id) &#123;</span><br><span class="line">                    i.status = payload.status;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        addMsg(state, payload) &#123;</span><br><span class="line">            state.msgs.unshift(payload);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="socket-ioçš„æ¥å…¥"><a href="#socket-ioçš„æ¥å…¥" class="headerlink" title="socket.ioçš„æ¥å…¥"></a>socket.ioçš„æ¥å…¥</h2><p>æ¥ç€å°†websocketä½¿ç”¨èµ·æ¥ï¼Œè®©æˆ‘ä»¬å®ç° å¥½å‹èŠå¤©å’Œåˆ†ç»„èŠå¤©çš„åŠŸèƒ½ï¼Œsocket.io çš„ä»‹ç»å¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„æ–‡ç«  <em><a href="/2019/03/29/socketio/">å…³äºsocket.ioçš„ä½¿ç”¨</a></em>ã€‚</p>
<h4 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h4><p>é¦–å…ˆè¿æ¥æœåŠ¡ç«¯çš„ socketï¼Œç„¶åå°†è‡ªèº«çš„ç”¨æˆ·ä¿¡æ¯æ³¨å†Œåˆ° socket.io æœåŠ¡ï¼Œè¿™æ ·æœåŠ¡ç«¯æ‰çŸ¥é“ä½ æ˜¯è°ï¼Œä¹Ÿæ‰èƒ½ä¸å…¶ä»–äººå®è¡Œé€šä¿¡ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> created() &#123;<span class="comment">// vue ç»„ä»¶åˆ›å»ºæ—¶å»ºç«‹socketè¿æ¥</span></span><br><span class="line">  <span class="keyword">const</span> token = localStorage.getItem(<span class="string">"token"</span>) || <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.$router.push(<span class="string">"/sign/log"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">this</span>.$store.dispatch(<span class="string">"getInfo"</span>);</span><br><span class="line">  <span class="keyword">this</span>.socket = io(<span class="string">"http://localhost:3001?token="</span> + token);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æ³¨å†Œç”¨æˆ·ä¿¡æ¯åæ‰å¼€å§‹ä¸æœåŠ¡ç«¯é€šä¿¡</span></span><br><span class="line">  <span class="keyword">this</span>.socket.emit(<span class="string">"sign"</span>, &#123; <span class="attr">user</span>: <span class="keyword">this</span>.selfInfo, rooms &#125;, res =&gt; &#123;</span><br><span class="line">    <span class="comment">// console.log(res);</span></span><br><span class="line">    <span class="keyword">this</span>.$store.commit(<span class="string">"friendStatus"</span>, res.data);</span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"userin"</span>, (map, user) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">"friendStatus"</span>, map);</span><br><span class="line">      showTip(user, <span class="string">"ä¸Šçº¿äº†"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"userout"</span>, (map, user) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">"friendStatus"</span>, map);</span><br><span class="line">      showTip(user, <span class="string">"ä¸‹çº¿äº†"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"auth"</span>, data =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">'showDialog'</span>,&#123;<span class="attr">txt</span>:data.message&#125;)</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">"logout"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¥æ”¶ç”³è¯·å¥½å‹å’Œç»„ç¾¤</span></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"apply"</span>, data =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">"addMsg"</span>, data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¥æ”¶èŠå¤©ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"reply"</span>, (user, data) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.sendMsg(user, data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¥æ”¶ç¾¤ç»„èŠå¤©ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">"groupReply"</span>, (info, data) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.sendGroupMsg(info, data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br><span class="line">beforeDestroy() &#123; <span class="comment">//ç»„ä»¶é”€æ¯ä¹‹å‰ï¼Œå°†socket å…³é—­</span></span><br><span class="line">	<span class="keyword">this</span>.socket.close();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h4 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h4><p>socket.io å¯¹åº”çš„æœåŠ¡ç«¯éƒ¨åˆ†ï¼Œé€»è¾‘ä¸»è¦åŒ…æ‹¬ç”¨æˆ·æ³¨å†Œï¼Œä¸¤äººèŠå¤©ï¼Œç¾¤èŠå¤©ï¼Œå½“ç„¶å¯¹åº”çš„ä¿¡æ¯éœ€è¦ä¿å­˜åˆ°æ•°æ®åº“ã€‚ è¿™é‡Œçš„æŠ€å·§å°±æ˜¯ä½¿ç”¨å˜é‡è®°å½•å½“å‰æ‰€æœ‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> auth = <span class="built_in">require</span>(<span class="string">'./auth.js'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; insertMsg, insertToUser &#125; = <span class="built_in">require</span>(<span class="string">'../daos/message'</span>);</span><br><span class="line"><span class="keyword">const</span> log = <span class="built_in">require</span>(<span class="string">'../common/logger'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> MAP = &#123;&#125;;<span class="comment">//ç”¨æˆ·idå’Œsocket id</span></span><br><span class="line"><span class="keyword">let</span> LIST = []; <span class="comment">//ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">let</span> ROOMS = []; <span class="comment">//æˆ¿é—´</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> currTime = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(), date = <span class="string">`<span class="subst">$&#123;d.getFullYear()&#125;</span>-<span class="subst">$&#123;d.getMonth()&#125;</span>-<span class="subst">$&#123;d.getDate()&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="string">'0'</span> + d.getHours()).slice(<span class="number">-2</span>) + <span class="string">':'</span> + (<span class="string">'0'</span> + d.getMinutes()).slice(<span class="number">-2</span>) + <span class="string">':'</span> + (<span class="string">'0'</span> + d.getSeconds()).slice(<span class="number">-2</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">io</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// middleware</span></span><br><span class="line">    io.use(auth);</span><br><span class="line">    <span class="comment">//namespace (/)</span></span><br><span class="line">    io.on(<span class="string">'connection'</span>, socket =&gt; &#123;</span><br><span class="line">        socket.emit(<span class="string">'open'</span>, &#123;</span><br><span class="line">            code: <span class="number">0</span>,</span><br><span class="line">            handshake: socket.handshake,</span><br><span class="line">            namespace: <span class="string">'/'</span>,</span><br><span class="line">            message: <span class="string">'welcome to main channel, please sign'</span></span><br><span class="line">        &#125;);</span><br><span class="line">				</span><br><span class="line">      	<span class="comment">//ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line">        socket.on(<span class="string">'sign'</span>, (&#123; user, rooms &#125;, fn) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!user.id) &#123;</span><br><span class="line">                <span class="keyword">return</span> fn(&#123; <span class="attr">code</span>: <span class="number">2</span>, <span class="attr">message</span>: <span class="string">'id not exist'</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            MAP[user.id] = socket.id;</span><br><span class="line">            user.socketId = socket.id;</span><br><span class="line">            LIST.push(user);</span><br><span class="line"></span><br><span class="line">            socket.join(rooms);<span class="comment">//åŠ å…¥è‡ªå·±æ‰€åœ¨çš„ç»„</span></span><br><span class="line">            socket.emit(<span class="string">'userin'</span>, MAP, user);</span><br><span class="line">            socket.broadcast.emit(<span class="string">'userin'</span>, MAP, user);</span><br><span class="line"></span><br><span class="line">            fn(&#123;</span><br><span class="line">                code: <span class="number">0</span>,</span><br><span class="line">                message: <span class="string">'sign success'</span>,</span><br><span class="line">                data: MAP</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä¸¤äººèŠå¤©</span></span><br><span class="line">        socket.on(<span class="string">'send'</span>, <span class="keyword">async</span> (uid, msg) =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> sid = MAP[uid];<span class="comment">//æ¥æ”¶ç”¨æˆ·socket.id</span></span><br><span class="line">            <span class="keyword">const</span> cid = findUid(socket.id);<span class="comment">//å‘é€ç”¨æˆ·id</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sid) &#123; <span class="comment">// å¥½å‹åœ¨çº¿åˆ™å‘é€</span></span><br><span class="line">                socket.to(sid).emit(<span class="string">'reply'</span>, &#123; <span class="attr">id</span>: cid, <span class="attr">self</span>: <span class="literal">false</span> &#125;, &#123; <span class="attr">date</span>: currTime(), msg &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ç»™è‡ªå·±ä¹Ÿå‘ä¸€ä»½</span></span><br><span class="line">            socket.emit(<span class="string">'reply'</span>, &#123; <span class="attr">id</span>: uid, <span class="attr">self</span>: <span class="literal">true</span> &#125;, &#123; <span class="attr">date</span>: currTime(), msg &#125;);</span><br><span class="line">            <span class="comment">// ä¿å­˜æ•°æ®åº“</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> ret = <span class="keyword">await</span> insertMsg(&#123; <span class="attr">send_id</span>: cid, <span class="attr">receive_id</span>: uid, <span class="attr">content</span>: msg &#125;);</span><br><span class="line">                insertToUser(&#123; <span class="attr">user_id</span>: uid, <span class="attr">send_id</span>: cid, <span class="attr">message_id</span>: ret.insertId, <span class="attr">is_read</span>: sid ? <span class="number">1</span> : <span class="number">0</span> &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                log.error(err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç¾¤ç»„èŠå¤©</span></span><br><span class="line">        socket.on(<span class="string">'groupSend'</span>, <span class="keyword">async</span> (&#123;gid,user&#125;, msg) =&gt; &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        socket.on(<span class="string">'acceptFriend'</span>, (uid) =&gt; &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        socket.on(<span class="string">'sendApply'</span>, (uid, data) =&gt; &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        socket.on(<span class="string">'disconnect'</span>, () =&gt; &#123;</span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="å®¢æˆ·ç«¯çš„å¯åŠ¨"><a href="#å®¢æˆ·ç«¯çš„å¯åŠ¨" class="headerlink" title="å®¢æˆ·ç«¯çš„å¯åŠ¨"></a>å®¢æˆ·ç«¯çš„å¯åŠ¨</h2><p>é¦–å…ˆå¾—ç¼–å†™client.jsï¼Œå°†å‰ç«¯æœåŠ¡å¯åŠ¨èµ·æ¥ï¼Œä¾ç„¶è¿˜æ˜¯ä½¿ç”¨æˆ‘ä»¬é«˜æ•ˆçš„koaæ¡†æ¶ã€‚æˆ‘è¿™é‡Œå›¾çœäº‹ï¼Œå’Œä¹‹å‰çš„æœåŠ¡ç«¯æ‰€åœ¨åŒä¸€ä¸ªæ ¹ç›®å½•ä¸‹ï¼ŒçœŸæ­£é¡¹ç›®ä¼šå°†æœåŠ¡ç«¯éƒ¨åˆ†å’Œå®¢æˆ·ç«¯éƒ¨åˆ† åˆ†ç¦»åˆ°ä¸åŒç›®å½•æˆ–ä¸åŒçš„æœåŠ¡å™¨çš„ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> koa()</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">'koa-static'</span>)</span><br><span class="line"><span class="keyword">const</span> compress = <span class="built_in">require</span>(<span class="string">'koa-compress'</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line"><span class="keyword">const</span> &#123; clientPort &#125; = <span class="built_in">require</span>(<span class="string">'./server/config/app'</span>)</span><br><span class="line"><span class="keyword">const</span> tpl = <span class="built_in">require</span>(<span class="string">'./server/middleware/tpl'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// gzip</span></span><br><span class="line">app.use(compress(&#123;</span><br><span class="line">    filter: <span class="function"><span class="keyword">function</span> (<span class="params">content_type</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="regexp">/text|javascript/i</span>.test(content_type)</span><br><span class="line">    &#125;,</span><br><span class="line">    threshold: <span class="number">2048</span>,</span><br><span class="line">    flush: <span class="built_in">require</span>(<span class="string">'zlib'</span>).Z_SYNC_FLUSH</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// set static directiory</span></span><br><span class="line">app.use(<span class="keyword">static</span>(path.join(__dirname, <span class="string">'dist'</span>), &#123; <span class="attr">index</span>: <span class="literal">false</span> &#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// simple template engine</span></span><br><span class="line">app.use(tpl(&#123;</span><br><span class="line">    path: path.join(__dirname, <span class="string">'dist'</span>)</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// add routers</span></span><br><span class="line">router</span><br><span class="line">    .get(<span class="string">'/'</span>, ctx =&gt; &#123;</span><br><span class="line">        ctx.render(<span class="string">'index.html'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .get(<span class="string">'/sign/*'</span>, ctx =&gt; &#123;</span><br><span class="line">        ctx.redirect(<span class="string">'/'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br><span class="line">    .use(router.allowedMethods());</span><br><span class="line"></span><br><span class="line"><span class="comment">// deal 404</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.status = <span class="number">404</span>;</span><br><span class="line">    ctx.body = &#123; <span class="attr">code</span>: <span class="number">404</span>, <span class="attr">message</span>: <span class="string">'404! not found !'</span> &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// koa already had event to deal with the error, just rigister it</span></span><br><span class="line">app.on(<span class="string">'error'</span>, (err, ctx) =&gt; &#123;</span><br><span class="line">    ctx.status = <span class="number">500</span>;</span><br><span class="line">    ctx.statusText = <span class="string">'Internal Server Error'</span>;</span><br><span class="line">    <span class="keyword">if</span> (ctx.app.env === <span class="string">'development'</span>) &#123; <span class="comment">//throw the error to frontEnd when in the develop mode</span></span><br><span class="line">        ctx.res.end(err.stack); <span class="comment">//finish the response</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.body = &#123; <span class="attr">code</span>: <span class="number">-1</span>, <span class="attr">message</span>: <span class="string">'Server Error'</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">module</span>.parent) &#123;</span><br><span class="line">    app.listen(clientPort);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'app server running at: http://localhost:%d'</span>, clientPort);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬æ•´ä¸ªdemoå°±èƒ½è¿è¡Œï¼Œä¸»è¦å®ç°å¦‚ä¸‹åŠŸèƒ½ç‚¹ï¼š</p>
<ol>
<li>ä¸»é¡µé¢çš„æ‰€æœ‰çš„çª—å£éƒ½å¯ä»¥æ‹–åŠ¨ï¼Œå…³é—­</li>
<li>å¯ä»¥ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯ï¼Œç¾¤ç»„ä¿¡æ¯ï¼Œæ¯ä¸ªç”¨æˆ·å¯ä»¥æ–°å»º3ä¸ªç¾¤ç»„</li>
<li>å¯ä»¥å¥½å‹èŠå¤©ï¼Œç¾¤ç»„èŠå¤©</li>
<li>æœç´¢ç”¨æˆ·å’Œç¾¤ç»„</li>
<li>å¥½å‹ç”³è¯·å’Œç¾¤ç»„ç”³è¯·</li>
<li>åœ¨çº¿æ—¶ï¼Œå¯ä»¥è·å¾—å¥½å‹ä¸Šçº¿ä¸‹çº¿æé†’ï¼Œå®æ—¶ç­”å¤ç”¨æˆ·ç”³è¯·</li>
<li>ç¦»çº¿æ—¶ï¼Œä»ç„¶å¯ä»¥ç»™ç”¨æˆ·å’Œç¾¤ç»„ç•™è¨€ï¼Œä¸‹æ¬¡ç™»å½•è·å¾—æé†’</li>
</ol>
<p><img src="https://upload-images.jianshu.io/upload_images/127924-0cb17ea3a9c6d4df.png" alt="web QQ"></p>
<h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>æ¥ä¸‹æ¥å¯ä»¥ä¼˜åŒ–å’Œå¢å¼ºçš„åœ°æ–¹ï¼Œæˆ‘æƒ³åˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨ <strong>nuxt</strong> å°† vue è¿›è¡ŒæœåŠ¡ç«¯æ¸²æŸ“ ï¼Œè¿›ä¸€æ­¥æé«˜æ€§èƒ½</li>
<li>node éƒ¨åˆ†ï¼Œä½¿ç”¨ pm2 è¿›è¡Œéƒ¨ç½²ã€‚</li>
</ol>
<p>æºä»£ç : <em><a href="https://github.com/edwardzhong/vue_qq" target="_blank" rel="noopener">vue_qq</a></em></p>
</div>
    	
		<div class="post-footer">
			<div class="share" data-url="/2019/04/13/fullstack3/" data-desc="React ä¸ Vue ä¹‹é—´çš„å¯¹æ¯”ï¼Œæ˜¯å‰ç«¯çš„ä¸€å¤§çƒ­é—¨è¯é¢˜ã€‚

vue ç®€æ˜“ä¸Šæ‰‹çš„è„šæ‰‹æ¶ï¼Œä»¥åŠå®˜..."><a href="javascript:;" data-type="share" class="icon icon-share"> åˆ†äº«</a></div>
			<div class="tags">
			<i class="icon icon-tag"></i> 
			
				
				
                    
                        <a href="/tags/å‰ç«¯/">å‰ç«¯</a>
                    
				
                    
                        <a href="/tags/vue/">vue</a>
                    
				
                    
                        <a href="/tags/socket-io/">socket.io</a>
                    
				
                    
                        <a href="/tags/vuex/">vuex</a>
                    
				
			
			</div>
		</div>
	</div>
</article>
</div>

<nav class="pagination clearfix">
  
    
      
      <a href="/2019/04/26/weappcloud/" class="prev post-prev">&larr; å°è¯•å°ç¨‹åºäº‘å¼€å‘</a>
      

      
      <a href="/2019/04/12/fullstack2/" class="next post-next">koa+mysql+vue+soc... &rarr;</a>
      
    
  
</nav>

<div class="wxshare-popup">
    <a class="close" href="javascript:;"><i class="icon icon-cancel"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div id="qrcode" class="wx-qrcode"></div>
</div>

    
    <footer class="footer">
<p class="theme">
	Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/edwardzhong/simply.git">simply</a>
</p>
<p class="copy">Copyright &copy; 2019 Jeff Zhong</p>
</footer>
    <div class="top-bottom">
      <div class="to-top hide" title="to top"><i class="icon icon-up-open"></i></div>
      <div class="to-bottom hide" title="to bottom"><i class="icon icon-down-open"></i></div>
    </div>
    </div>

  </div>
<input type="hidden" name="isPost" id="isPost" value="true">
<i id="barBtn" class="icon icon-menu"></i>
<div id="payMe" class="payme">
    <i class="icon icon-cancel"></i>
    <p class="pay-title">ç»™æˆ‘çš„æ—©é¤åŠ ä¸ªè›‹å§ <i class="icon icon-smile"></i></p>
    <div>
      <img src="/img/weixinpay.jpg" alt="weixinpay">
      <img src="/img/alipay.jpg" alt="alipay" style="display:none;">
    </div>
    <div class="pay-selects">
        <input type="radio" name="pay" id="weixinpay" checked="checked"><label for="weixinpay"> å¾®ä¿¡ </label>&nbsp;&nbsp;
        <input type="radio" name="pay" id="alipay"><label for="alipay"> æ”¯ä»˜å® </label>
    </div>
</div>

  
  
    <script src="/lib/jquery-2.2.3.min.js"></script>
  
    <script src="/lib/qrcode.min.js"></script>
  
    <script src="/dist/js/index.js"></script>
  

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


</body>
</html>
